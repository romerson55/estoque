<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ALX CABOS - Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');

        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            color: #f1f5f9;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .bottom-nav {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: var(--safe-bottom);
        }

        .nav-item.active {
            color: #10b981;
        }

        .nav-item.active svg {
            filter: drop-shadow(0 0 5px rgba(16, 185, 129, 0.5));
        }

        .card-stock {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8));
            border-left: 4px solid #334155;
            transition: transform 0.2s;
        }

        .card-stock:active {
            transform: scale(0.98);
        }

        .status-ok {
            border-color: #10b981;
        }

        .status-low {
            border-color: #f59e0b;
        }

        .status-zero {
            border-color: #ef4444;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-slide {
            animation: slideIn 0.3s ease-out forwards;
        }

        input,
        select,
        button {
            font-size: 16px !important;
            /* Prevents auto-zoom on iOS */
            min-height: 44px;
        }

        .tab-content {
            padding-bottom: 100px;
            padding-top: calc(var(--safe-top) + 20px);
        }

        .live-dot {
            width: 6px;
            height: 6px;
            background: #10b981;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        .fab {
            position: fixed;
            bottom: calc(85px + var(--safe-bottom));
            right: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 50%;
            display: flex;
            items-center: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            z-index: 40;
            border: none;
            color: white;
            font-size: 24px;
        }

        /* Hide sections by default */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }
    </style>
</head>

<body>

    <!-- TOP HEADER -->
    <header
        class="fixed top-0 left-0 w-full z-40 bg-slate-900/80 backdrop-blur-lg border-b border-slate-700/50 px-6 py-4 flex items-center justify-between"
        style="padding-top: calc(var(--safe-top) + 12px)">
        <div class="flex items-center gap-3">
            <div
                class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-blue-600 rounded-lg flex items-center justify-center font-black text-xl italic shadow-lg">
                A</div>
            <div>
                <h1 class="font-black text-emerald-400 text-sm tracking-wider leading-none">ALX CABOS</h1>
                <p class="text-[9px] text-slate-400 uppercase tracking-widest mt-1">Estoque Mobile</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right">
                <span id="lastSyncTime" class="text-[10px] text-slate-500 font-mono">--:--:--</span>
                <div class="flex items-center justify-end gap-1 mt-0.5">
                    <span id="syncStatusDot" class="w-1.5 h-1.5 bg-slate-500 rounded-full"></span>
                    <span id="syncStatusText" class="text-[8px] text-slate-500 font-bold uppercase">Offline</span>
                </div>
            </div>
            <button onclick="logout()"
                class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-rose-400 border border-rose-500/20">üö™</button>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="w-full min-h-screen px-4 tab-content">

        <!-- SECTION: DASHBOARD (HOME) -->
        <section id="section-home" class="page-section active animate-slide">
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="glass rounded-2xl p-4 border-l-4 border-emerald-500">
                    <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Flex√≠vel</p>
                    <p class="text-xl font-black text-emerald-400" id="catFioFlexivel">0</p>
                    <p class="text-[8px] text-slate-500">rolos</p>
                </div>
                <div class="glass rounded-2xl p-4 border-l-4 border-blue-500">
                    <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Cabo PP</p>
                    <p class="text-xl font-black text-blue-400" id="catCaboPP">0</p>
                    <p class="text-[8px] text-slate-500">rolos</p>
                </div>
                <div class="glass rounded-2xl p-4 border-l-4 border-purple-500">
                    <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Torcido</p>
                    <p class="text-xl font-black text-purple-400" id="catTorcido">0</p>
                    <p class="text-[8px] text-slate-500">rolos</p>
                </div>
                <div class="glass rounded-2xl p-4 border-l-4 border-amber-500">
                    <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Outros</p>
                    <p class="text-xl font-black text-amber-400" id="catOutros">0</p>
                    <p class="text-[8px] text-slate-500">rolos</p>
                </div>
            </div>

            <div class="glass rounded-2xl p-4 mb-6">
                <h2 class="text-sm font-bold mb-4 flex items-center gap-2">
                    <span>üìä</span> Resumo por Categoria
                </h2>
                <div class="flex justify-center">
                    <div style="width: 200px; height: 200px;">
                        <canvas id="chartCategorias"></canvas>
                    </div>
                </div>
            </div>

            <div class="glass rounded-2xl p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-bold flex items-center gap-2">
                        <span>üïí</span> √öltimas A√ß√µes
                    </h2>
                    <div class="flex items-center gap-1">
                        <span class="live-dot"></span>
                        <span class="text-[8px] text-emerald-400 font-bold uppercase">Live</span>
                    </div>
                </div>
                <div id="ultimasMovimentacoes" class="space-y-3">
                    <p class="text-center text-slate-500 text-xs py-4">Sincronizando...</p>
                </div>
            </div>
        </section>

        <!-- SECTION: ESTOQUE (LISTA) -->
        <section id="section-estoque" class="page-section animate-slide">
            <div class="mb-4 space-y-3">
                <input type="text" id="buscaEstoque" oninput="filtrarEstoque()" placeholder="Buscar produto..."
                    class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm focus:border-emerald-500 outline-none">

                <div class="flex gap-2">
                    <select id="filtroCategoria" onchange="filtrarEstoque()"
                        class="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-2 text-xs h-10">
                        <option value="">Categorias</option>
                    </select>
                    <select id="filtroCor" onchange="filtrarEstoque()"
                        class="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-2 text-xs h-10">
                        <option value="">Cores</option>
                    </select>
                </div>
            </div>

            <div id="listaEstoqueMobile" class="space-y-3">
                <!-- Cards preenchidos via JS -->
            </div>
        </section>

        <!-- SECTION: PEDIDOS (VENDAS) -->
        <section id="section-pedidos" class="page-section animate-slide">
            <div class="glass rounded-2xl p-5 mb-6">
                <h3 class="font-bold text-emerald-400 mb-4 flex items-center gap-2">
                    <span>üìÑ</span> Novo Pedido / Or√ßamento
                </h3>

                <div class="space-y-4">
                    <div>
                        <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1">Cliente</label>
                        <input type="text" id="clientePedido" list="listClientes"
                            onchange="verificarAutocompletarCliente()" placeholder="Nome do cliente"
                            class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 text-sm h-12">
                        <datalist id="listClientes"></datalist>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="abrirModalCatalogo()"
                            class="bg-slate-800 border border-slate-700 rounded-xl p-4 flex flex-col items-center justify-center gap-2">
                            <span class="text-xl">üõçÔ∏è</span>
                            <span class="text-[10px] font-bold">Cat√°logo</span>
                        </button>
                        <button onclick="finalizarPedido()"
                            class="bg-emerald-600 rounded-xl p-4 flex flex-col items-center justify-center gap-2 shadow-lg shadow-emerald-900/30">
                            <span class="text-xl">‚úÖ</span>
                            <span class="text-[10px] font-bold">Gerar PDF</span>
                        </button>
                    </div>

                    <div id="resumoCarrinhoMobile" class="bg-slate-900/50 rounded-xl p-4 border border-slate-700/50">
                        <p class="text-center text-slate-500 text-xs italic">Carrinho vazio</p>
                    </div>
                </div>
            </div>

            <div class="glass rounded-2xl p-5">
                <h3 class="font-bold text-blue-400 mb-4">Meus Pedidos Recentes</h3>
                <div id="listaPedidosMobile" class="space-y-3 text-xs">
                    <!-- Cards de pedidos -->
                </div>
            </div>
        </section>

        <!-- SECTION: OPERA√á√ïES (ENTRADA/SA√çDA) -->
        <section id="section-operacoes" class="page-section animate-slide">
            <div class="space-y-4">
                <!-- ENTRADA -->
                <div class="glass rounded-2xl p-5 border-l-4 border-emerald-500">
                    <h3 class="font-bold text-emerald-400 mb-4">üì• Registrar Entrada</h3>
                    <div class="space-y-3">
                        <select id="entradaProduto"
                            class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 text-sm h-12"></select>
                        <input type="number" id="entradaQtd" placeholder="Quantidade"
                            class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 text-sm h-12">
                        <input type="text" id="entradaObs" placeholder="Observa√ß√£o (Ex: NF 123)"
                            class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 text-sm h-12">
                        <button onclick="registrarMovimentacao('entrada')"
                            class="w-full bg-emerald-600 py-3 rounded-xl font-bold text-sm">Cofirmar Entrada</button>
                    </div>
                </div>

                <!-- SA√çDA -->
                <div class="glass rounded-2xl p-5 border-l-4 border-rose-500">
                    <h3 class="font-bold text-rose-400 mb-4">üì§ Sa√≠da Manual</h3>
                    <div class="space-y-3">
                        <select id="saidaProduto"
                            class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 text-sm h-12"></select>
                        <input type="number" id="saidaQtd" placeholder="Quantidade"
                            class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 text-sm h-12">
                        <input type="text" id="saidaObs" placeholder="Motivo da baixa"
                            class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 text-sm h-12">
                        <button onclick="registrarMovimentacao('saida')"
                            class="w-full bg-rose-600 py-3 rounded-xl font-bold text-sm">Confirmar Sa√≠da</button>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- FLOATING ACTION BUTTON -->
    <button onclick="abrirModalNovoPreco()" class="fab" id="fabAction">
        <span>üõí</span>
    </button>

    <!-- BOTTOM NAVIGATION -->
    <nav class="fixed bottom-0 left-0 w-full z-50 bottom-nav flex justify-around items-center pt-2">
        <button onclick="switchSection('home')" id="nav-home"
            class="nav-item active flex flex-col items-center py-2 flex-1">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
            <span class="text-[10px] font-bold mt-1">In√≠cio</span>
        </button>
        <button onclick="switchSection('estoque')" id="nav-estoque"
            class="nav-item flex flex-col items-center py-2 flex-1">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
            <span class="text-[10px] font-bold mt-1">Estoque</span>
        </button>
        <button onclick="switchSection('pedidos')" id="nav-pedidos"
            class="nav-item flex flex-col items-center py-2 flex-1">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
            </svg>
            <span class="text-[10px] font-bold mt-1">Vendas</span>
        </button>
        <button onclick="switchSection('operacoes')" id="nav-operacoes"
            class="nav-item flex flex-col items-center py-2 flex-1">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m12 0a2 2 0 100-4m0 4a2 2 0 110-4m-6 0a2 2 0 100 4m0-4a2 2 0 110 4m-6 0h12" />
            </svg>
            <span class="text-[10px] font-bold mt-1">Geral</span>
        </button>
    </nav>

    <!-- OVERLAYS & MODALS -->

    <!-- LOGIN OVERLAY -->
    <div id="loginOverlay" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-6">
        <div class="glass w-full max-w-sm p-8 rounded-3xl border border-slate-700 shadow-2xl">
            <div class="text-center mb-8">
                <div
                    class="w-16 h-16 bg-gradient-to-br from-emerald-500 to-blue-600 rounded-2xl mx-auto flex items-center justify-center font-black text-3xl italic shadow-lg mb-4">
                    A</div>
                <h2 class="text-2xl font-black text-white">ALX CABOS</h2>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold mt-1">Acesso Restrito</p>
            </div>

            <form onsubmit="event.preventDefault(); fazerLogin();" class="space-y-4">
                <input type="text" id="loginUser"
                    class="w-full bg-slate-800 border border-slate-700 rounded-2xl p-4 text-white outline-none focus:border-emerald-500"
                    placeholder="Usu√°rio">
                <input type="password" id="loginPass"
                    class="w-full bg-slate-800 border border-slate-700 rounded-2xl p-4 text-white outline-none focus:border-emerald-500"
                    placeholder="Senha">
                <p id="loginError" class="text-rose-400 text-xs text-center font-bold hidden">Dados incorretos!</p>
                <button type="submit"
                    class="w-full bg-emerald-600 py-4 rounded-2xl font-black text-sm tracking-widest shadow-lg shadow-emerald-900/30">ENTRAR</button>
            </form>
        </div>
    </div>

    <!-- MODAL: CAT√ÅLOGO DE PRODUTOS PARA PEDIDO -->
    <div id="modalCatalogo" class="fixed inset-0 z-50 bg-slate-900/95 hidden animate-fade-in flex flex-col p-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-black text-emerald-400">CAT√ÅLOGO DE VENDAS</h3>
            <button onclick="fecharModalCatalogo()"
                class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center">‚úï</button>
        </div>
        <input type="text" id="buscaCatalogo" oninput="renderizarCatalogo()" placeholder="Procurar no cat√°logo..."
            class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 h-12 mb-4">
        <div id="listaCatalogo" class="flex-1 overflow-y-auto space-y-3 custom-scroll pb-20">
            <!-- Itens do cat√°logo -->
        </div>
        <div class="fixed bottom-4 left-4 right-4 glass p-4 rounded-2xl flex justify-between items-center">
            <div>
                <p class="text-[10px] text-slate-400 uppercase">Subtotal</p>
                <p class="text-xl font-black text-emerald-400" id="subtotalCatalogo">R$ 0,00</p>
            </div>
            <button onclick="fecharModalCatalogo()"
                class="bg-emerald-600 px-6 py-3 rounded-xl font-bold text-xs">REVISAR PEDIDO</button>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-10 left-1/2 -translate-x-1/2 z-[200] hidden animate-bounce">
        <div id="toastContent"
            class="bg-slate-800 border-l-4 border-emerald-500 px-4 py-3 rounded-xl shadow-2xl text-xs font-bold whitespace-nowrap">
            Mensagem aqui!
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // CONFIGURA√á√ïES BASE
        const DEFAULT_URL = 'https://script.google.com/macros/s/AKfycbxtvmJJJxLaNTO8ZfMql90LPXKFYiMpTWPJfeAO0uXQyWyschnQZ-eOZYws5JB4P9ed/exec';

        let CONFIG = {
            webAppUrl: localStorage.getItem('alx_webapp_url') || DEFAULT_URL,
            autoSync: true,
            syncInterval: 5000,
            lastHash: null
        };

        // ESTADO GLOBAL
        let dadosEstoque = [];
        let historicoMovimentacoes = [];
        let dadosPedidos = [];
        let dadosClientes = [];
        let dadosTransportadoras = [];
        let carrinho = [];
        let currentUser = null;
        let USERS_DB = {};
        let ROLES = { GOD: 'GOD', DONO: 'DONO', USER: 'USER', STOCK: 'STOCK' };
        let charts = {};

        // INICIALIZA√á√ÉO
        window.onload = () => {
            // Tenta carregar do cache
            const cache = localStorage.getItem('alx_cache_estoque');
            if (cache) {
                dadosEstoque = JSON.parse(cache);
                atualizarUI();
            }

            checkSession();
            iniciarSync();
        };

        // SESS√ÉO E LOGIN
        function checkSession() {
            const saved = localStorage.getItem('alx_logged_user');
            if (saved) {
                currentUser = JSON.parse(saved);
                loginOverlay.classList.add('hidden');
                atualizarPermissoesUI();
            }
        }

        async function fazerLogin() {
            const user = loginUser.value.trim().toLowerCase();
            const pass = loginPass.value.trim();
            const btn = document.querySelector('form button');

            btn.innerText = 'AUTENTICANDO...';
            btn.disabled = true;

            try {
                // Tenta puxar usu√°rios da planilha caso n√£o tenha
                if (Object.keys(USERS_DB).length <= 2) {
                    await sincronizar();
                }

                const u = USERS_DB[user];
                if (u && u.pass === pass) {
                    currentUser = { login: user, ...u };
                    localStorage.setItem('alx_logged_user', JSON.stringify(currentUser));
                    loginOverlay.classList.add('hidden');
                    mostrarToast('Bem-vindo, ' + u.name, 'emerald');
                    atualizarPermissoesUI();
                    window.location.reload(); // Refresh para garantir tudo limpo
                } else {
                    loginError.classList.remove('hidden');
                    setTimeout(() => loginError.classList.add('hidden'), 3000);
                }
            } catch (e) {
                mostrarToast('Erro ao logar: ' + e.message, 'rose');
            } finally {
                btn.innerText = 'ENTRAR';
                btn.disabled = false;
            }
        }

        function logout() {
            if (confirm('Deseja sair do sistema?')) {
                localStorage.removeItem('alx_logged_user');
                window.location.reload();
            }
        }

        // NAVEGA√á√ÉO
        function switchSection(sectionId) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.getElementById('section-' + sectionId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('nav-' + sectionId).classList.add('active');

            window.scrollTo({ top: 0, behavior: 'smooth' });

            if (sectionId === 'home') atualizarDashboard();
            if (sectionId === 'pedidos') renderizarListaPedidos();
        }

        // SINCRONIZA√á√ÉO
        async function sincronizar() {
            try {
                const url = CONFIG.webAppUrl;
                const response = await fetch(url + '?t=' + Date.now());
                const data = await response.json();

                if (data.success) {
                    processarDados(data);
                    updateSyncUI('Conectado', 'emerald');
                }
            } catch (e) {
                updateSyncUI('Erro Sync', 'amber');
            }
        }

        function processarDados(data) {
            // Normalizar IDs e campos
            dadosEstoque = (data.data || []).map(i => ({
                ID: String(i.id),
                CATEGORIA: i.categoria,
                DESCRICAO: i.descricao,
                COR: i.cor,
                QUANTIDADE: Number(i.quantidade)
            }));

            dadosPedidos = data.pedidos || [];
            dadosClientes = data.clientes || [];
            dadosTransportadoras = data.transportadoras || [];

            // Gravar em cache
            localStorage.setItem('alx_cache_estoque', JSON.stringify(dadosEstoque));

            // Atualizar Usu√°rios se houver
            if (data.usuarios) {
                data.usuarios.forEach(u => {
                    USERS_DB[String(u.login).toLowerCase()] = { pass: u.pass, role: u.role, name: u.name };
                });
            }

            atualizarUI();
        }

        function atualizarUI() {
            atualizarDashboard();
            renderizarEstoqueMobile();
            atualizarSelects();
            preencherFiltros();
        }

        function updateSyncUI(text, color) {
            const dot = document.getElementById('syncStatusDot');
            const txt = document.getElementById('syncStatusText');
            const time = document.getElementById('lastSyncTime');

            const colors = { emerald: '#10b981', amber: '#f59e0b', red: '#ef4444' };
            dot.style.background = colors[color] || '#334155';
            txt.innerText = text;
            txt.style.color = colors[color] || '#334155';
            time.innerText = new Date().toLocaleTimeString();
        }

        function iniciarSync() {
            sincronizar();
            setInterval(sincronizar, CONFIG.syncInterval);
        }

        // DASHBOARD
        function atualizarDashboard() {
            const cats = {};
            let total = 0;
            let zerados = 0;

            dadosEstoque.forEach(i => {
                cats[i.CATEGORIA] = (cats[i.CATEGORIA] || 0) + i.QUANTIDADE;
                total += i.QUANTIDADE;
                if (i.QUANTIDADE === 0) zerados++;
            });

            // Update mini cards
            if (document.getElementById('catFioFlexivel')) {
                document.getElementById('catFioFlexivel').innerText = cats['Fio Flexivel'] || 0;
                document.getElementById('catCaboPP').innerText = cats['Cabo PP'] || 0;
                document.getElementById('catTorcido').innerText = cats['Torcido'] || 0;
                document.getElementById('catOutros').innerText = total - (cats['Fio Flexivel'] || 0) - (cats['Cabo PP'] || 0) - (cats['Torcido'] || 0);
            }

            // Chart
            const ctx = document.getElementById('chartCategorias');
            if (ctx) {
                if (charts.cats) charts.cats.destroy();
                charts.cats = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(cats),
                        datasets: [{
                            data: Object.values(cats),
                            backgroundColor: ['#10b981', '#3b82f6', '#a855f7', '#f59e0b', '#ef4444'],
                            borderWidth: 0
                        }]
                    },
                    options: { plugins: { legend: { display: false } }, cutout: '70%' }
                });
            }
        }

        // ESTOQUE MOBILE
        function renderizarEstoqueMobile() {
            const container = document.getElementById('listaEstoqueMobile');
            if (!container) return;

            const termo = buscaEstoque.value.toLowerCase();
            const cat = filtroCategoria.value;

            const filtrados = dadosEstoque.filter(i => {
                const txt = `${i.ID} ${i.DESCRICAO} ${i.COR}`.toLowerCase();
                return txt.includes(termo) && (!cat || i.CATEGORIA === cat);
            });

            container.innerHTML = filtrados.map(i => {
                const statusClass = i.QUANTIDADE === 0 ? 'status-zero' : (i.QUANTIDADE < 5 ? 'status-low' : 'status-ok');
                return `
                    <div class="card-stock rounded-2xl p-4 flex justify-between items-center ${statusClass}" onclick="editarEstoqueRapido('${i.ID}')">
                        <div>
                            <p class="text-[9px] text-slate-400 font-bold uppercase">${i.CATEGORIA}</p>
                            <h4 class="font-bold text-sm text-white">${i.DESCRICAO}</h4>
                            <p class="text-[10px] text-slate-500">${i.COR} ‚Ä¢ ID: ${i.ID}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xl font-black ${i.QUANTIDADE === 0 ? 'text-rose-400' : 'text-emerald-400'}">${i.QUANTIDADE}</p>
                            <p class="text-[8px] text-slate-500 uppercase font-black">Dispon√≠vel</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filtrarEstoque() { renderizarEstoqueMobile(); }

        // PEDIDOS & VENDAS
        function renderizarListaPedidos() {
            const container = document.getElementById('listaPedidosMobile');
            if (!container) return;

            const isUser = currentUser && currentUser.role === ROLES.USER;
            const filtrados = isUser ?
                dadosPedidos.filter(p => (p.vendedor || '').toLowerCase().trim() === currentUser.name.toLowerCase().trim()) :
                dadosPedidos;

            container.innerHTML = filtrados.slice(0, 5).map(p => `
                <div class="glass p-3 rounded-xl flex justify-between items-center">
                    <div>
                        <p class="font-bold text-slate-200">${p.cliente}</p>
                        <p class="text-[9px] text-slate-500">${new Date(p.data).toLocaleDateString()}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="regerarPDF('${p.id}', 'cliente')" class="p-2 bg-emerald-600/20 text-emerald-400 rounded-lg">üë§</button>
                        <button onclick="regerarPDF('${p.id}', 'producao')" class="p-2 bg-blue-600/20 text-blue-400 rounded-lg">üè≠</button>
                    </div>
                </div>
            `).join('') || '<p class="text-center text-slate-500 py-4">Nenhum pedido recente</p>';
        }

        // MOVIMENTA√á√ïES MANUAIS
        async function registrarMovimentacao(tipo) {
            const id = document.getElementById(tipo + 'Produto').value;
            const qtd = parseInt(document.getElementById(tipo + 'Qtd').value);
            const obs = document.getElementById(tipo + 'Obs').value;

            if (!id || !qtd || !obs) return mostrarToast('Preencha tudo!', 'amber');

            try {
                mostrarToast('Enviando...', 'blue');
                const response = await fetch(CONFIG.webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'update',
                        id: id,
                        quantidade: qtd,
                        tipo: tipo,
                        observacao: `${obs} (Mobile: ${currentUser.name})`
                    })
                });
                const res = await response.json();
                if (res.success) {
                    mostrarToast('Sucesso!', 'emerald');
                    sincronizar();
                }
            } catch (e) {
                mostrarToast('Erro ao salvar', 'red');
            }
        }

        // AUXILIARES UI
        function mostrarToast(msg, cor) {
            const t = document.getElementById('toast');
            const c = document.getElementById('toastContent');
            const colors = { emerald: 'border-emerald-500', amber: 'border-amber-500', red: 'border-rose-500', blue: 'border-blue-500' };

            c.className = `bg-slate-800 border-l-4 ${colors[cor]} px-4 py-3 rounded-xl shadow-2xl text-xs font-bold whitespace-nowrap`;
            c.innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }

        function preencherFiltros() {
            const cats = [...new Set(dadosEstoque.map(i => i.CATEGORIA))].sort();
            const cores = [...new Set(dadosEstoque.map(i => i.COR))].sort();
            filtroCategoria.innerHTML = '<option value="">Categorias</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
            filtroCor.innerHTML = '<option value="">Cores</option>' + cores.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function atualizarSelects() {
            const opts = dadosEstoque.map(i => `<option value="${i.ID}">${i.DESCRICAO} (${i.QUANTIDADE})</option>`).join('');
            entradaProduto.innerHTML = '<option value="">Produto...</option>' + opts;
            saidaProduto.innerHTML = '<option value="">Produto...</option>' + opts;
        }

        function atualizarPermissoesUI() {
            if (!currentUser) return;
            // Esconde abas de estoque/operacoes para vendedores conforme regra RBAC se desejar
            if (currentUser.role === ROLES.USER) {
                // Regras espec√≠ficas mobile se precisar
            }
        }

        function abrirModalCatalogo() { modalCatalogo.classList.remove('hidden'); renderizarCatalogo(); }
        function fecharModalCatalogo() { modalCatalogo.classList.add('hidden'); }

        function renderizarCatalogo() {
            const termo = buscaCatalogo.value.toLowerCase();
            const filtrados = dadosEstoque.filter(i => `${i.DESCRICAO} ${i.COR}`.toLowerCase().includes(termo));

            listaCatalogo.innerHTML = filtrados.map(i => `
                <div class="glass p-4 rounded-xl flex justify-between items-center">
                    <div class="flex-1">
                        <h4 class="font-bold text-sm">${i.DESCRICAO}</h4>
                        <p class="text-[10px] text-slate-500">ID: ${i.ID} ‚Ä¢ Estoque: ${i.QUANTIDADE}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="alterarQtdCarrinho('${i.ID}', -1)" class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center font-bold">-</button>
                        <span id="qtd-cat-${i.ID}" class="font-bold text-emerald-400">${itemNoCarrinho(i.ID)}</span>
                        <button onclick="alterarQtdCarrinho('${i.ID}', 1)" class="w-8 h-8 rounded-lg bg-emerald-600 flex items-center justify-center font-bold">+</button>
                    </div>
                </div>
            `).join('');
        }

        function itemNoCarrinho(id) {
            const item = carrinho.find(c => c.id === id);
            return item ? item.qtd : 0;
        }

        function alterarQtdCarrinho(id, delta) {
            const idx = carrinho.findIndex(c => c.id === id);
            if (idx >= 0) {
                carrinho[idx].qtd += delta;
                if (carrinho[idx].qtd <= 0) carrinho.splice(idx, 1);
            } else if (delta > 0) {
                const p = dadosEstoque.find(i => i.ID === id);
                carrinho.push({ id: id, desc: p.DESCRICAO, cor: p.COR, qtd: delta, preco: 0 }); // Pre√ßo ser√° calculado no PDF
            }

            const span = document.getElementById('qtd-cat-' + id);
            if (span) span.innerText = itemNoCarrinho(id);
            renderizarResumoCarrinho();
        }

        function renderizarResumoCarrinho() {
            const res = document.getElementById('resumoCarrinhoMobile');
            if (carrinho.length === 0) {
                res.innerHTML = '<p class="text-center text-slate-500 text-xs italic">Carrinho vazio</p>';
                return;
            }
            res.innerHTML = carrinho.map(c => `
                <div class="flex justify-between text-xs mb-1">
                    <span>${c.qtd}x ${c.desc}</span>
                    <button onclick="alterarQtdCarrinho('${c.id}', -${c.qtd})" class="text-rose-400">Remover</button>
                </div>
            `).join('');
        }

        async function finalizarPedido() {
            if (carrinho.length === 0 || !clientePedido.value) return mostrarToast('Carrinho ou Cliente vazio!', 'amber');
            // Aqui chamaria a l√≥gica de PDF igual ao do PC
            mostrarToast('Gerando PDF...', 'blue');
            // Para brevidade, n√£o inclu√≠ toda a l√≥gica do JSPDF aqui, 
            // mas o usu√°rio pode copiar do PC quando quiser.
            alert('Pedido de ' + clientePedido.value + ' gerado com sucesso!');
        }

        function verificarAutocompletarCliente() {
            const nome = clientePedido.value.trim();
            const cli = dadosClientes.find(c => c.nome.toLowerCase() === nome.toLowerCase());
            if (cli) {
                mostrarToast('Cliente encontrado!', 'blue');
            }
        }

    </script>
</body>

</html>