<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ALX CABOS - ERP Estoque F√°brica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ALX Estoque">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        .pulse-ring {
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .change-highlight {
            animation: highlight 3s ease-out;
        }

        @keyframes highlight {
            0% {
                background: rgba(16, 185, 129, 0.4);
            }

            100% {
                background: transparent;
            }
        }
    </style>
</head>

<body class="text-slate-200 min-h-screen">

    <!-- TELA DE LOGIN -->
    <div id="loginOverlay" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-4">
        <div class="glass w-full max-w-md p-8 rounded-2xl border border-slate-700 shadow-2xl relative overflow-hidden">
            <!-- Background Decoration -->
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-emerald-500/20 rounded-full blur-3xl"></div>
            <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-blue-500/20 rounded-full blur-3xl"></div>

            <div class="text-center mb-8 relative z-10">
                <div
                    class="w-16 h-16 bg-gradient-to-br from-emerald-500 to-blue-600 rounded-2xl mx-auto flex items-center justify-center font-black text-3xl italic shadow-lg mb-4">
                    A
                </div>
                <h1 class="text-2xl font-black text-white tracking-tight">ALX CABOS</h1>
                <p class="text-xs text-slate-400 mt-1 uppercase tracking-widest font-bold">Acesso Restrito</p>
            </div>

            <form onsubmit="event.preventDefault(); fazerLogin();" class="space-y-4 relative z-10">
                <div>
                    <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1">Usu√°rio</label>
                    <input type="text" id="loginUser"
                        class="w-full bg-slate-800/50 border border-slate-600 rounded-lg p-3 text-white outline-none focus:border-emerald-500 transition-colors"
                        placeholder="Digite seu usu√°rio..." required autofocus autocapitalize="none" autocorrect="off"
                        spellcheck="false">
                </div>
                <div>
                    <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1">Senha</label>
                    <input type="password" id="loginPass"
                        class="w-full bg-slate-800/50 border border-slate-600 rounded-lg p-3 text-white outline-none focus:border-emerald-500 transition-colors"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocapitalize="none" autocorrect="off" spellcheck="false">
                </div>
                <p id="loginError" class="text-rose-400 text-xs text-center font-bold hidden animate-pulse">Usu√°rio ou
                    senha incorretos!</p>

                <p class="text-[10px] text-slate-500 mt-2 italic px-8">‚ö†Ô∏è Pol√≠tica de Seguran√ßa: Senhas devem conter
                    letras, n√∫meros e caracteres especiais.</p>

                <button type="submit"
                    class="w-full bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white font-bold py-3 rounded-lg shadow-lg shadow-emerald-900/20 transform transition hover:-translate-y-0.5">
                    ENTRAR NO SISTEMA
                </button>
            </form>

            <div class="mt-6 text-center border-t border-slate-700 pt-4">
                <p class="text-[10px] text-slate-500">Desenvolvido por <span class="font-bold text-slate-400">JRJ
                        LIMITADA</span></p>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div id="sidebar"
        class="fixed left-0 top-0 h-full w-72 glass z-50 p-6 flex flex-col transition-all duration-300 transform -translate-x-full lg:translate-x-0 overflow-hidden">

        <!-- Header Sidebar -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3 w-full transition-all duration-300" id="logoContainer">
                <!-- Logo A (Sempre vis√≠vel) -->
                <div class="w-12 h-12 flex-shrink-0 bg-gradient-to-br from-emerald-500 to-blue-600 rounded-xl flex items-center justify-center font-black text-2xl italic shadow-lg pulse-ring cursor-pointer hover:scale-105 transition-transform"
                    onclick="toggleDesktopSidebar()" title="Clique para expandir/recolher">
                    A
                </div>

                <!-- Texto Logo (Ocult√°vel) -->
                <div class="sidebar-text overflow-hidden transition-all duration-300 whitespace-nowrap flex-1">
                    <h1 class="font-black text-emerald-400 text-sm tracking-wider">ALX CABOS</h1>
                    <p class="text-[10px] text-slate-400">Estoque F√°brica v2.0</p>
                </div>
            </div>

            <!-- Toggle Button Desktop (Chevron) -->
            <button onclick="toggleDesktopSidebar()"
                class="hidden lg:flex text-slate-500 hover:text-white transition-transform duration-300"
                id="btnCollapseParams">
                <span class="text-xs">‚óÄ</span>
            </button>

            <!-- Close Button Mobile -->
            <button onclick="toggleSidebar()" class="lg:hidden text-slate-400 hover:text-white">
                ‚úï
            </button>
        </div>

        <!-- Status Conexao -->
        <!-- Status Conexao (Accordion) -->
        <div class="mb-6 bg-slate-800 rounded-xl border border-slate-700 overflow-hidden transition-all duration-300">
            <!-- Header Clic√°vel -->
            <button onclick="toggleStatusPanel()"
                class="w-full flex items-center justify-between p-4 hover:bg-slate-700/50 transition-colors focus:outline-none">
                <div class="flex items-center gap-2">
                    <span id="statusArrow"
                        class="text-slate-500 text-xs transition-transform transform rotate-180">‚ñº</span>
                    <span class="text-[10px] text-slate-400 uppercase font-bold">Dados Planilha</span>
                </div>
                <span id="connectionStatus" class="flex items-center gap-2 text-[10px] text-slate-500 font-bold">
                    <span class="w-2 h-2 bg-slate-500 rounded-full"></span>
                </span>
            </button>

            <!-- Conte√∫do (Default: Aberto ou Fechado? Vamos deixar aberto e usu√°rio fecha se quiser, ou vice versa) -->
            <!-- Vamos deixar com classe 'status-content' para manipular -->
            <div id="statusContent" class="px-4 pb-4 space-y-2 text-[10px] text-slate-500">
                <div class="flex justify-between border-t border-slate-700/50 pt-2">
                    <span>√öltima Sync:</span>
                    <span id="lastSyncTime" class="text-slate-300 font-mono">--:--:--</span>
                </div>
                <div class="flex justify-between">
                    <span>Itens Planilha:</span>
                    <span id="totalItemsSheets" class="text-emerald-400 font-bold">0</span>
                </div>
                <div class="flex justify-between">
                    <span>Altera√ß√µes Hoje:</span>
                    <span id="changesToday" class="text-blue-400 font-bold">0</span>
                </div>

                <div class="mt-3 grid grid-cols-2 gap-2 pt-2">
                    <button onclick="forceSync()"
                        class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] py-2 rounded-lg font-bold transition-all">
                        Sincronizar
                    </button>
                    <button onclick="toggleAutoSync()" id="btnAutoSync"
                        class="bg-emerald-600 hover:bg-emerald-500 text-white text-[10px] py-2 rounded-lg font-bold transition-all">
                        Pausar
                    </button>
                </div>

                <button onclick="openConfig()"
                    class="w-full mt-2 bg-slate-700 hover:bg-slate-600 text-slate-300 text-[10px] py-2 rounded-lg font-bold transition-all">
                    Configurar URL
                </button>

                <button onclick="limparCacheEmergencia()"
                    class="w-full mt-2 bg-red-600 hover:bg-red-500 text-white text-[10px] py-2 rounded-lg font-bold transition-all flex items-center justify-center gap-2"
                    title="Limpa o cache e for√ßa atualiza√ß√£o dos dados">
                    <span>üßπ</span> Limpar Cache
                </button>
            </div>
        </div>

        <nav class="space-y-1 flex-1 overflow-y-auto custom-scroll pr-1">
            <button onclick="switchTab('dashboard')" id="nav-dashboard"
                class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 hover:bg-slate-700 transition-all tab-active group relative"
                title="Painel de Controle">
                <span class="text-xl flex-shrink-0">üìä</span>
                <span
                    class="font-semibold text-sm sidebar-text whitespace-nowrap overflow-hidden transition-all duration-300">Painel
                    de Controle</span>
            </button>
            <button onclick="switchTab('estoque')" id="nav-estoque"
                class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 hover:bg-slate-700 transition-all group relative"
                title="Estoque Completo">
                <span class="text-xl flex-shrink-0">üì¶</span>
                <span
                    class="font-semibold text-sm sidebar-text whitespace-nowrap overflow-hidden transition-all duration-300">Estoque
                    Completo</span>
            </button>
            <button onclick="switchTab('categorias')" id="nav-categorias"
                class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 hover:bg-slate-700 transition-all group relative"
                title="Por Categoria">
                <span class="text-xl flex-shrink-0">üè∑Ô∏è</span>
                <span
                    class="font-semibold text-sm sidebar-text whitespace-nowrap overflow-hidden transition-all duration-300">Por
                    Categoria</span>
            </button>
            <button onclick="switchTab('movimentacoes')" id="nav-movimentacoes"
                class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 hover:bg-slate-700 transition-all group relative"
                title="Movimenta√ß√µes">
                <span class="text-xl flex-shrink-0">üîÑ</span>
                <span
                    class="font-semibold text-sm sidebar-text whitespace-nowrap overflow-hidden transition-all duration-300">Movimenta√ß√µes</span>
            </button>
            <button onclick="switchTab('operacoes')" id="nav-operacoes"
                class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 hover:bg-slate-700 transition-all group relative"
                title="Gerenciar Estoque">
                <span class="text-xl flex-shrink-0">üõ†Ô∏è</span>
                <span
                    class="font-semibold text-sm sidebar-text whitespace-nowrap overflow-hidden transition-all duration-300">Gerenciar
                    Estoque</span>
            </button>
            <button onclick="switchTab('historico-pedidos')" id="nav-historico-pedidos"
                class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 hover:bg-slate-700 transition-all group relative"
                title="Hist√≥rico Pedidos">
                <span class="text-xl flex-shrink-0">üìú</span>
                <span
                    class="font-semibold text-sm sidebar-text whitespace-nowrap overflow-hidden transition-all duration-300">Hist√≥rico
                    Pedidos</span>
            </button>
            <button onclick="switchTab('cadastros')" id="nav-cadastros"
                class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 hover:bg-slate-700 transition-all group relative"
                title="Cadastros">
                <span class="text-xl flex-shrink-0">üìù</span>
                <span
                    class="font-semibold text-sm sidebar-text whitespace-nowrap overflow-hidden transition-all duration-300">Cadastros</span>
            </button>
            <button onclick="switchTab('pedidos')" id="nav-pedidos"
                class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 hover:bg-slate-700 transition-all group relative"
                title="Pedidos (PDF)">
                <span class="text-xl flex-shrink-0">üìÑ</span>
                <span
                    class="font-semibold text-sm sidebar-text whitespace-nowrap overflow-hidden transition-all duration-300">Pedidos
                    (PDF)</span>
            </button>
            <button onclick="abrirModalNovoProduto()"
                class="w-full text-left px-4 py-3 mt-4 bg-emerald-600/20 hover:bg-emerald-600/30 border border-emerald-500/50 rounded-xl flex items-center gap-3 transition-all group relative"
                title="Novo Produto">
                <span class="text-xl flex-shrink-0">‚ûï</span>
                <span
                    class="font-semibold text-sm sidebar-text text-emerald-400 whitespace-nowrap overflow-hidden transition-all duration-300">Novo
                    Produto</span>
            </button>
            <button onclick="switchTab('usuarios')" id="nav-usuarios"
                class="hidden w-full text-left px-4 py-3 mt-2 rounded-xl flex items-center gap-3 hover:bg-slate-700 transition-all group relative"
                title="Usu√°rios">
                <span class="text-xl flex-shrink-0">üë•</span>
                <span
                    class="font-semibold text-sm sidebar-text whitespace-nowrap overflow-hidden transition-all duration-300">Usu√°rios</span>
            </button>

            <!-- Logout -->
            <button onclick="logout()" id="btnLogout"
                class="w-full text-left px-4 py-3 mt-8 bg-rose-900/20 hover:bg-rose-900/40 text-rose-400 hover:text-rose-200 rounded-xl flex items-center gap-3 transition-all border border-rose-500/20 group relative"
                title="Sair do Sistema">
                <span class="text-xl flex-shrink-0">üö™</span>
                <span
                    class="font-semibold text-sm sidebar-text whitespace-nowrap overflow-hidden transition-all duration-300">Sair
                    do Sistema</span>
            </button>
        </nav>

        <!-- Resumo Rapido -->
        <div class="mt-auto pt-4 border-t border-slate-700 space-y-3">
            <div class="bg-slate-800 rounded-xl p-3">
                <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Total em Estoque</p>
                <p class="text-2xl font-black text-emerald-400" id="totalGeral">0 <span
                        class="text-sm text-slate-500">rl</span></p>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div class="bg-slate-800 rounded-xl p-2 text-center">
                    <p class="text-[9px] text-slate-400 uppercase">Itens</p>
                    <p class="text-lg font-bold text-white" id="totalItens">0</p>
                </div>
                <div class="bg-slate-800 rounded-xl p-2 text-center">
                    <p class="text-[9px] text-slate-400 uppercase">Zerados</p>
                    <p class="text-lg font-bold text-red-400" id="totalZerados">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Header -->
    <div
        class="lg:hidden fixed top-0 left-0 w-full bg-slate-900 border-b border-slate-700 z-40 px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-2">
            <button onclick="toggleSidebar()" class="text-white p-2">
                <span class="text-2xl">‚ò∞</span>
            </button>
            <h1 class="font-black text-emerald-400 text-sm tracking-wider">ALX CABOS</h1>
        </div>
        <div id="mobileAlertBadge" class="hidden bg-red-500 text-white text-xs px-2 py-0.5 rounded-full font-bold">0
        </div>
    </div>

    <!-- Overlay for Mobile Sidebar -->
    <div id="sidebarOverlay" onclick="toggleSidebar()"
        class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden backdrop-blur-sm transition-opacity"></div>

    <!-- Main Content -->
    <!-- Main Content -->
    <!-- Main Content -->
    <!-- Main Content -->
    <div id="mainContent" class="lg:ml-72 p-4 lg:p-6 mt-14 lg:mt-0 transition-all duration-300">

        <!-- Header -->
        <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
            <div>
                <h2 id="pageTitle" class="text-2xl lg:text-3xl font-black text-white mb-1">Painel de Controle</h2>
                <p class="text-slate-400 text-xs lg:text-sm">Vis√£o geral do estoque da f√°brica em tempo real</p>
            </div>
            <div class="flex items-center gap-4 w-full lg:w-auto justify-between lg:justify-end">
                <button onclick="abrirModalAlertas()"
                    class="relative p-2 text-slate-400 hover:text-white transition-colors mr-2">
                    <span class="text-xl">üîî</span>
                    <span id="headerAlertBadge"
                        class="absolute top-0 right-0 bg-red-500 text-white text-[9px] px-1.5 py-0.5 rounded-full hidden">0</span>
                </button>
                <div class="hidden sm:block text-right border-r border-slate-700 pr-5 mr-1">
                    <p class="text-[8px] text-slate-500 font-bold uppercase tracking-widest leading-none mb-1">
                        Desenvolvido por</p>
                    <p
                        class="text-xs font-black tracking-wide text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-indigo-400 to-purple-500 font-mono">
                        JRJ LIMITADA
                    </p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-slate-400 uppercase">Data da Planilha</p>
                    <p class="text-sm font-bold text-slate-300" id="sheetDate">--/--/----</p>
                </div>
            </div>
        </header>

        <!-- TAB: DASHBOARD -->
        <div id="tab-dashboard" class="space-y-6">
            <!-- Aviso Dashboard -->
            <div class="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
                <h4 class="font-bold text-blue-400 mb-1 text-sm">üí° Painel de Controle:</h4>
                <p class="text-xs text-slate-300">Acompanhe aqui o resumo do seu estoque. Os gr√°ficos mostram a
                    distribui√ß√£o atual por categoria e cor. As movimenta√ß√µes s√£o atualizadas automaticamente.</p>
            </div>
            <!-- Cards Principais -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="glass rounded-2xl p-5 border-l-4 border-emerald-500">
                    <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Fio Flexivel</p>
                    <p class="text-3xl font-black text-emerald-400" id="catFioFlexivel">0</p>
                    <p class="text-xs text-slate-500">rolos em estoque</p>
                </div>
                <div class="glass rounded-2xl p-5 border-l-4 border-blue-500">
                    <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Cabo PP</p>
                    <p class="text-3xl font-black text-blue-400" id="catCaboPP">0</p>
                    <p class="text-xs text-slate-500">rolos em estoque</p>
                </div>
                <div class="glass rounded-2xl p-5 border-l-4 border-purple-500">
                    <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Torcido</p>
                    <p class="text-3xl font-black text-purple-400" id="catTorcido">0</p>
                    <p class="text-xs text-slate-500">rolos em estoque</p>
                </div>
                <div class="glass rounded-2xl p-5 border-l-4 border-amber-500">
                    <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Outros</p>
                    <p class="text-3xl font-black text-amber-400" id="catOutros">0</p>
                    <p class="text-xs text-slate-500">rolos em estoque</p>
                </div>
            </div>

            <!-- Graficos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass rounded-2xl p-6">
                    <h3 class="font-bold text-lg mb-4">Estoque por Categoria</h3>
                    <canvas id="chartCategorias" width="400" height="250"></canvas>
                </div>
                <div class="glass rounded-2xl p-6">
                    <h3 class="font-bold text-lg mb-4">Distribuicao por Cor</h3>
                    <canvas id="chartCores" width="400" height="250"></canvas>
                </div>
            </div>

            <!-- Ultimas Atualizacoes -->
            <div class="glass rounded-2xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">Ultimas Movimentacoes Detectadas</h3>
                    <span class="flex items-center gap-2 text-[10px] text-emerald-400">
                        <span class="live-dot"></span> MONITORANDO
                    </span>
                </div>
                <div id="ultimasMovimentacoes" class="space-y-2 max-h-64 overflow-y-auto custom-scroll">
                    <p class="text-slate-500 text-center py-8 text-sm">Aguardando sincronizacao...</p>
                </div>
            </div>
        </div>

        <!-- TAB: ESTOQUE COMPLETO -->
        <div id="tab-estoque" class="hidden space-y-6">
            <div class="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
                <h4 class="font-bold text-blue-400 mb-1 text-sm">üí° Estoque Completo:</h4>
                <p class="text-xs text-slate-300">Aqui voc√™ v√™ todos os itens cadastrados. Use os filtros de busca,
                    categoria e cor para encontrar produtos espec√≠ficos rapidamente.</p>
            </div>
            <div class="glass rounded-2xl p-6">
                <div class="flex flex-wrap gap-4 mb-6">
                    <input type="text" id="buscaEstoque" oninput="filtrarEstoque()"
                        placeholder="Buscar por descricao, categoria ou cor..."
                        class="flex-1 bg-slate-800 border border-slate-600 rounded-xl px-4 py-3 outline-none focus:border-emerald-500 min-w-[300px]">

                    <select id="filtroCategoria" onchange="filtrarEstoque()"
                        class="bg-slate-800 border border-slate-600 rounded-xl px-4 py-3 outline-none focus:border-emerald-500">
                        <option value="">Todas Categorias</option>
                    </select>

                    <select id="filtroCor" onchange="filtrarEstoque()"
                        class="bg-slate-800 border border-slate-600 rounded-xl px-4 py-3 outline-none focus:border-emerald-500">
                        <option value="">Todas Cores</option>
                    </select>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-800 text-[10px] font-black uppercase text-slate-400">
                            <tr>
                                <th class="p-4">ID</th>
                                <th class="p-4">Categoria</th>
                                <th class="p-4">Descricao</th>
                                <th class="p-4">Cor</th>
                                <th class="p-4 text-center">Qtd (Saldo)</th>
                                <th class="p-4 text-center">Status</th>
                                <th class="p-4">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaEstoque" class="divide-y divide-slate-700">
                            <tr>
                                <td colspan="7" class="p-8 text-center text-slate-500">
                                    Configure a conexao com a planilha para ver os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: CATEGORIAS -->
        <div id="tab-categorias" class="hidden space-y-6">
            <div class="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
                <h4 class="font-bold text-blue-400 mb-1 text-sm">üí° Categorias:</h4>
                <p class="text-xs text-slate-300">Visualize seu estoque agrupado por tipo de produto. Clique em uma
                    categoria para ver os itens pertencentes a ela.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="cardsCategorias">
                <!-- Preenchido dinamicamente -->
            </div>
        </div>

        <!-- TAB: MOVIMENTACOES -->
        <div id="tab-movimentacoes" class="hidden space-y-6">
            <div class="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
                <h4 class="font-bold text-blue-400 mb-1 text-sm">üí° Hist√≥rico de Movimenta√ß√µes:</h4>
                <p class="text-xs text-slate-300">Registro detalhado de todas as entradas, sa√≠das, pedidos e ajustes
                    manuais realizados. √ötil para auditoria e controle de fluxo.</p>
            </div>
            <div class="glass rounded-2xl p-6">
                <h3 class="font-bold text-lg mb-4">Historico de Alteracoes</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-800 text-[10px] font-black uppercase text-slate-400">
                            <tr>
                                <th class="p-4">Data/Hora</th>
                                <th class="p-4">Produto</th>
                                <th class="p-4 text-center">Anterior</th>
                                <th class="p-4 text-center">Novo</th>
                                <th class="p-4 text-center">Diferenca</th>
                                <th class="p-4">Tipo</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaMovimentacoes" class="divide-y divide-slate-700">
                            <tr>
                                <td colspan="6" class="p-8 text-center text-slate-500">
                                    Nenhuma movimentacao registrada ainda
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>



        <!-- TAB: USUARIOS -->
        <div id="tab-usuarios" class="hidden space-y-6">
            <div class="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
                <h4 class="font-bold text-blue-400 mb-1 text-sm">üí° Gerenciar Usu√°rios:</h4>
                <p class="text-xs text-slate-300">Crie e gerencie o acesso ao sistema. Apenas Administradores podem
                    acessar
                    esta √°rea.</p>
            </div>

            <div class="glass rounded-2xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-lg">Usu√°rios Cadastrados</h3>
                    <button onclick="abrirModalNovoUsuario()"
                        class="bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                        <span>‚ûï</span> Novo Usu√°rio
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-800 text-[10px] font-black uppercase text-slate-400">
                            <tr>
                                <th class="p-4">Usu√°rio</th>
                                <th class="p-4">Nome</th>
                                <th class="p-4">N√≠vel (Role)</th>
                                <th class="p-4 text-center">Status</th>
                                <th class="p-4 text-center">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaUsuarios" class="divide-y divide-slate-700">
                            <!-- Preenchido via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- TAB: OPERACOES -->
        <div id="tab-operacoes" class="hidden space-y-6">
            <div class="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
                <h4 class="font-bold text-blue-400 mb-1 text-sm">üí° Gerenciar Estoque:</h4>
                <p class="text-xs text-slate-300">Use esta aba para registrar movimenta√ß√µes manuais. **Entrada:** Novas
                    compras ou sobras. **Sa√≠da:** Perdas ou uso interno. **Ajuste:** Corre√ß√£o direta do saldo total.</p>
            </div>
            <!-- Menu de Sub-Abas -->
            <div class="flex space-x-2 bg-slate-800 p-1 rounded-xl w-fit">
                <button onclick="switchSubTab('entrada')" id="subnav-entrada"
                    class="px-6 py-2 rounded-lg text-sm font-bold text-slate-400 hover:text-white transition-all flex items-center gap-2">
                    <span>üì•</span> Entrada
                </button>
                <button onclick="switchSubTab('saida')" id="subnav-saida"
                    class="px-6 py-2 rounded-lg text-sm font-bold text-slate-400 hover:text-white transition-all flex items-center gap-2">
                    <span>üì§</span> Sa√≠da
                </button>
                <button onclick="switchSubTab('ajuste')" id="subnav-ajuste"
                    class="px-6 py-2 rounded-lg text-sm font-bold text-slate-400 hover:text-white transition-all flex items-center gap-2">
                    <span>üõ†Ô∏è</span> Ajuste
                </button>
            </div>

            <!-- SUB-TAB: ENTRADA -->
            <div id="subtab-entrada" class="hidden animate-fade-in">
                <div class="glass rounded-2xl p-6 border-l-4 border-emerald-500">
                    <h3 class="font-bold text-lg mb-4 text-emerald-400">Registrar Entrada de Material</h3>
                    <div class="bg-slate-800 rounded-xl p-5 max-w-lg">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Produto</label>
                                <select id="entradaProduto"
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-sm">
                                    <option value="">Selecione o produto...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Quantidade
                                    (Rolos)</label>
                                <input type="number" id="entradaQtd" placeholder="Qtd" min="1"
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-sm">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Observa√ß√£o
                                    (Obrigat√≥rio)</label>
                                <input type="text" id="entradaObs" placeholder="Ex: NF 123, Compra Fornecedor X..."
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-sm">
                            </div>
                            <button onclick="registrarMovimentacao('entrada')"
                                class="w-full bg-emerald-600 hover:bg-emerald-500 py-3 rounded-lg font-bold text-sm transition-all shadow-lg shadow-emerald-900/20">
                                Confirmar Entrada
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SUB-TAB: SAIDA -->
            <div id="subtab-saida" class="hidden animate-fade-in">
                <div class="glass rounded-2xl p-6 border-l-4 border-red-500">
                    <h3 class="font-bold text-lg mb-4 text-red-400">Registrar Sa√≠da Manual</h3>
                    <p class="text-sm text-slate-400 mb-4">Para pedidos de clientes, use a aba "Pedidos". Use esta aba
                        apenas para baixas avulsas (perdas, uso interno, etc).</p>
                    <div class="bg-slate-800 rounded-xl p-5 max-w-lg">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Produto</label>
                                <select id="saidaProduto"
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-sm">
                                    <option value="">Selecione o produto...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Quantidade
                                    (Rolos)</label>
                                <input type="number" id="saidaQtd" placeholder="Qtd" min="1"
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-sm">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Observa√ß√£o
                                    (Obrigat√≥rio)</label>
                                <input type="text" id="saidaObs" placeholder="Ex: Perda, Uso Interno, Doa√ß√£o..."
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-sm">
                            </div>
                            <button onclick="registrarMovimentacao('saida')"
                                class="w-full bg-red-600 hover:bg-red-500 py-3 rounded-lg font-bold text-sm transition-all shadow-lg shadow-red-900/20">
                                Confirmar Sa√≠da
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SUB-TAB: AJUSTE -->
            <div id="subtab-ajuste" class="hidden animate-fade-in">
                <div class="glass rounded-2xl p-6 border-l-4 border-blue-500">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="font-bold text-lg text-blue-400">Ajuste Direto de Estoque</h3>
                            <p class="text-sm text-slate-400">Corrige o valor final do estoque (Sobrescreve a quantidade
                                atual)</p>
                        </div>
                        <button onclick="abrirPlanilhaGoogle()"
                            class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs font-bold transition-all">
                            Abrir Planilha Original
                        </button>
                    </div>

                    <div class="bg-slate-800 rounded-xl p-5 max-w-lg">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Produto</label>
                                <select id="ajusteProduto"
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-sm">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Nova Quantidade
                                    Real</label>
                                <input type="number" id="ajusteQtd" placeholder="Ex: 50" min="0"
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-sm">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Motivo do
                                    Ajuste (Obrigat√≥rio)</label>
                                <input type="text" id="ajusteMotivo"
                                    placeholder="Ex: Contagem f√≠sica, Erro de lan√ßamento..."
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-sm">
                            </div>
                            <button onclick="ajusteDireto()"
                                class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-bold text-sm transition-all shadow-lg shadow-blue-900/20">
                                Salvar Ajuste
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: ALERTAS -->
        <div id="tab-alertas" class="hidden space-y-6">
            <div class="glass rounded-2xl p-6">
                <h3 class="font-bold text-lg mb-4 text-red-400">Itens com Estoque Critico (Zero ou Baixo)</h3>
                <div id="listaAlertas" class="space-y-3">
                    <p class="text-slate-500 text-center py-8">Nenhum alerta no momento</p>
                </div>
            </div>
        </div>

        <!-- TAB: CADASTROS (NOVA) -->
        <div id="tab-cadastros" class="hidden space-y-6">
            <div class="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
                <h4 class="font-bold text-blue-400 mb-1 text-sm">üí° Cadastros:</h4>
                <p class="text-xs text-slate-300">Mantenha aqui os dados de seus clientes e transportadoras atualizados.
                    Esses dados s√£o fundamentais para que os PDFs de pedidos e ordens de produ√ß√£o sejam gerados
                    corretamente.</p>
            </div>
            <!-- Menu de Sub-Abas -->
            <div class="flex space-x-2 bg-slate-800 p-1 rounded-xl w-fit mb-6">
                <button onclick="switchSubTabCadastro('clientes')" id="subnav-cad-clientes"
                    class="px-6 py-2 rounded-lg text-sm font-bold text-white bg-emerald-600 transition-all flex items-center gap-2">
                    <span>üë•</span> Clientes
                </button>
                <button onclick="switchSubTabCadastro('transportadoras')" id="subnav-cad-transportadoras"
                    class="px-6 py-2 rounded-lg text-sm font-bold text-slate-400 hover:text-white transition-all flex items-center gap-2">
                    <span>üöö</span> Transportadoras
                </button>
            </div>

            <!-- SUB-TAB: CLIENTES -->
            <div id="subtab-cad-clientes" class="animate-fade-in">
                <div class="glass rounded-2xl p-6 border-l-4 border-emerald-500">
                    <h3 class="font-bold text-lg mb-4 text-emerald-400">Cadastrar Novo Cliente</h3>
                    <div class="bg-slate-800 rounded-xl p-5 max-w-2xl">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Nome
                                    Completo</label>
                                <input type="text" id="cadCliNome" placeholder="Nome do Cliente ou Raz√£o Social"
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-sm">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Telefone /
                                    Celular</label>
                                <input type="text" id="cadCliTel" placeholder="(XX) XXXXX-XXXX"
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-sm">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">CNPJ /
                                    CPF</label>
                                <input type="text" id="cadCliDoc" placeholder="00.000.000/0000-00"
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-sm">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Inscri√ß√£o
                                    Estadual</label>
                                <input type="text" id="cadCliIE" placeholder="Isento se n√£o houver"
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-sm">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Endere√ßo
                                    Completo</label>
                                <input type="text" id="cadCliEnd" placeholder="Rua, N√∫mero, Bairro, Cidade - UF, CEP"
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-sm">
                            </div>
                            <div class="md:col-span-2 pt-4">
                                <button onclick="salvarCliente()"
                                    class="w-full bg-emerald-600 hover:bg-emerald-500 py-3 rounded-lg font-bold text-sm transition-all shadow-lg shadow-emerald-900/20">
                                    Salvar Cliente
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Clientes Cadastrados -->
                    <div class="mt-8">
                        <h4 class="text-sm font-bold text-slate-400 uppercase mb-4 flex items-center gap-2">
                            <span>üìã</span> Clientes Cadastrados
                        </h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-xs">
                                <thead class="bg-slate-900/50 text-slate-500 uppercase font-black">
                                    <tr>
                                        <th class="p-3">Nome</th>
                                        <th class="p-3">Telefone</th>
                                        <th class="p-3">CPF/CNPJ</th>
                                        <th class="p-3 text-right">A√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody id="listaClientesCadastrados" class="divide-y divide-slate-800">
                                    <!-- Preenchido via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SUB-TAB: TRANSPORTADORAS -->
            <div id="subtab-cad-transportadoras" class="hidden animate-fade-in">
                <div class="glass rounded-2xl p-6 border-l-4 border-blue-500">
                    <h3 class="font-bold text-lg mb-4 text-blue-400">Cadastrar Transportadora</h3>
                    <div class="bg-slate-800 rounded-xl p-5 max-w-2xl">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Nome da
                                    Transportadora</label>
                                <input type="text" id="cadTranspNome" placeholder="Ex: Log√≠stica Express"
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-sm">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">CNPJ</label>
                                <input type="text" id="cadTranspCNPJ" placeholder="00.000.000/0000-00"
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-sm">
                            </div>
                            <div>
                                <label
                                    class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Telefone</label>
                                <input type="text" id="cadTranspTel" placeholder="(XX) XXXXX-XXXX"
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-sm">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Nome do
                                    Contato</label>
                                <input type="text" id="cadTranspContato" placeholder="Falar com..."
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-sm">
                            </div>
                            <div class="md:col-span-2 pt-4">
                                <button onclick="salvarTransportadora()"
                                    class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-bold text-sm transition-all shadow-lg shadow-blue-900/20">
                                    Salvar Transportadora
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Transportadoras Cadastradas -->
                    <div class="mt-8">
                        <h4 class="text-sm font-bold text-slate-400 uppercase mb-4 flex items-center gap-2">
                            <span>üìã</span> Transportadoras Cadastradas
                        </h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-xs">
                                <thead class="bg-slate-900/50 text-slate-500 uppercase font-black">
                                    <tr>
                                        <th class="p-3">Nome</th>
                                        <th class="p-3">Telefone</th>
                                        <th class="p-3">Contato</th>
                                    </tr>
                                </thead>
                                <tbody id="listaTranspCadastradas" class="divide-y divide-slate-800">
                                    <!-- Preenchido via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: PEDIDOS (NOVA) -->
        <div id="tab-pedidos" class="hidden space-y-6">
            <div
                class="bg-gradient-to-r from-blue-900/40 to-slate-900/40 border border-blue-500/30 rounded-2xl p-6 shadow-2xl backdrop-blur-sm">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-blue-500/20 p-2 rounded-lg text-blue-400">
                        <span class="text-xl">üí°</span>
                    </div>
                    <h4 class="font-black text-blue-100 text-lg uppercase tracking-wider">Como utilizar esta aba</h4>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 text-sm">
                    <div class="space-y-3">
                        <p class="text-blue-300 font-bold flex items-center gap-2">
                            <span
                                class="bg-blue-500 text-white w-5 h-5 flex items-center justify-center rounded-full text-[10px]">1</span>
                            Montagem do Carrinho
                        </p>
                        <ul class="text-slate-300 space-y-2 pl-7 list-disc">
                            <li>Selecione o cliente (o sistema autocompleta os dados).</li>
                            <li>Busque produtos no cat√°logo abaixo e clique para adicionar ao pedido.</li>
                            <li>Ajuste a quantidade diretamente na tabela do carrinho.</li>
                        </ul>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                            <p class="text-blue-400 font-bold flex items-center gap-2 mb-1">
                                <span>üìÑ</span> Gerar Or√ßamento
                            </p>
                            <p class="text-xs text-slate-400">Gera apenas 1 PDF para o cliente. <strong>N√£o altera o
                                    estoque</strong> e n√£o salva na nuvem. Ideal para or√ßamentos r√°pidos.</p>
                        </div>
                        <div class="bg-emerald-900/20 p-3 rounded-xl border border-emerald-500/30">
                            <p class="text-emerald-400 font-bold flex items-center gap-2 mb-1">
                                <span>‚úÖ</span> Finalizar Pedido
                            </p>
                            <p class="text-xs text-slate-400">Gera os 3 PDFs, <strong>baixa o estoque
                                    automaticamente</strong> e salva o hist√≥rico permanentemente.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="glass rounded-2xl p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h3 class="font-bold text-lg text-emerald-400">Novo Pedido / Or√ßamento</h3>

                    <!-- Abas Internas de Pedido -->
                    <div class="flex bg-slate-900/50 p-1 rounded-lg">
                        <button onclick="switchSubTabPedido('novo')" id="subnav-ped-novo"
                            class="px-4 py-1.5 rounded-md text-xs font-bold bg-emerald-600 text-white transition-all">
                            üõí Carrinho
                        </button>
                        <button onclick="switchSubTabPedido('precos')" id="subnav-ped-precos"
                            class="px-4 py-1.5 rounded-md text-xs font-bold text-slate-400 hover:text-white transition-all">
                            üí∞ Tabela de Pre√ßos
                        </button>
                    </div>

                    <div class="text-right">
                        <p class="text-[10px] text-slate-400 uppercase">Itens no Pedido</p>
                        <p class="text-xl font-black text-white" id="contadorCarrinho">0</p>
                    </div>
                </div>

                <!-- SUB-TAB: NOVO PEDIDO (CARRINHO) -->
                <div id="subtab-ped-novo" class="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in">
                    <!-- Selecao de Produtos -->
                    <div class="lg:col-span-1 space-y-4">
                        <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Buscar
                                Produto</label>
                            <input type="text" id="buscaPedido" oninput="filtrarProdutosPedido()"
                                placeholder="Digite para buscar..."
                                class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-sm outline-none focus:border-emerald-500">

                            <div id="listaProdutosPedido"
                                class="mt-3 space-y-2 max-h-[400px] overflow-y-auto custom-scroll">
                                <!-- Preenchido via JS -->
                                <p class="text-xs text-slate-500 text-center py-4">Carregando produtos...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Carrinho / Lista do Pedido -->
                    <div class="lg:col-span-2 space-y-4">
                        <div class="bg-slate-800 rounded-xl p-5 border border-slate-700 min-h-[400px] flex flex-col">
                            <div class="mb-4 space-y-3">
                                <h4
                                    class="font-bold text-xs text-emerald-400 uppercase border-b border-emerald-900/30 pb-1">
                                    Dados do Cliente / Entrega</h4>

                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Nome /
                                            Solicitante *</label>
                                        <input type="text" id="clientePedido" list="listClientes"
                                            onchange="verificarAutocompletarCliente()"
                                            placeholder="Nome do Cliente (Selecione ou Digite)"
                                            class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-xs outline-none focus:border-emerald-500">
                                        <datalist id="listClientes"></datalist>
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Celular
                                            / Telefone *</label>
                                        <input type="text" id="numCliente" placeholder="(XX) XXXXX-XXXX"
                                            class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-xs outline-none focus:border-emerald-500">
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">CNPJ /
                                            CPF *</label>
                                        <input type="text" id="cnpjPedido" placeholder="00.000.000/0000-00"
                                            class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-xs outline-none focus:border-emerald-500">
                                    </div>
                                    <div>
                                        <label
                                            class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Inscri√ß√£o
                                            Estadual</label>
                                        <input type="text" id="iePedido" placeholder="Isento se n√£o houver"
                                            class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-xs outline-none focus:border-emerald-500">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Endere√ßo
                                        Completo (com CEP) *</label>
                                    <input type="text" id="enderecoPedido"
                                        placeholder="Rua, N¬∫, Bairro, Cidade - UF, CEP"
                                        class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-xs outline-none focus:border-emerald-500">
                                </div>

                                <div>
                                    <label
                                        class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Transportadora</label>
                                    <input type="text" id="transportadoraPedido" list="listTransportadoras"
                                        placeholder="Nome da Transportadora"
                                        class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-xs outline-none focus:border-emerald-500">
                                    <datalist id="listTransportadoras"></datalist>
                                </div>

                                <div class="text-right pt-2">
                                    <button onclick="limparCarrinho()"
                                        class="text-xs text-red-400 hover:text-red-300 font-bold">
                                        Limpar Tudo
                                    </button>
                                </div>
                            </div>

                            <div class="flex-1 overflow-x-auto mb-4">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-900/50 text-[10px] font-black uppercase text-slate-400">
                                        <tr>
                                            <th class="p-3">Produto</th>
                                            <th class="p-3 text-center">Qtd</th>
                                            <th class="p-3 text-center">Estoque Atual</th>
                                            <th class="p-3 text-center">Status</th>
                                            <th class="p-3 text-right">A√ß√£o</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaCarrinho" class="divide-y divide-slate-700">
                                        <tr>
                                            <td colspan="5" class="p-8 text-center text-slate-500 italic">
                                                Nenhum item adicionado ao pedido
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="pt-4 border-t border-slate-700 flex justify-end gap-3">
                                <button onclick="gerarOrcamento()"
                                    class="bg-blue-600 hover:bg-blue-500 text-white py-3 px-6 rounded-xl font-bold text-sm shadow-lg shadow-blue-900/20 transition-all flex items-center gap-2">
                                    <span>üìÑ</span> Gerar Or√ßamento
                                </button>
                                <button onclick="finalizarPedido()"
                                    class="bg-emerald-600 hover:bg-emerald-500 text-white py-3 px-8 rounded-xl font-bold text-sm shadow-lg shadow-emerald-900/20 transition-all flex items-center gap-2">
                                    <span>üìÑ</span> Finalizar e Gerar PDFs
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SUB-TAB: TABELA DE PRE√áOS -->
                <div id="subtab-ped-precos" class="hidden animate-fade-in">
                    <!-- Guia de Configura√ß√£o Premium -->
                    <div
                        class="bg-gradient-to-r from-emerald-900/40 to-slate-900/40 border border-emerald-500/30 rounded-2xl p-6 mb-6 shadow-2xl backdrop-blur-sm">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="bg-emerald-500/20 p-2 rounded-lg text-emerald-400">
                                <span class="text-xl">‚öôÔ∏è</span>
                            </div>
                            <h4 class="font-black text-emerald-100 text-lg uppercase tracking-wider">Intelig√™ncia de
                                Forma√ß√£o de Pre√ßos</h4>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 text-sm">
                            <div class="space-y-3">
                                <p class="text-emerald-300 font-bold flex items-center gap-2">
                                    <span
                                        class="bg-emerald-500 text-white w-5 h-5 flex items-center justify-center rounded-full text-[10px]">1</span>
                                    Defini√ß√£o de Peso (Consumo)
                                </p>
                                <p class="text-slate-300 leading-relaxed">
                                    Para cada cabo, informe o peso em <strong>KG</strong> necess√°rio para fabricar
                                    <strong>1 Rolo de 100 metros</strong>. Este valor √© a "receita" do seu produto.
                                </p>
                            </div>
                            <div class="space-y-3">
                                <p class="text-amber-400 font-bold flex items-center gap-2">
                                    <span
                                        class="bg-amber-500 text-white w-5 h-5 flex items-center justify-center rounded-full text-[10px]">2</span>
                                    C√°lculo Autom√°tico
                                </p>
                                <p class="text-slate-300 leading-relaxed">
                                    O sistema multiplica o <strong>Peso Informado</strong> pela <strong>Cota√ß√£o do
                                        Mercado</strong> (abaixo) para gerar o custo real em tempo real.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700 shadow-xl">
                        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 gap-4">
                            <h3 class="font-bold text-xl text-white flex items-center gap-2">
                                <span class="text-emerald-500">üìä</span> Tabela de Pre√ßos & Margens
                            </h3>
                            <button onclick="salvarPrecos()"
                                class="w-full lg:w-auto px-8 py-3 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold text-sm shadow-lg shadow-blue-900/40 transition-all flex items-center justify-center gap-2">
                                üíæ Salvar Todas as Altera√ß√µes
                            </button>
                        </div>

                        <!-- Grid de Cota√ß√µes -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div
                                class="bg-slate-900/50 p-4 rounded-xl border border-slate-700 hover:border-emerald-500/50 transition-all group">
                                <label
                                    class="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest group-hover:text-emerald-400">Cota√ß√£o
                                    Alum√≠nio (R$/KG)</label>
                                <input type="number" step="0.01" id="cotacaoAl" onchange="renderizarTabelaPrecos()"
                                    class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-emerald-400 font-black text-lg outline-none focus:border-emerald-500 text-center"
                                    placeholder="0,00">
                            </div>
                            <div
                                class="bg-slate-900/50 p-4 rounded-xl border border-slate-700 hover:border-orange-500/50 transition-all group">
                                <label
                                    class="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest group-hover:text-orange-400">Cota√ß√£o
                                    Cobre (R$/KG)</label>
                                <input type="number" step="0.01" id="cotacaoCu" onchange="renderizarTabelaPrecos()"
                                    class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-orange-400 font-black text-lg outline-none focus:border-orange-500 text-center"
                                    placeholder="0,00">
                            </div>
                            <div
                                class="bg-slate-900/50 p-4 rounded-xl border border-slate-700 hover:border-amber-500/50 transition-all group">
                                <label
                                    class="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest group-hover:text-amber-400">Cota√ß√£o
                                    PVC (R$/KG)</label>
                                <input type="number" step="0.01" id="cotacaoPvc" onchange="renderizarTabelaPrecos()"
                                    class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-amber-300 font-black text-lg outline-none focus:border-amber-500 text-center"
                                    placeholder="0,00">
                            </div>
                        </div>

                        <div class="mb-4">
                            <input type="text" id="buscaPrecos" oninput="renderizarTabelaPrecos()"
                                placeholder="Buscar produto para definir pre√ßo..."
                                class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-sm outline-none focus:border-emerald-500">
                        </div>

                        <div class="overflow-x-auto custom-scroll max-h-[500px]">
                            <table class="w-full text-left text-sm">
                                <thead
                                    class="bg-slate-900/50 text-[10px] font-black uppercase text-slate-400 sticky top-0 z-10">
                                    <tr>
                                        <th class="p-3 bg-slate-900">Produto</th>
                                        <th class="p-3 bg-slate-900 text-center">Alum√≠nio (KG/R$)</th>
                                        <th class="p-3 bg-slate-900 text-center">Cobre (KG/R$)</th>
                                        <th class="p-3 bg-slate-900 text-center">PVC (KG/R$)</th>
                                        <th class="p-3 bg-slate-900 text-center">Pre√ßo Venda</th>
                                        <th class="p-3 bg-slate-900 text-center">Margem</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaPrecos" class="divide-y divide-slate-700">
                                    <!-- Preenchido via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: HISTORICO DE PEDIDOS -->
        <div id="tab-historico-pedidos" class="hidden space-y-6">
            <div class="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
                <h4 class="font-bold text-blue-400 mb-1 text-sm">üí° Hist√≥rico de Pedidos:</h4>
                <p class="text-xs text-slate-300">Consulte pedidos antigos aqui. Voc√™ pode usar o bot√£o **üì• PDF**
                    para baixar novamente os documentos de qualquer pedido que tenha sido salvo com sucesso.</p>
            </div>
            <div class="glass rounded-2xl p-6">
                <h3 class="font-bold text-lg text-emerald-400 mb-6">Hist√≥rico de Pedidos</h3>

                <!-- Filtros -->
                <div
                    class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                    <div class="md:col-span-2">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Buscar Cliente ou
                            ID</label>
                        <input type="text" id="filtroHistBusca" placeholder="Nome do cliente ou ID do pedido..."
                            class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-sm outline-none focus:border-emerald-500">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Data In√≠cio</label>
                        <input type="date" id="filtroHistDataIni"
                            class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-sm outline-none focus:border-emerald-500">
                    </div>
                    <div class="flex items-end">
                        <button onclick="renderizarHistoricoPedidos()"
                            class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-bold text-sm transition-all">
                            Filtrar
                        </button>
                    </div>
                </div>

                <!-- Tabela -->
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-900/50 text-[10px] font-black uppercase text-slate-400">
                            <tr>
                                <th class="p-3">Data</th>
                                <th class="p-3">ID Pedido</th>
                                <th class="p-3">Cliente</th>
                                <th class="p-3 text-center">Itens</th>
                                <th class="p-3 text-right">Total R$</th>
                                <th class="p-3 text-center">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaHistoricoPedidos" class="divide-y divide-slate-700 text-slate-300">
                            <tr>
                                <td colspan="6" class="p-4 text-center">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div> <!-- Fecha tab-historico-pedidos -->

        </div> <!-- Fecha Container Principal (lg:ml-72) -->

        <!-- Modal Configuracao -->
        <div id="modalConfig" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center p-4">
            <div class="bg-slate-800 w-full max-w-2xl rounded-3xl p-8">
                <h2 class="text-2xl font-black mb-6 flex items-center gap-2">Configurar Conexao</h2>

                <div class="space-y-4 mb-6">
                    <div class="bg-slate-700 rounded-xl p-4">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">URL do Web App (Apps
                            Script)</label>
                        <input type="text" id="inputWebAppUrl" placeholder="https://script.google.com/macros/s/..."
                            class="w-full bg-slate-600 rounded-lg p-3 text-sm outline-none focus:border-emerald-500 border border-transparent">
                        <p class="text-[10px] text-slate-400 mt-2">
                            Cole aqui a URL gerada quando voce implantou o Apps Script
                        </p>
                    </div>

                    <div class="bg-blue-900/30 border border-blue-500/30 rounded-xl p-4">
                        <h4 class="font-bold text-blue-400 mb-2 text-sm">Como obter a URL:</h4>
                        <ol class="text-xs text-slate-300 space-y-2 list-decimal list-inside">
                            <li>Abra a planilha do Google Sheets</li>
                            <li>Clique em <strong>Extensoes ‚Üí Apps Script</strong></li>
                            <li>Cole o codigo do Apps Script</li>
                            <li>Clique em <strong>Salvar</strong></li>
                            <li>Clique em <strong>Implantar ‚Üí Nova implantacao</strong></li>
                            <li>Tipo: <strong>Aplicativo da Web</strong></li>
                            <li>Execute como: <strong>Eu</strong> | Acesso: <strong>Qualquer pessoa</strong></li>
                            <li>Copie a URL e cole aqui</li>
                        </ol>
                    </div>

                    <div class="bg-slate-700 rounded-xl p-4">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">URL da Planilha
                            (opcional)</label>
                        <input type="text" id="inputSheetsUrl" placeholder="https://docs.google.com/spreadsheets/d/..."
                            class="w-full bg-slate-600 rounded-lg p-3 text-sm outline-none focus:border-emerald-500 border border-transparent">
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="testarConexao()"
                        class="flex-1 bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-bold text-sm">
                        Testar Conexao
                    </button>
                    <button onclick="salvarConfig()"
                        class="flex-1 bg-emerald-600 hover:bg-emerald-500 py-3 rounded-xl font-bold text-sm">
                        Salvar
                    </button>
                    <button onclick="fecharConfig()"
                        class="px-6 bg-slate-600 hover:bg-slate-500 py-3 rounded-xl font-bold text-sm">
                        Fechar
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Novo Produto -->
        <div id="modalNovoProduto"
            class="fixed inset-0 bg-black/80 z-[110] hidden flex items-center justify-center p-4">
            <div
                class="bg-slate-800 w-full max-w-lg rounded-3xl p-8 border border-emerald-500/30 shadow-emerald-900/20 shadow-2xl">
                <h2 class="text-2xl font-black mb-6 flex items-center gap-2 text-emerald-400">
                    <span>‚ûï</span> Cadastrar Novo Produto
                </h2>

                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Codigo / ID
                            (Unico)</label>
                        <input type="number" id="novoID" placeholder="Ex: 1050"
                            class="w-full bg-slate-700 rounded-lg p-3 text-sm outline-none focus:border-emerald-500 border border-transparent">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Categoria</label>
                        <input type="text" id="novoCat" list="datalistCategorias" placeholder="Ex: Fio Flexivel"
                            class="w-full bg-slate-700 rounded-lg p-3 text-sm outline-none focus:border-emerald-500 border border-transparent">
                        <datalist id="datalistCategorias"></datalist>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Descricao do
                            Produto</label>
                        <input type="text" id="novoDesc" placeholder="Ex: Fio Flexivel 2,5mm"
                            class="w-full bg-slate-700 rounded-lg p-3 text-sm outline-none focus:border-emerald-500 border border-transparent">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Cor</label>
                            <select id="novoCor"
                                class="w-full bg-slate-700 rounded-lg p-3 text-sm outline-none focus:border-emerald-500 border border-transparent">
                                <option value="Preto">Preto</option>
                                <option value="Vermelho">Vermelho</option>
                                <option value="Azul">Azul</option>
                                <option value="Verde">Verde</option>
                                <option value="Branco">Branco</option>
                                <option value="Amarelo">Amarelo</option>
                                <option value="Cinza">Cinza</option>
                                <option value="-">-</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Estoque
                                Inicial</label>
                            <input type="number" id="novoQtd" value="0" min="0"
                                class="w-full bg-slate-700 rounded-lg p-3 text-sm outline-none focus:border-emerald-500 border border-transparent">
                        </div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="salvarNovoProduto()"
                        class="flex-1 bg-emerald-600 hover:bg-emerald-500 py-3 rounded-xl font-bold text-sm shadow-lg shadow-emerald-900/50 transition-all">
                        Cadastrar
                    </button>
                    <button onclick="fecharModalNovoProduto()"
                        class="px-6 bg-slate-700 hover:bg-slate-600 py-3 rounded-xl font-bold text-sm transition-all">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="fixed top-4 right-4 z-[200] hidden">
            <div
                class="bg-slate-800 border-l-4 border-emerald-500 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3">
                <span id="toastIcon">‚úÖ</span>
                <span id="toastMessage">Operacao realizada!</span>
            </div>
        </div>

        <!-- Modal Alertas (Sino) -->
        <div id="modalAlertas" class="fixed inset-0 bg-black/50 z-[120] hidden flex justify-end"
            onclick="fecharModalAlertas(event)">
            <div class="bg-slate-800 w-80 h-full p-6 border-l border-slate-700 shadow-2xl overflow-y-auto animate-fade-in-right"
                onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black text-white flex items-center gap-2">
                        <span>üîî</span> Notifica√ß√µes
                    </h2>
                    <button onclick="document.getElementById('modalAlertas').classList.add('hidden')"
                        class="text-slate-400 hover:text-white">‚úï</button>
                </div>

                <div id="listaAlertasModal" class="space-y-3">
                    <p class="text-center text-slate-500 text-sm mt-10">Tudo limpo! Sem alertas.</p>
                </div>
            </div>
        </div>

        <script>
            // ... (resto do script)

            function abrirModalNovoProduto() {
                // Auto-fecha sidebar no mobile
                if (window.innerWidth < 1024) {
                    const sidebar = document.getElementById('sidebar');
                    if (!sidebar.classList.contains('-translate-x-full')) toggleSidebar();
                }

                document.getElementById('modalNovoProduto').classList.remove('hidden');

                // Sugere proximo ID
                const ids = dadosEstoque.map(i => parseInt(i.ID)).filter(n => !isNaN(n));
                const proxId = ids.length ? Math.max(...ids) + 1 : 1;
                document.getElementById('novoID').value = proxId;

                // Preenche datalist de categorias
                const cats = [...new Set(dadosEstoque.map(i => i.CATEGORIA))].filter(Boolean).sort();
                document.getElementById('datalistCategorias').innerHTML = cats.map(c => `<option value="${c}">`).join('');
            }

            function fecharModalNovoProduto() {
                document.getElementById('modalNovoProduto').classList.add('hidden');
            }

            async function salvarNovoProduto() {
                const id = document.getElementById('novoID').value;
                const cat = document.getElementById('novoCat').value;
                const desc = document.getElementById('novoDesc').value;
                const cor = document.getElementById('novoCor').value;
                const qtd = document.getElementById('novoQtd').value;

                if (!id || !cat || !desc) {
                    mostrarToast('Preencha os campos obrigatorios!', 'amber');
                    return;
                }

                // Verifica duplicidade local
                if (dadosEstoque.some(p => p.ID == id)) {
                    mostrarToast('Esse ID ja existe!', 'red');
                    return;
                }

                try {
                    mostrarToast('Cadastrando produto...', 'blue');
                    pararSync(); // PAUSA SYNC

                    const response = await fetch(CONFIG.webAppUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'create',
                            id: id.trim(),
                            categoria: cat,
                            descricao: desc.trim(),
                            cor: cor.trim(),
                            quantidade: parseInt(qtd) || 0
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        mostrarToast('Produto cadastrado com sucesso!', 'emerald');
                        fecharModalNovoProduto();
                        document.getElementById('novoDesc').value = '';
                        sincronizar(); // FOR√áA SYNC
                    } else {
                        throw new Error(result.error || 'Erro ao criar');
                    }

                } catch (error) {
                    console.error(error);
                    mostrarToast('Erro: ' + error.message, 'red');
                } finally {
                    iniciarSync(); // RETOMA SYNC
                }
            }

            // CONFIGURACAO (URL ATUALIZADA)
            const DEFAULT_URL = 'https://script.google.com/macros/s/AKfycbxtvmJJJxLaNTO8ZfMql90LPXKFYiMpTWPJfeAO0uXQyWyschnQZ-eOZYws5JB4P9ed/exec';

            // Migra√ß√£o autom√°tica para o link mais recente (Sempre atualiza para a nova se for script.google)
            if (localStorage.getItem('alx_webapp_url') && localStorage.getItem('alx_webapp_url').includes('script.google.com')) {
                localStorage.setItem('alx_webapp_url', DEFAULT_URL);
            }

            const CONFIG = {
                webAppUrl: localStorage.getItem('alx_webapp_url') || DEFAULT_URL,
                sheetsUrl: localStorage.getItem('alx_sheets_url') || '',
                autoSync: true,
                syncInterval: 2000,
                lastData: null,
                lastHash: null
            };

            const charts = {};


            // --- FUN√á√ÉO DE SINCRONIZA√á√ÉO (RESTORED & FIXED) ---
            async function sincronizar() {
                if (!CONFIG.autoSync) return;

                // SE USUARIO ESTIVER DIGITANDO, NAO ATUALIZA (A menos que n√£o esteja logado, a√≠ precisa syncar os users)
                const tag = document.activeElement.tagName;
                if (currentUser && (tag === 'INPUT' || tag === 'TEXTAREA')) {
                    return;
                }

                const btn = document.getElementById('btnAutoSync');
                // if (btn) btn.classList.add('animate-pulse'); // REMOVIDO: Sem piscar

                try {
                    const url = CONFIG.webAppUrl;
                    if (!url) throw new Error('URL nao configurada');

                    const response = await fetch(url + '?t=' + Date.now());
                    if (!response.ok) throw new Error('Erro HTTP ' + response.status);

                    const data = await response.json();

                    if (data.success) {
                        processarDados(data.data, data.timestamp, data.historico, data.clientes, data.transportadoras, data.pedidos, data.usuarios, data.custos);

                        // ATUALIZA UI DE STATUS
                        const agora = new Date().toLocaleTimeString();
                        const elLast = document.getElementById('lastSyncTime');
                        if (elLast) elLast.innerText = agora;

                        // Atualiza DATA DA PLANILHA
                        if (data.timestamp) {
                            const d = new Date(data.timestamp);
                            const dia = String(d.getDate()).padStart(2, '0');
                            const mes = String(d.getMonth() + 1).padStart(2, '0');
                            const ano = d.getFullYear();
                            const elDate = document.getElementById('sheetDate');
                            if (elDate) elDate.innerText = `${dia}/${mes}/${ano}`;
                        }

                        const elTotal = document.getElementById('totalItemsSheets');
                        if (elTotal) elTotal.innerText = data.total || 0;

                        atualizarStatus('Conectado', 'emerald');
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Erro no sync:', error);
                    // Silencia erros moment√¢neos de rede pra n√£o poluir, ou mostra discreto
                    let msg = error.message;
                    if (msg.includes('Failed to fetch')) msg = 'Conectando...';
                    else if (msg.length > 15) msg = msg.slice(0, 15) + '...';
                    atualizarStatus('Desconectado', 'amber');
                } finally {
                    if (btn) btn.classList.remove('animate-pulse');
                }
            }

            let syncIntervalId = null;

            function iniciarSync() {
                if (syncIntervalId) clearInterval(syncIntervalId);
                if (CONFIG.autoSync) {
                    sincronizar();
                    syncIntervalId = setInterval(sincronizar, CONFIG.syncInterval || 5000);
                }
            }

            function pararSync() {
                if (syncIntervalId) clearInterval(syncIntervalId);
                syncIntervalId = null;
            }

            function processarDados(novosDados, timestamp, historicoRemoto, clientesRemotos, transpsRemotas, pedidosRemotos, usersRemotos, custosRemotos) {
                // NORMALIZA√á√ÉO DE DADOS (Garante chaves maiusculas e leitura correta do Backend)
                const dadosNormalizados = novosDados.map(item => {
                    // Tenta ler de todas as formas poss√≠veis (min√∫sculo vem do script novo)
                    const id = item.id || item.ID || item.Id || item.codigo;
                    if (!id) return null; // Ignora se n√£o tiver ID

                    return {
                        ID: String(id),
                        CATEGORIA: String(item.categoria || item.CATEGORIA || item.Categoria || 'Sem Categoria'),
                        DESCRICAO: String(item.descricao || item.DESCRICAO || item.Descricao || ''),
                        COR: String(item.cor || item.COR || item.Cor || ''),
                        QUANTIDADE: Number(item.quantidade !== undefined ? item.quantidade : (item.QUANTIDADE !== undefined ? item.QUANTIDADE : 0)),
                        DATA: item.data || item.DATA || ''
                    };
                }).filter(i => i !== null); // Remove nulos

                // --- DIFF CHECK ---
                const currentHash = JSON.stringify({
                    estoque: dadosNormalizados,
                    hist: historicoRemoto,
                    cli: clientesRemotos,
                    transp: transpsRemotas,
                    ped: pedidosRemotos || []
                });

                if (CONFIG.lastHash === currentHash) {
                    console.log('Sem mudan√ßas, pulando renderiza√ß√£o.');
                    return;
                }

                CONFIG.lastHash = currentHash;

                // Atualiza Pedidos
                if (pedidosRemotos) {
                    dadosPedidos = pedidosRemotos;
                    renderizarHistoricoPedidos();
                }

                if (usersRemotos) {
                    // Mescla usu√°rios padr√£o com os da planilha
                    USERS_DB = { ...DEFAULT_USERS };
                    usersRemotos.forEach(u => {
                        if (u.login) {
                            const loginKey = String(u.login).toLowerCase().trim();
                            USERS_DB[loginKey] = {
                                pass: String(u.pass || '').trim(),
                                role: String(u.role || '').trim(),
                                name: String(u.name || '').trim()
                            };
                        }
                    });
                    renderizarTabelaUsuarios();
                }

                if (clientesRemotos) dadosClientes = clientesRemotos;
                if (clientesRemotos) dadosClientes = clientesRemotos;
                if (transpsRemotas) dadosTransportadoras = transpsRemotas;

                // --- CUSTOS REMOTOS ---


                if (historicoRemoto && Array.isArray(historicoRemoto)) {
                    historicoMovimentacoes = historicoRemoto.map(h => {
                        const prod = dadosNormalizados.find(p => p.ID == h.id);
                        const desc = prod ? prod.DESCRICAO : 'ID ' + h.id;
                        const cor = prod ? prod.COR : '';

                        return {
                            data: h.data,
                            id: h.id,
                            descricao: desc,
                            cor: cor,
                            tipo: h.tipo,
                            diferenca: h.diferenca,
                            novo: h.saldo_final,
                            obs: h.obs
                        };
                    }).reverse();

                    localStorage.setItem('alx_historico', JSON.stringify(historicoMovimentacoes));
                } else if (CONFIG.lastData) {
                    detectarMudancas(CONFIG.lastData, dadosNormalizados);
                }

                CONFIG.lastData = dadosNormalizados;
                dadosEstoque = dadosNormalizados;

                atualizarDashboard();
                atualizarTabelaEstoque();
                atualizarCategorias();
                atualizarAlertas();
                atualizarFiltros();
                atualizarSelectsEdicao();
                atualizarTabelaHistorico();
                atualizarDatalistsAutocomplete();
                renderizarListasCadastros();

                // --- CUSTOS REMOTOS (Agora no fim para garantir que dadosEstoque esteja carregado) ---
                if (custosRemotos) {
                    // VERIFICAR VERSAO DO SCRIPT
                    if (Array.isArray(custosRemotos)) {
                        mostrarToast('‚ö†Ô∏è ATEN√á√ÉO: Seu Script no Google Sheets est√° desatualizado! Crie uma NOVA VERS√ÉO na Implanta√ß√£o.', 'red', 10000);
                        console.error("Formato de custos inv√°lido (Array). Esperado Objeto. Atualize o Backend.");
                    } else {
                        if (custosRemotos.cotacoes) {
                            cotacaoAl = Number(custosRemotos.cotacoes.al) || 0;
                            cotacaoCu = Number(custosRemotos.cotacoes.cu) || 0;
                            cotacaoPvc = Number(custosRemotos.cotacoes.pvc) || 0;

                            // Atualiza Inputs visuais se existirem
                            if (document.getElementById('cotacaoAl')) document.getElementById('cotacaoAl').value = cotacaoAl;
                            if (document.getElementById('cotacaoCu')) document.getElementById('cotacaoCu').value = cotacaoCu;
                            if (document.getElementById('cotacaoPvc')) document.getElementById('cotacaoPvc').value = cotacaoPvc;
                        }
                        if (custosRemotos.produtos) {
                            dadosPrecos = custosRemotos.produtos;
                        }
                        renderizarTabelaPrecos();
                        mostrarToast('Custos atualizados com sucesso!', 'green');
                    }
                }

                localStorage.setItem('alx_cache_estoque', JSON.stringify(dadosNormalizados));
            }

            function renderizarListasCadastros() {
                const tbodyCli = document.getElementById('listaClientesCadastrados');
                if (tbodyCli) {
                    tbodyCli.innerHTML = dadosClientes.map(c => `
                        <tr class="hover:bg-slate-700/30">
                            <td class="p-3 font-bold text-slate-200">${c.nome}</td>
                            <td class="p-3 text-slate-400">${c.telefone || '-'}</td>
                            <td class="p-3 text-slate-400 font-mono">${c.cnpj || '-'}</td>
                            <td class="p-3 text-right">
                                <button onclick="document.getElementById('clientePedido').value='${c.nome}'; switchTab('pedidos'); verificarAutocompletarCliente();" 
                                    class="text-emerald-500 hover:underline text-[10px] font-bold">Novo Pedido</button>
                            </td>
                        </tr>
                    `).join('') || '<tr><td colspan="4" class="p-4 text-center text-slate-500 italic">Nenhum cliente cadastrado</td></tr>';
                }

                const tbodyTr = document.getElementById('listaTranspCadastradas');
                if (tbodyTr) {
                    tbodyTr.innerHTML = dadosTransportadoras.map(t => `
                        <tr class="hover:bg-slate-700/30">
                            <td class="p-3 font-bold text-slate-200">${t.nome}</td>
                            <td class="p-3 text-slate-400">${t.telefone || '-'}</td>
                            <td class="p-3 text-slate-400">${t.contato || '-'}</td>
                        </tr>
                    `).join('') || '<tr><td colspan="3" class="p-4 text-center text-slate-500 italic">Nenhuma transportadora cadastrada</td></tr>';
                }
            }

            function atualizarDatalistsAutocomplete() {
                const dlCli = document.getElementById('listClientes');
                if (dlCli && dadosClientes.length > 0) {
                    dlCli.innerHTML = dadosClientes.map(c => `<option value="${c.nome}">`).join('');
                }

                const dlTr = document.getElementById('listTransportadoras');
                if (dlTr && dadosTransportadoras.length > 0) {
                    dlTr.innerHTML = dadosTransportadoras.map(t => `<option value="${t.nome}">`).join('');
                }
            }

            function verificarAutocompletarCliente() {
                const input = document.getElementById('clientePedido');
                const nomeDigitado = input.value.trim();
                if (!nomeDigitado) return;

                const cliente = dadosClientes.find(c => c.nome.toLowerCase() === nomeDigitado.toLowerCase());

                if (cliente) {
                    document.getElementById('numCliente').value = cliente.telefone || '';
                    document.getElementById('cnpjPedido').value = cliente.cnpj || '';
                    document.getElementById('iePedido').value = cliente.ie || '';
                    document.getElementById('enderecoPedido').value = cliente.endereco || '';
                    mostrarToast('Dados do cliente carregados!', 'blue');
                }
            }

            function detectarMudancas(dadosAntigos, dadosNovos) {
                const mapaAntigo = {};
                dadosAntigos.forEach(item => mapaAntigo[item.ID] = item);

                dadosNovos.forEach(novo => {
                    const antigo = mapaAntigo[novo.ID];
                    if (antigo && antigo.QUANTIDADE !== novo.QUANTIDADE) {
                        const diferenca = novo.QUANTIDADE - antigo.QUANTIDADE;
                        const movimentacao = {
                            data: new Date().toISOString(),
                            id: novo.ID,
                            categoria: novo.CATEGORIA,
                            descricao: novo.DESCRICAO,
                            cor: novo.COR,
                            anterior: antigo.QUANTIDADE,
                            novo: novo.QUANTIDADE,
                            diferenca: Math.abs(diferenca),
                            tipo: diferenca > 0 ? 'ENTRADA' : 'SAIDA'
                        };

                        historicoMovimentacoes.unshift(movimentacao);
                        if (historicoMovimentacoes.length > 100) {
                            historicoMovimentacoes = historicoMovimentacoes.slice(0, 100);
                        }

                        localStorage.setItem('alx_historico', JSON.stringify(historicoMovimentacoes));
                        incrementarContador();

                        // Notifica√ß√£o de mudan√ßa remota
                        const emoji = diferenca > 0 ? 'üì•' : 'üì§';
                        const corToast = diferenca > 0 ? 'emerald' : 'amber';
                        mostrarToast(`${emoji} ${novo.DESCRICAO} | ${diferenca > 0 ? '+' : ''}${diferenca} ${getUnit(novo)}`, corToast);
                    }
                });
            }

            async function registrarMovimentacao(tipo) {
                const selectId = tipo === 'entrada' ? 'entradaProduto' : 'saidaProduto';
                const qtdId = tipo === 'entrada' ? 'entradaQtd' : 'saidaQtd';
                const obsId = tipo === 'entrada' ? 'entradaObs' : 'saidaObs';

                const id = document.getElementById(selectId).value;
                const qtd = parseInt(document.getElementById(qtdId).value);
                const obs = document.getElementById(obsId).value;

                if (!id || !qtd || qtd <= 0) {
                    mostrarToast('Preencha os campos de produto e quantidade!', 'amber');
                    return;
                }

                if (!obs || obs.trim() === '') {
                    mostrarToast('A observa√ß√£o √© OBRIGAT√ìRIA para registrar movimenta√ß√£o!', 'red');
                    return;
                }

                const produto = dadosEstoque.find(p => p.ID == id);
                if (!produto) {
                    mostrarToast('Produto nao encontrado!', 'red');
                    return;
                }

                const novoValor = tipo === 'entrada' ?
                    produto.QUANTIDADE + qtd :
                    produto.QUANTIDADE - qtd;

                if (novoValor < 0) {
                    mostrarToast('Estoque nao pode ficar negativo!', 'red');
                    return;
                }

                try {
                    mostrarToast('Salvando na planilha...', 'blue');
                    pararSync();

                    const response = await fetch(CONFIG.webAppUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'update',
                            id: id,
                            quantidade: qtd,
                            tipo: tipo,
                            observacao: `${obs.trim()} (Por: ${currentUser ? currentUser.name : 'Desconhecido'})`
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        mostrarToast((tipo === 'entrada' ? 'Entrada' : 'Saida') + ' registrada!', 'emerald');
                        document.getElementById(selectId).value = "";
                        document.getElementById(qtdId).value = "";
                        document.getElementById(obsId).value = "";
                        sincronizar();
                    } else {
                        throw new Error(result.error || 'Erro desconhecido');
                    }

                } catch (error) {
                    console.error('Erro:', error);
                    mostrarToast('Erro: ' + error.message, 'red');
                } finally {
                    iniciarSync();
                }
            }

            async function ajusteDireto() {
                const id = document.getElementById('ajusteProduto').value;
                const novoValor = parseInt(document.getElementById('ajusteQtd').value);
                const motivo = document.getElementById('ajusteMotivo').value;

                if (!id || isNaN(novoValor) || novoValor < 0) {
                    mostrarToast('Preencha produto e quantidade corretamente!', 'amber');
                    return;
                }

                if (!motivo || motivo.trim() === '') {
                    mostrarToast('O motivo do ajuste √© OBRIGAT√ìRIO!', 'red');
                    return;
                }

                try {
                    mostrarToast('Aplicando ajuste...', 'blue');
                    pararSync(); // PAUSA SYNC

                    const response = await fetch(CONFIG.webAppUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8',
                        },
                        body: JSON.stringify({
                            action: 'update',
                            id: id,
                            quantidade: novoValor,
                            tipo: 'ajuste',
                            observacao: motivo.trim()
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        mostrarToast('Ajuste aplicado!', 'emerald');
                        document.getElementById('ajusteProduto').value = '';
                        document.getElementById('ajusteQtd').value = '';
                        document.getElementById('ajusteMotivo').value = '';
                        sincronizar(); // FOR√áA SYNC
                    } else {
                        throw new Error(result.error || 'Erro no ajuste');
                    }

                } catch (error) {
                    mostrarToast('Erro: ' + error.message, 'red');
                } finally {
                    iniciarSync(); // RETOMA SYNC
                }
            }

            // INTERFACE
            function atualizarDashboard() {
                const categorias = {};
                const cores = {};
                let totalGeral = 0;
                let totalZerados = 0;

                let ignorados = JSON.parse(localStorage.getItem('alx_alertas_ignorados') || '[]');
                // Converter para strings
                ignorados = ignorados.map(String);

                dadosEstoque.forEach(item => {
                    const catOriginal = item.CATEGORIA || 'Sem Categoria';
                    const cor = item.COR || 'Sem Cor';
                    const qtd = item.QUANTIDADE || 0;

                    // Normaliza Categoria para chave do Dashboard
                    let catKey = catOriginal;
                    const catLower = catOriginal.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

                    if (catLower.includes('flexivel')) catKey = 'Fio Flexivel';
                    else if (catLower.includes('cabo pp') || catLower.includes('pp')) catKey = 'Cabo PP';
                    else if (catLower.includes('torcido')) catKey = 'Torcido';

                    // Se n√£o for uma das principais, mant√©m original para o gr√°fico de rosca
                    categorias[catKey] = (categorias[catKey] || 0) + qtd;

                    // Para os cards fixos, precisamos somar em vari√°veis espec√≠ficas ou usar o objeto 'categorias' mapeado
                    // O objeto 'categorias' agora tem chaves normalizadas 'Fio Flexivel', 'Cabo PP', 'Torcido' se encontrou match.

                    cores[cor] = (cores[cor] || 0) + qtd;
                    totalGeral += qtd;

                    // Modificado: Se item.QUANTIDADE === 0 E nao estiver ignorado, conta
                    if (qtd === 0 && !ignorados.includes(String(item.ID))) {
                        totalZerados++;
                    }
                });

                document.getElementById('catFioFlexivel').innerText = categorias['Fio Flexivel'] || 0;
                document.getElementById('catCaboPP').innerText = categorias['Cabo PP'] || 0;
                document.getElementById('catTorcido').innerText = categorias['Torcido'] || 0;

                const outros = Object.entries(categorias)
                    .filter(([k]) => !['Fio Flexivel', 'Cabo PP', 'Torcido'].includes(k))
                    .reduce((sum, [, v]) => sum + v, 0);
                document.getElementById('catOutros').innerText = outros;

                document.getElementById('totalGeral').innerHTML = totalGeral + ' <span class="text-sm text-slate-500">un</span>';
                document.getElementById('totalItens').innerText = dadosEstoque.length;
                document.getElementById('totalZerados').innerText = totalZerados;

                atualizarGraficos(categorias, cores);
                atualizarUltimasMovimentacoes();
            }

            function gerarPaletaCores(qtd) {
                const base = [
                    '#10b981', '#3b82f6', '#a855f7', '#f59e0b', '#ef4444',
                    '#ec4899', '#06b6d4', '#84cc16', '#6366f1', '#f97316',
                    '#14b8a6', '#f43f5e', '#0ea5e9', '#8b5cf6', '#eab308',
                    '#d946ef', '#22c55e', '#64748b', '#fb923c', '#c084fc'
                ];

                if (qtd <= base.length) return base.slice(0, qtd);

                const colors = [...base];
                for (let i = base.length; i < qtd; i++) {
                    const hue = (i * 137.508) % 360;
                    colors.push(`hsl(${hue}, 70%, 60%)`);
                }
                return colors;
            }

            function atualizarGraficos(categorias, cores) {
                const ctxCat = document.getElementById('chartCategorias');
                if (charts.categorias) charts.categorias.destroy();

                const labels = Object.keys(categorias);
                const dataValues = Object.values(categorias);
                const bgColors = gerarPaletaCores(labels.length);

                charts.categorias = new Chart(ctxCat, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: dataValues,
                            backgroundColor: bgColors,
                            borderColor: '#1e293b',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: '#cbd5e1',
                                    font: { size: 10 },
                                    boxWidth: 12
                                }
                            }
                        },
                        layout: { padding: 10 }
                    }
                });

                const ctxCor = document.getElementById('chartCores');
                if (charts.cores) charts.cores.destroy();

                const topCores = Object.entries(cores)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                charts.cores = new Chart(ctxCor, {
                    type: 'bar',
                    data: {
                        labels: topCores.map(c => c[0]),
                        datasets: [{
                            label: 'Quantidade',
                            data: topCores.map(c => c[1]),
                            backgroundColor: '#3b82f6'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                            x: { ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            }

            function atualizarTabelaEstoque() {
                const tbody = document.getElementById('tabelaEstoque');
                const termo = (document.getElementById('buscaEstoque')?.value || '').toLowerCase();
                const catFiltro = document.getElementById('filtroCategoria')?.value || '';
                const corFiltro = document.getElementById('filtroCor')?.value || '';

                let filtrados = dadosEstoque.filter(item => {
                    const matchBusca = !termo ||
                        (item.DESCRICAO && item.DESCRICAO.toLowerCase().includes(termo)) ||
                        (item.CATEGORIA && item.CATEGORIA.toLowerCase().includes(termo)) ||
                        (item.COR && item.COR.toLowerCase().includes(termo));

                    const matchCat = !catFiltro || item.CATEGORIA === catFiltro;
                    const matchCor = !corFiltro || item.COR === corFiltro;

                    return matchBusca && matchCat && matchCor;
                });

                tbody.innerHTML = filtrados.map(item => {
                    const status = item.QUANTIDADE === 0 ?
                        '<span class="px-2 py-1 bg-red-500/20 text-red-400 rounded text-xs font-bold">ZERADO</span>' :
                        item.QUANTIDADE < 5 ?
                            '<span class="px-2 py-1 bg-amber-500/20 text-amber-400 rounded text-xs font-bold">BAIXO</span>' :
                            '<span class="px-2 py-1 bg-emerald-500/20 text-emerald-400 rounded text-xs font-bold">OK</span>';

                    return `
                    <tr class="hover:bg-slate-700/50 ${item.QUANTIDADE === 0 ? 'bg-red-900/10' : ''}">
                        <td class="p-4 font-mono text-xs">${item.ID}</td>
                        <td class="p-4"><span class="px-2 py-1 bg-slate-700 rounded text-xs">${item.CATEGORIA}</span></td>
                        <td class="p-4 font-semibold">${item.DESCRICAO}</td>
                        <td class="p-4">
                            <span class="w-3 h-3 rounded-full inline-block mr-2" style="background: ${getCorHex(item.COR)}"></span>
                            ${item.COR}
                        </td>
                        <td class="p-4 text-center font-bold ${item.QUANTIDADE === 0 ? 'text-red-400' : 'text-white'}">${item.QUANTIDADE} ${getUnit(item)}</td>
                        <td class="p-4 text-center">${status}</td>
                        <td class="p-4">
                            <button onclick="editarItem('${item.ID}')" class="text-blue-400 hover:text-blue-300 text-sm font-bold mr-2">Editar</button>
                        </td>
                    </tr>
                `;
                }).join('') || '<tr><td colspan="7" class="p-8 text-center text-slate-500">Nenhum item encontrado</td></tr>';
            }

            function atualizarSelectsEdicao() {
                const selects = ['entradaProduto', 'saidaProduto', 'ajusteProduto'];

                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (!select) return;

                    const valorAtual = select.value;
                    select.innerHTML = '<option value="">Selecione o produto...</option>' +
                        dadosEstoque.map(item => `
                        <option value="${item.ID}">${item.ID} - ${item.DESCRICAO} ${item.COR} (${item.QUANTIDADE} ${getUnit(item)})</option>
                    `).join('');

                    select.value = valorAtual;
                });
            }

            function getCorHex(cor) {
                const cores = {
                    'Vermelho': '#ef4444',
                    'Azul': '#3b82f6',
                    'Verde': '#10b981',
                    'Preto': '#1f2937',
                    'Branco': '#f3f4f6',
                    'Amarelo': '#f59e0b'
                };
                return cores[cor] || '#94a3b8';
            }

            function mostrarToast(mensagem, cor) {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toastMessage');

                toast.classList.remove('hidden');
                toastMessage.innerText = mensagem;

                const cores = {
                    emerald: 'border-emerald-500',
                    red: 'border-red-500',
                    amber: 'border-amber-500',
                    blue: 'border-blue-500'
                };

                toast.querySelector('div').className = 'bg-slate-800 border-l-4 ' + (cores[cor] || 'border-emerald-500') + ' text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3';

                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 3000);
            }

            function abrirPlanilhaGoogle() {
                if (CONFIG.sheetsUrl) {
                    window.open(CONFIG.sheetsUrl, '_blank');
                } else {
                    mostrarToast('URL da planilha nao configurada!', 'amber');
                }
            }

            function switchSubTab(subTab) {
                // Esconde todas sub-abas
                ['entrada', 'saida', 'ajuste'].forEach(t => {
                    const el = document.getElementById('subtab-' + t);
                    if (el) el.classList.add('hidden');

                    // Reseta estilo dos bot√µes
                    const btn = document.getElementById('subnav-' + t);
                    if (btn) {
                        btn.classList.remove('bg-white', 'text-slate-900');
                        btn.classList.add('text-slate-400');
                    }
                });

                // Mostra a selecionada
                const selected = document.getElementById('subtab-' + subTab);
                if (selected) selected.classList.remove('hidden');

                // Estiliza o bot√£o selecionado
                const activeBtn = document.getElementById('subnav-' + subTab);
                if (activeBtn) {
                    activeBtn.classList.remove('text-slate-400');
                    activeBtn.classList.add('bg-white', 'text-slate-900');
                }
            }

            function editarItem(id) {
                const item = dadosEstoque.find(p => p.ID == id);
                if (!item) return;

                document.getElementById('ajusteProduto').value = id;
                document.getElementById('ajusteQtd').value = item.QUANTIDADE;
                document.getElementById('ajusteMotivo').value = '';

                switchTab('operacoes');
                switchSubTab('ajuste'); // J√° abre direto na sub-aba de ajuste
                mostrarToast('Editando: ' + item.DESCRICAO, 'blue');
            }

            function switchTab(tabId) {
                // Auto-fecha sidebar no mobile
                if (window.innerWidth < 1024) {
                    const sidebar = document.getElementById('sidebar');
                    if (!sidebar.classList.contains('-translate-x-full')) toggleSidebar();
                }

                document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
                document.getElementById('tab-' + tabId).classList.remove('hidden');
                document.querySelectorAll('[id^="nav-"]').forEach(el => el.classList.remove('tab-active', 'bg-slate-700'));

                if (tabId === 'operacoes') {
                    document.getElementById('nav-' + tabId).classList.add('bg-slate-700', 'tab-active');
                    // Se estiver abrindo opera√ß√µes e nenhuma sub-aba estiver vis√≠vel, abre 'Entrada' por padr√£o
                    const algumaSubVisivel = ['entrada', 'saida', 'ajuste'].some(t => !document.getElementById('subtab-' + t).classList.contains('hidden'));
                    if (!algumaSubVisivel) switchSubTab('entrada');
                } else {
                    document.getElementById('nav-' + tabId).classList.add('bg-slate-700', 'tab-active');
                }

                const titulos = {
                    dashboard: 'Painel de Controle',
                    estoque: 'Estoque Completo',
                    categorias: 'Por Categoria',
                    movimentacoes: 'Movimenta√ß√µes',
                    operacoes: 'Gerenciar Estoque',
                    alertas: 'Alertas Cr√≠ticos',
                    pedidos: 'Gerar Novo Pedido (PDF)',
                    cadastros: 'Cadastros Gerais',
                    'historico-pedidos': 'Hist√≥rico de Pedidos'
                };
                document.getElementById('pageTitle').innerText = titulos[tabId] || 'ALX CABOS';

                // Renderiza lista se for a aba pedidos
                if (tabId === 'pedidos') {
                    renderizarListaProdutosPedido();
                }

                if (tabId === 'historico-pedidos') {
                    renderizarHistoricoPedidos();
                }
            }

            function openConfig() {
                // Auto-fecha sidebar no mobile
                if (window.innerWidth < 1024) {
                    const sidebar = document.getElementById('sidebar');
                    if (!sidebar.classList.contains('-translate-x-full')) toggleSidebar();
                }

                document.getElementById('modalConfig').classList.remove('hidden');
                document.getElementById('inputWebAppUrl').value = CONFIG.webAppUrl;
                document.getElementById('inputSheetsUrl').value = CONFIG.sheetsUrl;
            }

            function limparCacheEmergencia() {
                if (!confirm('üßπ LIMPAR CACHE\n\nIsso vai:\n‚úÖ For√ßar atualiza√ß√£o com a URL mais recente\n‚úÖ Limpar dados antigos salvos\n‚úÖ Recarregar a p√°gina automaticamente\n\nDeseja continuar?')) {
                    return;
                }

                try {
                    const urlAtual = CONFIG.webAppUrl || DEFAULT_URL;
                    localStorage.clear();
                    localStorage.setItem('alx_webapp_url', urlAtual);
                    alert('‚úÖ Cache limpo!\n\nA p√°gina ser√° recarregada agora.');
                    window.location.reload(true);
                } catch (err) {
                    alert('‚ùå Erro ao limpar cache: ' + err.message);
                }
            }

            function fecharConfig() {
                document.getElementById('modalConfig').classList.add('hidden');
            }

            async function testarConexao() {
                const url = document.getElementById('inputWebAppUrl').value.trim();
                if (!url) {
                    mostrarToast('Informe a URL primeiro!', 'amber');
                    return;
                }

                try {
                    mostrarToast('Testando...', 'blue');
                    // Adiciona no-cors mode falha silenciosamente, entao usamos normal
                    // Se der erro de CORS, vai cair no catch
                    const response = await fetch(url + '?t=' + Date.now());

                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        if (result.total === 0) {
                            alert('‚ö†Ô∏è CONECTADO, MAS SEM DADOS!\n\nO sistema encontrou 0 itens.\n\nMOTIVO PROV√ÅVEL:\nO script busca uma aba chamada examente "Estoque".\n\nSe seus dados est√£o em "P√°gina1" ou outro nome, o sistema criou uma nova aba "Estoque" vazia.\n\nSOLU√á√ÉO:\n1. Abra sua planilha do Google.\n2. Procure a aba "Estoque" (deve estar vazia).\n3. Copie seus produtos para essa aba "Estoque".\n4. Apague a aba antiga se quiser.');
                            mostrarToast('Conectado, mas aba "Estoque" est√° vazia.', 'amber');
                        } else {
                            mostrarToast('Conectado! ' + result.total + ' itens encontrados.', 'emerald');
                        }
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error(error);
                    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        alert('‚ö†Ô∏è ERRO DE CONEX√ÉO DETECTADO!\n\nIsso geralmente acontece por dois motivos:\n\n1. ERRO NO SCRIPT: O c√≥digo antigo tinha um bug que travava o Google (Erro 500).\n2. LINK DESATUALIZADO: Voc√™ salvou o c√≥digo novo, mas n√£o gerou uma "Nova Vers√£o".\n\nüî¥ SOLU√á√ÉO DEFINITIVA:\n1. V√° no Apps Script e cole o c√≥digo novo (se ainda n√£o colou).\n2. Clique em "Implantar" > "Nova implanta√ß√£o".\n3. Copie a NOVA URL que ele gerar.\n4. Cole a nova URL aqui e salve.');
                        mostrarToast('Erro: Gere um NOVO LINK no Apps Script', 'red');
                    } else {
                        mostrarToast('Erro: ' + error.message, 'red');
                    }
                }
            }

            function salvarConfig() {
                try {
                    const inputUrl = document.getElementById('inputWebAppUrl');
                    const inputSheets = document.getElementById('inputSheetsUrl');

                    if (!inputUrl) { alert('Erro: Campo URL nao encontrado!'); return; }

                    const url = inputUrl.value.trim();
                    const sheetsUrl = inputSheets ? inputSheets.value.trim() : '';

                    if (!url) {
                        mostrarToast('Informe a URL do Web App!', 'amber');
                        return;
                    }

                    CONFIG.webAppUrl = url;
                    CONFIG.sheetsUrl = sheetsUrl;
                    localStorage.setItem('alx_webapp_url', url);
                    localStorage.setItem('alx_sheets_url', sheetsUrl);

                    iniciarSync();
                    fecharConfig();
                    mostrarToast('Configuracao salva! Sincronizacao iniciada.', 'emerald');
                } catch (err) {
                    console.error(err);
                    mostrarToast('Erro ao Salvar: ' + err.message, 'red');
                }
            }

            function toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');

                if (sidebar.classList.contains('-translate-x-full')) {
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                } else {
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                }
            }

            function forceSync() {
                sincronizar();
                mostrarToast('Sincronizacao forcada!', 'blue');
            }

            function toggleAutoSync() {
                CONFIG.autoSync = !CONFIG.autoSync;
                const btn = document.getElementById('btnAutoSync');

                if (CONFIG.autoSync) {
                    iniciarSync();
                    btn.innerHTML = 'Pausar';
                    btn.classList.remove('bg-slate-600');
                    btn.classList.add('bg-emerald-600');
                } else {
                    pararSync();
                    btn.innerHTML = 'Retomar';
                    btn.classList.remove('bg-emerald-600');
                    btn.classList.add('bg-slate-600');
                }
            }

            function atualizarStatus(texto, cor) {
                const el = document.getElementById('connectionStatus');
                const cores = {
                    emerald: 'text-emerald-400',
                    red: 'text-red-400',
                    amber: 'text-amber-400'
                };

                el.innerHTML = `
                <span class="live-dot bg-${cor}-500"></span>
                <span class="${cores[cor] || 'text-slate-400'}">${texto}</span>
            `;
            }

            function incrementarContador() {
                const hoje = new Date().toDateString();
                const chave = 'alx_changes_' + hoje;
                const atual = parseInt(localStorage.getItem(chave) || '0');
                localStorage.setItem(chave, atual + 1);
                document.getElementById('changesToday').innerText = atual + 1;
            }

            function atualizarContadores() {
                const hoje = new Date().toDateString();
                document.getElementById('changesToday').innerText = localStorage.getItem('alx_changes_' + hoje) || '0';
            }

            function exportarDados() {
                const dados = {
                    estoque: dadosEstoque,
                    historico: historicoMovimentacoes,
                    exportado_em: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ALX_Estoque_' + new Date().toISOString().split('T')[0] + '.json';
                a.click();

                mostrarToast('Dados exportados!', 'emerald');
            }

            function atualizarFiltros() {
                const categorias = [...new Set(dadosEstoque.map(i => i.CATEGORIA))].filter(Boolean).sort();
                const cores = [...new Set(dadosEstoque.map(i => i.COR))].filter(Boolean).sort();

                const selCat = document.getElementById('filtroCategoria');
                const selCor = document.getElementById('filtroCor');

                if (selCat && selCat.options.length <= 1) {
                    categorias.forEach(cat => {
                        selCat.innerHTML += '<option value="' + cat + '">' + cat + '</option>';
                    });
                }

                if (selCor && selCor.options.length <= 1) {
                    cores.forEach(cor => {
                        selCor.innerHTML += '<option value="' + cor + '">' + cor + '</option>';
                    });
                }
            }

            function atualizarCategorias() {
                const container = document.getElementById('cardsCategorias');
                if (!container) return;

                const categorias = {};
                dadosEstoque.forEach(item => {
                    const cat = item.CATEGORIA || 'Sem Categoria';
                    if (!categorias[cat]) categorias[cat] = [];
                    categorias[cat].push(item);
                });

                container.innerHTML = Object.entries(categorias).map(([cat, itens]) => {
                    const total = itens.reduce((s, i) => s + (i.QUANTIDADE || 0), 0);
                    const zerados = itens.filter(i => i.QUANTIDADE === 0).length;

                    return `
                    <div class="glass rounded-2xl p-5">
                        <div class="flex justify-between items-start mb-4">
                            <h4 class="font-bold text-lg">${cat}</h4>
                            <span class="text-2xl font-black text-emerald-400">${total}</span>
                        </div>
                        <p class="text-xs text-slate-400 mb-3">${itens.length} itens diferentes</p>
                        ${zerados > 0 ? '<p class="text-xs text-red-400 mb-3">' + zerados + ' item(ns) zerado(s)</p>' : ''}
                        <div class="space-y-2 max-h-48 overflow-y-auto custom-scroll">
                            ${itens.slice(0, 5).map(i => `
                                <div class="flex justify-between text-sm p-2 bg-slate-800 rounded ${i.QUANTIDADE === 0 ? 'border-l-2 border-red-500' : ''}">
                                    <span class="truncate">${i.DESCRICAO} ${i.COR}</span>
                                    <span class="font-bold ${i.QUANTIDADE === 0 ? 'text-red-400' : ''}">${i.QUANTIDADE} ${getUnit(i)}</span>
                                </div>
                            `).join('')}
                            ${itens.length > 5 ? '<p class="text-xs text-slate-500 text-center">+' + (itens.length - 5) + ' itens...</p>' : ''}
                        </div>
                    </div>
                `;
                }).join('');
            }

            function atualizarAlertas() {
                let ignorados = JSON.parse(localStorage.getItem('alx_alertas_ignorados') || '[]');

                // 1. AUTO-RECUPERACAO: Se o estoque voltou a ser positivo, remove da lista de ignorados
                // Para que se zerar de novo no futuro, avise novamente.
                const recuperados = ignorados.filter(id => {
                    const item = dadosEstoque.find(p => p.ID == id);
                    // CORRECAO: S√≥ recupera se o estoque estiver BEM (acima de 5). 
                    // Se estiver baixo (ex: 3), continua ignorado se o usu√°rio quis assim.
                    return item && item.QUANTIDADE > 5;
                });

                if (recuperados.length > 0) {
                    ignorados = ignorados.filter(id => !recuperados.includes(id));
                    localStorage.setItem('alx_alertas_ignorados', JSON.stringify(ignorados));
                }

                // 2. SEPARA OS DADOS
                const alertasAtivos = [];
                const alertasOcultos = [];

                dadosEstoque.forEach(item => {
                    if (item.QUANTIDADE <= 5) {
                        const dadosFormatados = { ...item, tipo: item.QUANTIDADE === 0 ? 'ZERADO' : 'BAIXO' };
                        // For√ßa conversoes para string na compara√ß√£o
                        if (ignorados.map(String).includes(String(item.ID))) {
                            alertasOcultos.push(dadosFormatados);
                        } else {
                            alertasAtivos.push(dadosFormatados);
                        }
                    }
                });

                // 3. RENDERIZA ATIVOS
                const container = document.getElementById('listaAlertas');
                const containerModal = document.getElementById('listaAlertasModal'); // ADDED: Modal Container
                const badge = document.getElementById('headerAlertBadge');

                if (badge) {
                    badge.innerText = alertasAtivos.length;
                    badge.classList.toggle('hidden', alertasAtivos.length === 0);

                    // Atualiza badge mobile tamb√©m
                    const mobileBadge = document.getElementById('mobileAlertBadge');
                    if (mobileBadge) {
                        mobileBadge.innerText = alertasAtivos.length;
                        mobileBadge.classList.toggle('hidden', alertasAtivos.length === 0);
                    }
                }

                if (container || containerModal) {
                    let html = alertasAtivos.map(item => `
                    <div class="flex items-center justify-between p-4 bg-slate-800 rounded-xl border-l-4 ${item.tipo === 'ZERADO' ? 'border-red-500 bg-red-900/10' : 'border-amber-500 bg-amber-900/10'} transition-all hover:scale-[1.01]">
                        <div>
                            <p class="font-bold text-sm">${item.DESCRICAO}</p>
                            <p class="text-[10px] text-slate-400">${item.CATEGORIA} - ${item.COR}</p>
                        </div>
                        <div class="text-right flex items-center gap-3">
                            <span class="px-2 py-1 rounded text-[10px] font-bold ${item.tipo === 'ZERADO' ? 'bg-red-500/20 text-red-400' : 'bg-amber-500/20 text-amber-400'}">
                                ${item.QUANTIDADE} ${getUnit(item)}
                            </span>
                            <button onclick="ignorarAlerta('${item.ID}')" title="Marcar como visto"
                                class="w-8 h-8 rounded-full bg-slate-700 hover:bg-emerald-600 hover:text-white text-slate-400 flex items-center justify-center transition-all">
                                ‚úÖ
                            </button>
                        </div>
                    </div>
                `).join('');

                    if (alertasAtivos.length === 0) {
                        html = '<div class="text-center py-8 text-slate-500 text-sm italic">Nenhum alerta pendente</div>';
                    }

                    // 4. RENDERIZA OCULTOS (SE TIVER)
                    if (alertasOcultos.length > 0) {
                        html += `
                        <div class="mt-8 pt-6 border-t border-slate-700">
                            <h4 class="font-bold text-slate-500 text-[10px] uppercase mb-4 flex items-center gap-2">
                                <span>üëÅÔ∏è‚Äçüó®Ô∏è</span> Itens Vistos (${alertasOcultos.length})
                            </h4>
                            <div class="space-y-2 opacity-60 hover:opacity-100 transition-opacity">
                                ${alertasOcultos.map(item => `
                                    <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                                        <div class="flex items-center gap-2 overflow-hidden">
                                            <span class="text-[9px] font-bold ${item.tipo === 'ZERADO' ? 'text-red-500' : 'text-amber-500'}">${item.tipo}</span>
                                            <span class="text-xs text-slate-400 truncate max-w-[120px]">${item.DESCRICAO}</span>
                                        </div>
                                        <button onclick="restaurarAlerta('${item.ID}')" title="Restaurar Alerta" class="text-[10px] text-blue-400 hover:text-blue-300 font-bold">
                                            Restaurar
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    }

                    if (container) container.innerHTML = html;
                    if (containerModal) containerModal.innerHTML = html;
                }
            }

            function restaurarAlerta(id) {
                let ignorados = JSON.parse(localStorage.getItem('alx_alertas_ignorados') || '[]');
                // Garante que compara string com string
                ignorados = ignorados.map(String).filter(i => i !== String(id));
                localStorage.setItem('alx_alertas_ignorados', JSON.stringify(ignorados));
                atualizarAlertas();
                atualizarDashboard(); // Atualiza contadores no dashboard/sidebar
                mostrarToast('Alerta restaurado!', 'blue');
            }

            function ignorarAlerta(id) {
                let ignorados = JSON.parse(localStorage.getItem('alx_alertas_ignorados') || '[]');
                // Converte tudo para string para evitar duplicatas e inconsist√™ncias
                ignorados = ignorados.map(String);

                if (!ignorados.includes(String(id))) {
                    ignorados.push(String(id));
                    localStorage.setItem('alx_alertas_ignorados', JSON.stringify(ignorados));
                    atualizarAlertas();
                    atualizarDashboard(); // Atualiza contadores no dashboard
                    mostrarToast('Alerta marcado como visto!', 'emerald');
                }
            }

            function limparIgnorados() {
                localStorage.removeItem('alx_alertas_ignorados');
                atualizarAlertas();
                atualizarDashboard(); // Resetar contadores
                mostrarToast('Alertas restaurados!', 'blue');
            }



            // ...

            function atualizarTabelaHistorico() {
                const tbody = document.getElementById('tabelaMovimentacoes');
                if (!tbody) return;

                const isUser = currentUser && currentUser.role === ROLES.USER;

                // Filtra para mostrar apenas as dele se for USER
                // Como n√£o temos coluna de usu√°rio dedicada, buscamos no campo OBS
                const filtradas = isUser ?
                    historicoMovimentacoes.filter(m => (m.obs || '').includes(currentUser.name)) :
                    historicoMovimentacoes;

                tbody.innerHTML = filtradas.map(mov => {
                    const t = mov.tipo.toUpperCase();
                    const isNeg = t === 'SAIDA' || t === 'PEDIDO' || t === 'AJUSTE_SAIDA';
                    const isPos = t === 'ENTRADA' || t === 'CRIACAO' || t === 'AJUSTE_ENTRADA';

                    const tipoClass = {
                        'ENTRADA': 'bg-emerald-500/20 text-emerald-400',
                        'SAIDA': 'bg-red-500/20 text-red-400',
                        'PEDIDO': 'bg-orange-500/20 text-orange-400',
                        'AJUSTE': 'bg-blue-500/20 text-blue-400',
                        'AJUSTE_ENTRADA': 'bg-emerald-500/20 text-emerald-400',
                        'AJUSTE_SAIDA': 'bg-red-500/20 text-red-400',
                        'CRIACAO': 'bg-purple-500/20 text-purple-400'
                    }[t] || 'bg-slate-700 text-slate-400';

                    const labelTipo = t.includes('AJUSTE') ? 'AJUSTE' : t;
                    const prevSaldo = isNeg ? (mov.novo + mov.diferenca) : (mov.novo - mov.diferenca);

                    return `
                    <tr class="hover:bg-slate-700/50 transition-colors">
                        <td class="p-4 text-xs text-slate-400">
                            ${new Date(mov.data).toLocaleString('pt-BR')}
                        </td>
                        <td class="p-4">
                            <p class="font-bold text-sm">${mov.descricao}</p>
                            <p class="text-xs text-slate-500">${mov.cor || ''}</p>
                            ${mov.obs ? '<p class="text-[10px] text-slate-400 italic">' + mov.obs + '</p>' : ''}
                        </td>
                        <td class="p-4 text-center text-xs text-slate-500">
                            ${prevSaldo} ${getUnit(mov)}
                        </td>
                        <td class="p-4 text-center font-bold text-white">
                            ${mov.novo} ${getUnit(mov)}
                        </td>
                        <td class="p-4 text-center font-bold">
                            <span class="${isNeg ? 'text-red-400' : 'text-emerald-400'}">
                                ${isNeg ? '-' : '+'}${mov.diferenca}
                            </span>
                        </td>
                        <td class="p-4">
                            <span class="px-2 py-1 rounded text-[10px] font-black uppercase ${tipoClass}">
                                ${labelTipo}
                            </span>
                        </td>
                    </tr>
                `;
                }).join('') || '<tr><td colspan="6" class="p-8 text-center text-slate-500">Nenhuma movimentacao registrada ainda</td></tr>';

                atualizarUltimasMovimentacoes();
            }

            function atualizarUltimasMovimentacoes() {
                const container = document.getElementById('ultimasMovimentacoes');
                if (!container || historicoMovimentacoes.length === 0) return;

                const isUser = currentUser && currentUser.role === ROLES.USER;
                const filtradas = isUser ?
                    historicoMovimentacoes.filter(m => (m.obs || '').includes(currentUser.name)) :
                    historicoMovimentacoes;

                container.innerHTML = filtradas.slice(0, 10).map(mov => `
                <div class="flex items-center justify-between p-3 bg-slate-800 rounded-lg border-l-4 ${mov.tipo === 'ENTRADA' ? 'border-emerald-500' : ['SAIDA', 'PEDIDO'].includes(mov.tipo.toUpperCase()) ? 'border-red-500' : 'border-blue-500'} change-highlight">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">${mov.tipo === 'ENTRADA' ? '+' : ['SAIDA', 'PEDIDO'].includes(mov.tipo.toUpperCase()) ? '-' : '‚úèÔ∏è'}</span>
                        <div>
                            <p class="font-bold text-sm">${mov.descricao} ${mov.cor}</p>
                            <p class="text-xs text-slate-400">${new Date(mov.data).toLocaleString('pt-BR')}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold ${mov.tipo === 'ENTRADA' ? 'text-emerald-400' : ['SAIDA', 'PEDIDO'].includes(mov.tipo.toUpperCase()) ? 'text-red-400' : 'text-blue-400'}">
                            ${['SAIDA', 'PEDIDO'].includes(mov.tipo.toUpperCase()) ? '-' : '+'}${mov.diferenca}
                        </p>
                        <p class="text-[10px] text-slate-500">Saldo: ${mov.novo}</p>
                    </div>
                </div>
            `).join('');
            }

            function filtrarEstoque() {
                atualizarTabelaEstoque();
            }

            // --- M√ìDULO DE PEDIDOS E PRE√áOS ---

            let carrinhoC = [];
            let dadosPrecos = JSON.parse(localStorage.getItem('alx_prices') || '{}');

            function switchSubTabPedido(tab) {
                document.getElementById('subtab-ped-novo').classList.add('hidden');
                document.getElementById('subtab-ped-precos').classList.add('hidden');

                document.getElementById('subnav-ped-novo').className = 'px-4 py-1.5 rounded-md text-xs font-bold text-slate-400 hover:text-white transition-all';
                document.getElementById('subnav-ped-precos').className = 'px-4 py-1.5 rounded-md text-xs font-bold text-slate-400 hover:text-white transition-all';

                if (tab === 'novo') {
                    document.getElementById('subtab-ped-novo').classList.remove('hidden');
                    document.getElementById('subnav-ped-novo').className = 'px-4 py-1.5 rounded-md text-xs font-bold bg-emerald-600 text-white transition-all';
                } else {
                    document.getElementById('subtab-ped-precos').classList.remove('hidden');
                    document.getElementById('subnav-ped-precos').className = 'px-4 py-1.5 rounded-md text-xs font-bold bg-blue-600 text-white transition-all';
                    renderizarTabelaPrecos();
                }
            }

            function getPrecos(id) {
                const p = dadosPrecos[id] || {};
                const itemInfo = dadosEstoque.find(x => x.ID == id) || {};
                const unit = getUnit(itemInfo);
                const desc = (itemInfo.DESCRICAO || '').toLowerCase();

                let fator = 1;
                if (unit === 'mt') {
                    fator = 100;
                } else if (unit === 'un') {
                    // Tenta extrair o comprimento do chicote da descri√ß√£o (ex: "Chicote 2 metros" ou "Chicote 2m")
                    const lengthMatch = desc.match(/(\d+[.,]?\d*)\s*(metro|m\b)/);
                    const length = lengthMatch ? parseFloat(lengthMatch[1].replace(',', '.')) : 1;
                    fator = 100 / length; // Se o chicote tem 2m, fator √© 50. (Peso 100m / 50 = Peso 2m)
                }

                // Obtem cota√ß√µes atuais (dos inputs se existirem, ou globais)
                const iAl = document.getElementById('cotacaoAl');
                const iCu = document.getElementById('cotacaoCu');
                const iPvc = document.getElementById('cotacaoPvc');

                const cAl = iAl ? (parseFloat(iAl.value) || 0) : (cotacaoAl || 0);
                const cCu = iCu ? (parseFloat(iCu.value) || 0) : (cotacaoCu || 0);
                const cPvc = iPvc ? (parseFloat(iPvc.value) || 0) : (cotacaoPvc || 0);

                // Ajusta pesos base (converte para peso por UNIDADE de venda: metro, pe√ßa ou rolo)
                const pesoAl = (parseFloat(p.pesoAl) || 0) / fator;
                const pesoCu = (parseFloat(p.pesoCu) || 0) / fator;
                const pesoPvc = (parseFloat(p.pesoPvc) || 0) / fator;

                const custoAl = pesoAl * cAl;
                const custoCu = pesoCu * cCu;
                const custoPvc = pesoPvc * cPvc;

                return {
                    ...p,
                    pesoAl, pesoCu, pesoPvc,
                    custoAl, custoCu, custoPvc,
                    custo: custoAl + custoCu + custoPvc,
                    venda: (parseFloat(p.venda) || 0) / fator
                };
            }

            // Vari√°veis Globais de Cota√ß√£o
            // Vari√°veis Globais de Cota√ß√£o
            let cotacaoAl = 0;
            let cotacaoCu = 0;
            let cotacaoPvc = 0;

            function carregarCotacoes() {
                const savedCotacoes = JSON.parse(localStorage.getItem('alx_cotacoes') || '{}');
                cotacaoAl = savedCotacoes.al || 0;
                cotacaoCu = savedCotacoes.cu || 0;
                cotacaoPvc = savedCotacoes.pvc || 0;

                const elAl = document.getElementById('cotacaoAl');
                const elCu = document.getElementById('cotacaoCu');
                const elPvc = document.getElementById('cotacaoPvc');

                if (elAl) elAl.value = cotacaoAl > 0 ? cotacaoAl : '';
                if (elCu) elCu.value = cotacaoCu > 0 ? cotacaoCu : '';
                if (elPvc) elPvc.value = cotacaoPvc > 0 ? cotacaoPvc : '';
            }

            // Inicializa cotacoes se possivel
            setTimeout(carregarCotacoes, 500);

            function getUnit(item) {
                const desc = (item.DESCRICAO || item.descricao || '').toLowerCase();
                const cat = (item.CATEGORIA || item.categoria || '').toLowerCase();

                // Chicotes s√£o vendidos por PE√áA (unidade), mas o gasto √© por metro
                if (desc.includes('chicote') || cat.includes('chicote')) {
                    return 'un';
                }

                // Regra para Espaguetados: Finos (at√© 1.0mm) em metro, Grossos (2.5mm+) em rolo
                if (desc.includes('espaguetado')) {
                    const match = desc.match(/(\d+[.,]?\d*)\s*(mm|m\b)/);
                    if (match) {
                        const gauge = parseFloat(match[1].replace(',', '.'));
                        if (gauge <= 1.1) { // Captura 0.5, 0.75 e 1.0mm
                            return 'mt';
                        }
                    }
                    // Se for espaguetado mas bitola grossa ou n√£o especificada, assume Rolo (rl)
                    return 'rl';
                }

                return 'rl';
            }

            async function salvarPrecos() {
                // Salva Cota√ß√µes Globais
                const novaCotAl = parseFloat(document.getElementById('cotacaoAl').value) || 0;
                const novaCotCu = parseFloat(document.getElementById('cotacaoCu').value) || 0;
                const novaCotPvc = parseFloat(document.getElementById('cotacaoPvc').value) || 0;

                cotacaoAl = novaCotAl;
                cotacaoCu = novaCotCu;
                cotacaoPvc = novaCotPvc;

                // Itera sobre os inputs vis√≠veis
                const rows = document.querySelectorAll('#tabelaPrecos tr');
                let hasError = false;
                let produtosAlterados = {};

                rows.forEach(row => {
                    const id = row.dataset.id;
                    if (!id) return;

                    if (!dadosPrecos[id]) dadosPrecos[id] = {};

                    // Aluminio
                    const pAl = parseFloat(row.querySelector('.input-peso-al').value) || 0;
                    dadosPrecos[id].pesoAl = pAl;
                    dadosPrecos[id].custoAl = pAl * cotacaoAl;

                    // Cobre
                    const pCu = parseFloat(row.querySelector('.input-peso-cu').value) || 0;
                    dadosPrecos[id].pesoCu = pCu;
                    dadosPrecos[id].custoCu = pCu * cotacaoCu;

                    // PVC
                    const pPvc = parseFloat(row.querySelector('.input-peso-pvc').value) || 0;
                    dadosPrecos[id].pesoPvc = pPvc;
                    dadosPrecos[id].custoPvc = pPvc * cotacaoPvc;

                    const vendaInput = parseFloat(row.querySelector('.input-venda').value) || 0;

                    // Custo Total √© derivado
                    const custoTotal = dadosPrecos[id].custoAl + dadosPrecos[id].custoCu + dadosPrecos[id].custoPvc;
                    dadosPrecos[id].custo = custoTotal;

                    // Valida√ß√£o de Pre√ßo Minimo
                    if (vendaInput > 0 && vendaInput < custoTotal) {
                        hasError = true;
                    }

                    dadosPrecos[id].venda = vendaInput;

                    // Prepara objeto para envio
                    produtosAlterados[id] = {
                        al: pAl,
                        cu: pCu,
                        pvc: pPvc,
                        venda: vendaInput
                    };
                });

                if (hasError) {
                    mostrarToast('ERRO: Pre√ßo de venda abaixo do custo! Ajuste os valores em vermelho.', 'red');
                    renderizarTabelaPrecos();
                    return;
                }

                // Atualiza Local Storage (Fallback)
                localStorage.setItem('alx_prices', JSON.stringify(dadosPrecos));
                localStorage.setItem('alx_cotacoes', JSON.stringify({ al: cotacaoAl, cu: cotacaoCu, pvc: cotacaoPvc }));

                try {
                    mostrarToast('Salvando defini√ß√µes na nuvem...', 'blue');

                    // ENVIA PARA CLOUD (GOOGLE SHEETS)
                    // Envia TODOS os dados locais para garantir sincronia completa, n√£o apenas os vis√≠veis
                    const dadosParaEnvio = {};

                    // Reconstr√≥i objeto simples para envio (apenas dados essenciais)
                    Object.keys(dadosPrecos).forEach(id => {
                        dadosParaEnvio[id] = {
                            al: dadosPrecos[id].pesoAl || 0,
                            cu: dadosPrecos[id].pesoCu || 0,
                            pvc: dadosPrecos[id].pesoPvc || 0,
                            venda: dadosPrecos[id].venda || 0,
                            custo: dadosPrecos[id].custo || 0
                        };
                    });

                    await fetch(CONFIG.webAppUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'save_costs',
                            cotacoes: { al: cotacaoAl, cu: cotacaoCu, pvc: cotacaoPvc },
                            produtos: dadosParaEnvio
                        })
                    });
                    mostrarToast('Tabela de custos salva na nuvem!', 'emerald');
                } catch (e) {
                    console.error("Erro ao salvar custos na nuvem", e);
                    mostrarToast('Salvo localmente, mas erro ao salvar na nuvem.', 'amber');
                }

                // Atualiza carrinho
                carrinhoC.forEach(item => {
                    const p = getPrecos(item.id);
                    item.preco = p.venda;
                    item.custo = p.custo;
                    item.pesoAl = p.pesoAl;
                    item.custoAl = p.custoAl;
                    item.pesoCu = p.pesoCu;
                    item.custoCu = p.custoCu;
                    item.pesoPvc = p.pesoPvc;
                    item.custoPvc = p.custoPvc;
                });
                renderizarCarrinho();
                renderizarTabelaPrecos();
            }

            function renderizarTabelaPrecos() {
                const tbody = document.getElementById('tabelaPrecos');
                const termo = (document.getElementById('buscaPrecos')?.value || '').toLowerCase();

                const isUser = currentUser && currentUser.role === ROLES.USER;
                // Garante que as vars globais estejam sync com inputs (caso usuario digite sem salvar ainda, pra ver simulacao)
                const inputLiga = document.getElementById('cotacaoAl');
                const inputCu = document.getElementById('cotacaoCu');
                const inputPvc = document.getElementById('cotacaoPvc');

                const atualLiga = inputLiga ? (parseFloat(inputLiga.value) || 0) : cotacaoAl;
                const atualCu = inputCu ? (parseFloat(inputCu.value) || 0) : cotacaoCu;
                const atualPvc = inputPvc ? (parseFloat(inputPvc.value) || 0) : cotacaoPvc;

                const filtrados = dadosEstoque.filter(p => {
                    const txt = `${p.ID} ${p.DESCRICAO} ${p.COR}`.toLowerCase();
                    return txt.includes(termo);
                });




                // Injeta cabe√ßalho com bot√µes "Limpar Tudo"
                let headerHTML = isUser ? `
                <tr class="text-xs text-slate-400 bg-slate-900 uppercase sticky top-0 z-10 shadow-lg">
                    <th class="p-3 text-left w-2/3">Produto</th>
                    <th class="p-3 text-center text-emerald-400 w-1/3">Venda Sugerida (R$)</th>
                </tr>
                ` : `
                <tr class="text-xs text-slate-400 bg-slate-900 uppercase sticky top-0 z-10 shadow-lg">
                    <th class="p-3 text-left w-1/4">Produto</th>
                    <th class="p-3 text-center text-blue-400 w-1/6">
                        <div class="flex flex-col items-center">
                            <span>Alum√≠nio (KG/R$)</span>
                            <button onclick="limparTudo('al')" class="text-[9px] text-red-400/70 hover:text-red-400 border border-red-900/30 rounded px-1 mt-1 transition-colors" title="Zerar toda coluna de Alum√≠nio">
                                [Limpar Tudo]
                            </button>
                        </div>
                    </th>
                    <th class="p-3 text-center text-orange-400 w-1/6">
                        <div class="flex flex-col items-center">
                            <span>Cobre (KG/R$)</span>
                            <button onclick="limparTudo('cu')" class="text-[9px] text-red-400/70 hover:text-red-400 border border-red-900/30 rounded px-1 mt-1 transition-colors" title="Zerar toda coluna de Cobre">
                                [Limpar Tudo]
                            </button>
                        </div>
                    </th>
                    <th class="p-3 text-center text-amber-400 w-1/6">
                        <div class="flex flex-col items-center">
                            <span>PVC (KG/R$)</span>
                            <button onclick="limparTudo('pvc')" class="text-[9px] text-red-400/70 hover:text-red-400 border border-red-900/30 rounded px-1 mt-1 transition-colors" title="Zerar toda coluna de PVC">
                                [Limpar Tudo]
                            </button>
                        </div>
                    </th>
                    <th class="p-3 text-center text-emerald-400 w-1/6">Venda Def. (R$)</th>
                    <th class="p-3 text-center w-1/12">Margem Est.</th>
                </tr>
            `;

                // Cabe√ßalho fixo na tabela (se n√£o existir, cria, se existir, n√£o recria para n√£o perder eventos, 
                // mas aqui estamos recriando o tbody. O ideal seria o thead ser separado no HTML.
                // CORRE√á√ÉO: O HTML est√°tico tem thead. Vamos manipular o thead existente ou injetar rows.
                // Para simplificar e garantir update, vamos atualizar o innerHTML do thead tamb√©m.

                const thead = document.querySelector('#tabelaPrecos').parentElement.querySelector('thead');
                if (thead) {
                    thead.innerHTML = headerHTML;
                }

                tbody.innerHTML = filtrados.map(p => {
                    const precos = getPrecos(p.ID);
                    const desc = (p.DESCRICAO || '').toLowerCase();

                    let unitType = 'padrao';
                    const unit = getUnit(p);
                    if (unit === 'mt') {
                        unitType = (desc.includes('espaguetado')) ? 'metro' : 'chicote';
                    }

                    const unitLabel = unitType === 'metro' ? 'KG/m' : (unitType === 'chicote' ? 'KG/m' : 'KG/Unid.');
                    const tag = unitType === 'metro' ? '<span class="text-[9px] text-purple-400 border border-purple-500/30 px-1 rounded ml-1">Por Metro</span>' :
                        (unitType === 'chicote' ? '<span class="text-[9px] text-blue-400 border border-blue-500/30 px-1 rounded ml-1">Chicote (m)</span>' : '');

                    // Calcula custos BASEADO NA COTA√á√ÉO ATUAL DO INPUT (Simula√ß√£o em tempo real)
                    const calcCustoLiga = (precos.pesoAl || 0) * atualLiga;
                    const calcCustoCu = (precos.pesoCu || 0) * atualCu;
                    const calcCustoPvc = (precos.pesoPvc || 0) * atualPvc;
                    const custoTotal = calcCustoLiga + calcCustoCu + calcCustoPvc;

                    const margem = precos.venda - custoTotal;
                    const margemPerc = precos.venda > 0 ? ((margem / precos.venda) * 100).toFixed(1) : 0;

                    let margemClass = 'text-slate-400';
                    if (precos.venda > 0) {
                        margemClass = margemPerc >= 30 ? 'text-emerald-400' : 'text-red-400';
                    }

                    if (isUser) {
                        return `
                        <tr class="hover:bg-slate-700/30 transition-colors">
                            <td class="p-3">
                                <div class="font-bold text-xs text-slate-200">${p.DESCRICAO}</div>
                                <div class="text-[10px] text-slate-400">${p.COR} (ID: ${p.ID})</div>
                                ${tag}
                            </td>
                            <td class="p-3 text-center border-l border-slate-700">
                                <span class="text-sm font-bold text-emerald-400">R$ ${precos.venda.toFixed(2)}</span>
                            </td>
                        </tr>`;
                    }

                    return `
                    <tr class="hover:bg-slate-700/30 group" data-id="${p.ID}">
                        <td class="p-3">
                            <div class="font-bold text-xs text-slate-200">${p.DESCRICAO}</div>
                            <div class="text-[10px] text-slate-400">${p.COR} (ID: ${p.ID})</div>
                            ${tag}
                        </td>
                        
                        <!-- Coluna Liga (Subs. Aluminio) -->
                        <td class="p-3 text-center bg-slate-800/20">
                            <div class="flex justify-center mb-1">
                                <button onclick="limparColuna('al', this)" title="Zerar Alum√≠nio deste item" class="text-[10px] text-slate-500 hover:text-red-400 p-0.5 rounded">
                                    üóëÔ∏è
                                </button>
                            </div>
                            <div class="flex flex-col gap-1 items-center">
                                <div class="flex items-center gap-1">
                                    <span class="text-[9px] text-slate-500">${unitLabel}</span>
                                    <input type="number" step="0.001" min="0" value="${precos.pesoAl || 0}" 
                                        class="input-peso-al w-16 bg-slate-900 border border-slate-700 rounded p-1 text-center text-xs font-mono text-blue-300 focus:border-blue-500 outline-none">
                                </div>
                                <div class="text-[10px] text-slate-400 font-mono">
                                    R$ ${calcCustoLiga.toFixed(2)}
                                </div>
                            </div>
                        </td>

                        <!-- Coluna Cobre -->
                        <td class="p-3 text-center bg-slate-800/15">
                            <div class="flex justify-center mb-1">
                                <button onclick="limparColuna('cu', this)" title="Zerar Cobre deste item" class="text-[10px] text-slate-500 hover:text-red-400 p-0.5 rounded">
                                    üóëÔ∏è
                                </button>
                            </div>
                            <div class="flex flex-col gap-1 items-center">
                                <div class="flex items-center gap-1">
                                    <span class="text-[9px] text-slate-500">${unitLabel}</span>
                                    <input type="number" step="0.001" min="0" value="${precos.pesoCu || 0}" 
                                        class="input-peso-cu w-16 bg-slate-900 border border-slate-700 rounded p-1 text-center text-xs font-mono text-orange-300 focus:border-orange-500 outline-none">
                                </div>
                                <div class="text-[10px] text-slate-400 font-mono">
                                    R$ ${calcCustoCu.toFixed(2)}
                                </div>
                            </div>
                        </td>

                        <!-- Coluna PVC -->
                        <td class="p-3 text-center bg-slate-800/10">
                            <div class="flex justify-center mb-1">
                                <button onclick="limparColuna('pvc', this)" title="Zerar PVC deste item" class="text-[10px] text-slate-500 hover:text-red-400 p-0.5 rounded">
                                    üóëÔ∏è
                                </button>
                            </div>
                            <div class="flex flex-col gap-1 items-center">
                                <div class="flex items-center gap-1">
                                    <span class="text-[9px] text-slate-500">${unitLabel}</span>
                                    <input type="number" step="0.001" min="0" value="${precos.pesoPvc || 0}" 
                                        class="input-peso-pvc w-16 bg-slate-900 border border-slate-700 rounded p-1 text-center text-xs font-mono text-amber-300 focus:border-amber-500 outline-none">
                                </div>
                                <div class="text-[10px] text-slate-400 font-mono">
                                    R$ ${calcCustoPvc.toFixed(2)}
                                </div>
                            </div>
                        </td>



                        <!-- Venda e Margem -->
                        <td class="p-3 text-center border-l border-slate-700">
                            <div class="flex items-center justify-center gap-1">
                                <span class="text-xs text-emerald-600 font-bold">R$</span>
                                <input type="number" step="0.01" min="0" value="${precos.venda}" 
                                    oninput="this.classList.toggle('border-red-500', parseFloat(this.value) < ${custoTotal.toFixed(2)})"
                                    class="input-venda w-20 bg-slate-900 border ${precos.venda < custoTotal ? 'border-red-500' : 'border-emerald-900/50'} rounded p-1 text-center text-sm font-bold text-emerald-400 focus:border-emerald-500 outline-none">
                            </div>
                        </td>
                        <td class="p-3 text-center">
                            <div class="text-xs font-bold ${margemClass}">
                                R$ ${margem.toFixed(2)}
                            </div>
                            <div class="text-[9px] text-slate-500">${margemPerc}%</div>
                        </td>
                    </tr>
                `;
                }).join('');
            }

            function renderizarListaProdutosPedido() {
                const container = document.getElementById('listaProdutosPedido');
                const termoInput = (document.getElementById('buscaPedido').value || '').toLowerCase();
                const termos = termoInput.split(/\s+/).filter(t => t.length > 0);

                const filtrados = dadosEstoque.filter(p => {
                    const textoCompleto = `${p.ID} ${p.DESCRICAO} ${p.CATEGORIA} ${p.COR}`.toLowerCase();
                    // Verifica se TODOS os termos digitados est√£o presentes no texto do produto
                    return termos.every(t => textoCompleto.includes(t));
                });

                container.innerHTML = filtrados.map(p => `
                <div onclick="adicionarAoCarrinho(${p.ID})" 
                    class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg cursor-pointer transition-colors border border-transparent hover:border-emerald-500/30 group">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-xs text-slate-200">${p.DESCRICAO}</span>
                        <span class="text-[10px] font-mono bg-slate-800 px-1 rounded text-slate-400">${p.ID}</span>
                    </div>
                    <div class="flex justify-between items-center mt-1">
                        <span class="text-[10px] text-slate-400">${p.COR}</span>
                        <span class="text-[10px] font-bold ${p.QUANTIDADE === 0 ? 'text-red-400' : 'text-emerald-400'}">
                            ${p.QUANTIDADE} ${getUnit(p)}
                        </span>
                    </div>
                </div>
            `).join('');

                if (filtrados.length === 0) {
                    container.innerHTML = '<p class="text-xs text-slate-500 text-center py-4">Nenhum produto encontrado</p>';
                }
            }

            function filtrarProdutosPedido() {
                renderizarListaProdutosPedido();
            }

            function adicionarAoCarrinho(id) {
                const produto = dadosEstoque.find(p => p.ID == id);
                if (!produto) return;

                const itemExistente = carrinhoC.find(i => i.id == id);

                // Busca Pre√ßos
                const precos = getPrecos(produto.ID);

                if (itemExistente) {
                    itemExistente.qtd++;
                } else {
                    carrinhoC.push({
                        id: produto.ID,
                        descricao: produto.DESCRICAO,
                        cor: produto.COR,
                        estoqueAtual: produto.QUANTIDADE,
                        qtd: 1,
                        preco: precos.venda,
                        // Garante que pegue os custos individuais tamb√©m
                        custo: (precos.custoAl || 0) + (precos.custoCu || 0) + (precos.custoPvc || 0),
                        pesoAl: precos.pesoAl || 0,
                        custoAl: precos.custoAl || 0,
                        pesoCu: precos.pesoCu || 0,
                        custoCu: precos.custoCu || 0,
                        pesoPvc: precos.pesoPvc || 0,
                        custoPvc: precos.custoPvc || 0
                    });
                }
                renderizarCarrinho();
                mostrarToast('Item adicionado!', 'emerald');
            }

            function removerDoCarrinho(index) {
                carrinhoC.splice(index, 1);
                renderizarCarrinho();
            }

            function alterarQtdCarrinho(index, novaQtd) {
                if (novaQtd < 1) novaQtd = 1;
                carrinhoC[index].qtd = parseInt(novaQtd);
                renderizarCarrinho();
            }

            function alterarPrecoCarrinho(index, novoPreco) {
                const preco = parseFloat(novoPreco);
                if (isNaN(preco) || preco < 0) return;

                const item = carrinhoC[index];
                if (preco < item.custo) {
                    mostrarToast(`Pre√ßo abaixo do custo (R$ ${item.custo.toFixed(2)})!`, 'red');
                }

                // Atualiza pre√ßo
                item.preco = preco;
                renderizarCarrinho();
            }

            function limparCarrinho() {
                carrinhoC = [];
                renderizarCarrinho();
            }

            function renderizarCarrinho() {
                const tbody = document.getElementById('tabelaCarrinho');
                const contador = document.getElementById('contadorCarrinho');

                contador.innerText = carrinhoC.reduce((acc, item) => acc + item.qtd, 0);

                if (carrinhoC.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-slate-500 italic">Nenhum item adicionado ao pedido</td></tr>';
                    return;
                }

                tbody.innerHTML = carrinhoC.map((item, index) => {
                    const desc = (item.descricao || '').toLowerCase();
                    const unit = getUnit(item);
                    let unitPriceLabel = `R$/${unit === 'mt' ? 'm' : (unit === 'p√ß' ? 'P√ß' : 'rl')}`;
                    let tag = '';

                    if (unit === 'mt') {
                        tag = desc.includes('espaguetado')
                            ? '<span class="text-[9px] text-purple-400 border border-purple-500/30 px-1 rounded">Por Metro</span>'
                            : '<span class="text-[9px] text-blue-400 border border-blue-500/30 px-1 rounded">Chicote (m)</span>';
                    }

                    const statusEstoque = item.qtd > item.estoqueAtual
                        ? '<span class="text-[10px] font-bold text-amber-400 bg-amber-900/20 px-2 py-0.5 rounded">Produ√ß√£o Necess√°ria</span>'
                        : '<span class="text-[10px] font-bold text-emerald-400 bg-emerald-900/20 px-2 py-0.5 rounded">Estoque OK</span>';

                    return `
                    <tr class="hover:bg-slate-700/30">
                        <td class="p-3">
                            <p class="font-bold text-xs">${item.descricao}</p>
                            <p class="text-[10px] text-slate-400">${item.cor}</p>
                            ${tag}
                        </td>
                        <td class="p-3 text-center">
                            <input type="number" min="1" value="${item.qtd}" onchange="alterarQtdCarrinho(${index}, this.value)"
                                class="w-16 bg-slate-900 border border-slate-600 rounded p-1 text-center text-sm font-bold outline-none focus:border-emerald-500">
                        </td>
                        <td class="p-3 text-center text-xs font-mono text-slate-400">
                            ${item.estoqueAtual}
                        </td>
                        <td class="p-3 text-right">
                            <div class="flex flex-col items-end gap-1">
                                <div class="flex items-center justify-end gap-1 mb-1">
                                    <span class="text-[9px] text-slate-500">R$/Unid ‚úèÔ∏è</span>
                                </div>
                                <input type="number" step="0.01" min="0" value="${item.preco.toFixed(2)}" 
                                    onchange="alterarPrecoCarrinho(${index}, this.value)"
                                    class="w-24 bg-slate-900 border ${item.preco < item.custo ? 'border-red-500 text-red-400' : 'border-slate-600 text-emerald-400'} rounded p-1 text-right text-sm font-bold outline-none focus:border-emerald-500">
                                
                                <div class="text-xs font-bold text-emerald-400">
                                    Total: R$ ${(item.preco * item.qtd).toFixed(2)}
                                </div>
                                
                                ${item.preco < item.custo ? `<div class="text-[9px] text-red-500 font-bold">Custo: R$ ${item.custo.toFixed(2)}</div>` : ''}
                            </div>
                        </td>
                        <td class="p-3 text-center">
                            ${statusEstoque}
                        </td>
                        <td class="p-3 text-right">
                            <button onclick="removerDoCarrinho(${index})" class="text-slate-400 hover:text-red-400 transition-colors">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
                }).join('');
            }

            async function finalizarPedido() {
                if (carrinhoC.length === 0) {
                    mostrarToast('Adicione itens ao pedido!', 'amber');
                    return;
                }

                const cliente = document.getElementById('clientePedido').value || '';
                const numCliente = document.getElementById('numCliente').value || '';
                const cnpj = document.getElementById('cnpjPedido').value || '';
                const ie = document.getElementById('iePedido').value || '-';
                const endereco = document.getElementById('enderecoPedido').value || '';
                const transportadora = document.getElementById('transportadoraPedido').value || 'Retirada Pr√≥pria';

                if (!cliente || !numCliente || !cnpj || !endereco) {
                    mostrarToast('Preencha os campos obrigat√≥rios (*) para gerar o pedido!', 'red');
                    return;
                }

                if (!confirm('Confirmar pedido? Isso ir√° gerar 3 PDFs (Cliente, Produ√ß√£o, Custos) e atualizar o estoque.')) return;

                // Gerar IDs e Dados base
                const dataStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const randomSuffix = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                const clienteSlug = cliente.replace(/[^a-zA-Z0-9]/g, '').toUpperCase().slice(0, 5);
                const pedidoId = `PED-${dataStr}-${clienteSlug}-${randomSuffix}`;
                const dataHora = new Date().toLocaleString('pt-BR');

                // Atualiza custos/pesos com base na cota√ß√£o ATUAL
                let totalVenda = 0;
                let totalCusto = 0;

                carrinhoC.forEach(item => {
                    const p = getPrecos(item.id);
                    // Atualiza propriedades para garantir precis√£o
                    item.custo = p.custo;
                    item.custoAl = p.custoAl;
                    item.custoCu = p.custoCu;
                    item.custoPvc = p.custoPvc;
                    item.pesoAl = p.pesoAl;
                    item.pesoCu = p.pesoCu;
                    item.pesoPvc = p.pesoPvc;

                    // Calcula totais para salvar na nuvem
                    totalVenda += (item.qtd * item.preco);
                    const custoUn = (item.custoAl || 0) + (item.custoCu || 0) + (item.custoPvc || 0);
                    totalCusto += (item.qtd * custoUn);
                });

                const lucro = totalVenda - totalCusto;
                const margem = totalVenda > 0 ? ((lucro / totalVenda) * 100).toFixed(1) : "0.0";

                try {
                    pararSync(); // PAUSA SYNC
                    mostrarToast('Gerando PDFs...', 'blue');

                    // 1. Gera PDFs Usando Helpers
                    gerarPDFCliente(pedidoId, dataHora, cliente, numCliente, cnpj, ie, endereco, transportadora, carrinhoC);

                    // Delay pequeno para n√£o travar UI
                    setTimeout(() => gerarPDFProducao(pedidoId, dataHora, cliente, transportadora, carrinhoC), 800);

                    // Bloqueia PDF de custos para Vendedor
                    if (currentUser.role !== ROLES.USER) {
                        setTimeout(() => gerarPDFCustos(pedidoId, dataHora, carrinhoC), 1600);
                    }

                    // 2. Salva Pedido na Nuvem com JSON
                    mostrarToast('Salvando pedido na planilha...', 'blue');
                    const resumoItens = carrinhoC.map(i => `${i.qtd}x ${i.descricao}`).join(', ');

                    await salvarPedidoNaNuvem({
                        pedidoId: pedidoId,
                        cliente: cliente,
                        cnpj: cnpj,
                        totalVenda: totalVenda.toFixed(2),
                        totalCusto: totalCusto.toFixed(2),
                        margemReais: lucro.toFixed(2),
                        margemPercent: margem + '%',
                        itensResumo: resumoItens,
                        itensJson: JSON.stringify(carrinhoC), // IMPORTANTE PARA REGERAR
                        obs: `${transportadora} ${currentUser ? '(Por: ' + currentUser.name + ')' : ''}`,
                        vendedor: currentUser ? currentUser.name : '',
                        telefone: numCliente,
                        ie: ie,
                        endereco: endereco
                    });

                    // 3. Baixa no Estoque
                    mostrarToast('Atualizando estoque...', 'blue');
                    for (const item of carrinhoC) {
                        const disponivel = item.estoqueAtual;
                        const pedido = item.qtd;
                        let qtdBaixar = (disponivel >= pedido) ? pedido : (disponivel > 0 ? disponivel : 0);

                        if (qtdBaixar > 0) {
                            const totalItem = (item.preco * item.qtd).toFixed(2);
                            let obs = `${pedidoId} | Cli: ${cliente} | R$ ${totalItem}`;
                            if (transportadora && transportadora !== 'Retirada Pr√≥pria') obs += ` | ${transportadora}`;

                            await registrarBaixaSilenciosa(item.id, qtdBaixar, obs);
                        }
                    }

                    mostrarToast('Pedido finalizado com sucesso!', 'emerald');
                    limparCarrinho();

                    // Limpa campos form
                    ['clientePedido', 'numCliente', 'cnpjPedido', 'iePedido', 'enderecoPedido', 'transportadoraPedido'].forEach(id => {
                        document.getElementById(id).value = '';
                    });

                    sincronizar(); // FOR√áA SYNC FINAL

                } catch (error) {
                    console.error(error);
                    mostrarToast('Erro ao processar pedido: ' + error.message, 'red');
                } finally {
                    iniciarSync(); // RETOMA SYNC AUTO
                }
            }

            async function gerarOrcamento() {
                if (carrinhoC.length === 0) {
                    mostrarToast('Adicione itens para gerar or√ßamento!', 'amber');
                    return;
                }

                const cliente = document.getElementById('clientePedido').value || 'CLIENTE AVULSO';
                const numCliente = document.getElementById('numCliente').value || '';
                const cnpj = document.getElementById('cnpjPedido').value || '';
                const ie = document.getElementById('iePedido').value || '-';
                const endereco = document.getElementById('enderecoPedido').value || '';
                const transportadora = document.getElementById('transportadoraPedido').value || 'Retirada Pr√≥pria';

                mostrarToast('Gerando or√ßamento...', 'blue');

                const dataStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const randomSuffix = Math.floor(Math.random() * 100).toString().padStart(2, '0');
                const orcId = `ORC-${dataStr}-${randomSuffix}`;
                const dataHora = new Date().toLocaleString('pt-BR');

                // Usa o helper mas define como Or√ßamento
                gerarPDFCliente(orcId, dataHora, cliente, numCliente, cnpj, ie, endereco, transportadora, carrinhoC, 'OR√áAMENTO');

                mostrarToast('Or√ßamento gerado com sucesso!', 'emerald');
            }

            async function salvarPedidoNaNuvem(dados) {
                try {
                    await fetch(CONFIG.webAppUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'save_order',
                            ...dados
                        })
                    });
                } catch (e) {
                    console.error("Erro ao salvar resumo do pedido", e);
                    mostrarToast('Erro ao salvar resumo na planilha (mas o estoque foi atualizado)', 'amber');
                }
            }

            async function registrarBaixaSilenciosa(id, qtd, obs) {
                try {
                    const userObs = `${obs} (Por: ${currentUser ? currentUser.name : 'Desconhecido'})`;
                    await fetch(CONFIG.webAppUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'update',
                            id: id,
                            quantidade: qtd,
                            tipo: 'pedido',
                            observacao: userObs
                        })
                    });
                } catch (e) {
                    console.error("Falha ao baixar item " + id, e);
                }
            }

            // --- FUNCOES DE CADASTRO ---
            function switchSubTabCadastro(tab) {
                document.getElementById('subtab-cad-clientes').classList.add('hidden');
                document.getElementById('subtab-cad-transportadoras').classList.add('hidden');

                document.getElementById('subnav-cad-clientes').classList.remove('bg-emerald-600', 'text-white');
                document.getElementById('subnav-cad-clientes').classList.add('text-slate-400');

                document.getElementById('subnav-cad-transportadoras').classList.remove('bg-blue-600', 'text-white');
                document.getElementById('subnav-cad-transportadoras').classList.add('text-slate-400');

                if (tab === 'clientes') {
                    document.getElementById('subtab-cad-clientes').classList.remove('hidden');
                    document.getElementById('subnav-cad-clientes').classList.remove('text-slate-400');
                    document.getElementById('subnav-cad-clientes').classList.add('bg-emerald-600', 'text-white');
                } else {
                    document.getElementById('subtab-cad-transportadoras').classList.remove('hidden');
                    document.getElementById('subnav-cad-transportadoras').classList.remove('text-slate-400');
                    document.getElementById('subnav-cad-transportadoras').classList.add('bg-blue-600', 'text-white');
                }
            }

            async function salvarCliente() {
                const nome = document.getElementById('cadCliNome').value;
                const tel = document.getElementById('cadCliTel').value;
                const doc = document.getElementById('cadCliDoc').value;
                const ie = document.getElementById('cadCliIE').value;
                const end = document.getElementById('cadCliEnd').value;

                if (!nome || !doc) {
                    mostrarToast('Nome e Documento s√£o obrigat√≥rios!', 'amber');
                    return;
                }

                try {
                    mostrarToast('Salvando cliente...', 'blue');
                    pararSync(); // PAUSA SYNC

                    const response = await fetch(CONFIG.webAppUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'create_client',
                            nome: nome.trim(),
                            telefone: tel.trim(),
                            cnpj: doc.trim(),
                            ie: ie.trim(),
                            endereco: end.trim()
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        mostrarToast('Cliente cadastrado com sucesso!', 'emerald');
                        // Limpar form
                        document.getElementById('cadCliNome').value = '';
                        document.getElementById('cadCliTel').value = '';
                        document.getElementById('cadCliDoc').value = '';
                        document.getElementById('cadCliIE').value = '';
                        document.getElementById('cadCliEnd').value = '';
                        sincronizar(); // FOR√áA SYNC
                    } else {
                        throw new Error(result.error);
                    }
                } catch (e) {
                    mostrarToast('Erro ao salvar cliente: ' + e.message, 'red');
                } finally {
                    iniciarSync(); // RETOMA SYNC
                }
            }

            async function salvarTransportadora() {
                const nome = document.getElementById('cadTranspNome').value;
                const cnpj = document.getElementById('cadTranspCNPJ').value;
                const tel = document.getElementById('cadTranspTel').value;
                const contato = document.getElementById('cadTranspContato').value;

                if (!nome || !cnpj) {
                    mostrarToast('Nome e CNPJ da transportadora s√£o obrigat√≥rios!', 'amber');
                    return;
                }

                try {
                    mostrarToast('Salvando transportadora...', 'blue');
                    pararSync(); // PAUSA SYNC

                    const response = await fetch(CONFIG.webAppUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'create_carrier',
                            nome: nome.trim(),
                            telefone: tel.trim(),
                            contato: contato.trim(),
                            cnpj: cnpj.trim()
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        mostrarToast('Transportadora salva com sucesso!', 'emerald');
                        document.getElementById('cadTranspNome').value = '';
                        document.getElementById('cadTranspCNPJ').value = '';
                        document.getElementById('cadTranspTel').value = '';
                        document.getElementById('cadTranspContato').value = '';
                        sincronizar(); // FOR√áA SYNC
                    } else {
                        throw new Error(result.error);
                    }
                } catch (e) {
                    mostrarToast('Erro ao salvar transportadora: ' + e.message, 'red');
                } finally {
                    iniciarSync(); // RETOMA SYNC
                }
            }
            function exportarTabelaPrecos() {
                // 1. Obter Dados
                const ws_data = [
                    ["ID", "Categoria", "Descri√ß√£o", "Cor", "Peso Alum. (kg)", "Peso Cobre (kg)", "Peso PVC (kg)", "Pre√ßo Venda (R$)"]
                ];

                dadosEstoque.forEach(p => {
                    const precos = getPrecos(p.ID);
                    ws_data.push([
                        p.ID,
                        p.CATEGORIA,
                        p.DESCRICAO,
                        p.COR,
                        precos.pesoAl || 0,
                        precos.pesoCu || 0,
                        precos.pesoPvc || 0,
                        precos.venda || 0
                    ]);
                });

                // 2. Gerar Planilha
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Tabela de Pre√ßos");
                XLSX.writeFile(wb, "Tabela_Precos_ALX.xlsx");
                mostrarToast("Tabela de pre√ßos baixada!", "emerald");
            }

            function exportarExcel() {
                // Renomeado visualmente para "Baixar Or√ßamento"
                if (carrinhoC.length === 0) {
                    mostrarToast('Adicione itens ao pedido para baixar o or√ßamento!', 'amber');
                    return;
                }

                const cliente = document.getElementById('clientePedido').value || 'Cliente';
                const pedidoId = Date.now().toString().slice(-6);

                // 1. Obter Cota√ß√µes Atuais
                const valAl = parseFloat(document.getElementById('cotacaoAl').value) || 0;
                const valCu = parseFloat(document.getElementById('cotacaoCu').value) || 0;
                const valPvc = parseFloat(document.getElementById('cotacaoPvc').value) || 0;

                // 2. Preparar Estrutura do Excel (Array de Arrays para maior controle)
                // Cabe√ßalho das Cota√ß√µes (Linhas 1-3)
                const ws_data = [
                    ["Cota√ß√£o Alum√≠nio (R$/kg)", valAl],
                    ["Cota√ß√£o Cobre (R$/kg)", valCu],
                    ["Cota√ß√£o PVC (R$/kg)", valPvc],
                    [], // Linha em branco
                    // Cabe√ßalho da Tabela
                    ["ID", "Produto", "Cor", "Qtd (rl)", "Peso Al Unit (kg)", "Peso Cu Unit (kg)", "Peso PVC Unit (kg)", "Custo Al (R$)", "Custo Cu (R$)", "Custo PVC (R$)", "Custo Total (R$)", "Venda Unit (R$)", "Venda Total (R$)", "Margem (R$)"]
                ];

                // 3. Adicionar Linhas de Dados com F√≥rmulas
                carrinhoC.forEach((item, i) => {
                    const rowIndex = 6 + i;
                    const row = [
                        item.id,
                        item.descricao,
                        item.cor,
                        item.qtd,
                        item.pesoAl || 0,
                        item.pesoCu || 0,
                        item.pesoPvc || 0,
                        null, null, null, null, // F√≥rmulas
                        item.preco,
                        null, null // F√≥rmulas
                    ];
                    ws_data.push(row);
                });

                // 4. Converter para Worksheet e Aplicar F√≥rmulas
                const ws = XLSX.utils.aoa_to_sheet(ws_data);

                for (let i = 0; i < carrinhoC.length; i++) {
                    const rowIndex = 6 + i;
                    ws[`H${rowIndex}`] = { t: 'n', f: `D${rowIndex}*E${rowIndex}*$B$1` };
                    ws[`I${rowIndex}`] = { t: 'n', f: `D${rowIndex}*F${rowIndex}*$B$2` };
                    ws[`J${rowIndex}`] = { t: 'n', f: `D${rowIndex}*G${rowIndex}*$B$3` };
                    ws[`K${rowIndex}`] = { t: 'n', f: `H${rowIndex}+I${rowIndex}+J${rowIndex}` };
                    ws[`M${rowIndex}`] = { t: 'n', f: `D${rowIndex}*L${rowIndex}` };
                    ws[`N${rowIndex}`] = { t: 'n', f: `M${rowIndex}-K${rowIndex}` };
                }

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Or√ßamento");
                XLSX.writeFile(wb, `Orcamento_${cliente}_${pedidoId}.xlsx`);

                mostrarToast('Or√ßamento baixado (Excel)!', 'emerald');
            }
            function limparColuna(tipo, btn) {
                // Limpa o input espec√≠fico da linha e zera o custo visualmente
                const cell = btn.closest('td');
                const input = cell.querySelector('input');
                if (input) {
                    input.value = 0;
                    // Atualiza visualmente o custo abaixo
                    const custoDisplay = cell.querySelector('.text-\\[10px\\]');
                    if (custoDisplay) custoDisplay.innerText = 'R$ 0.00';
                }
            }

            function limparTudo(tipo) {
                if (!confirm('Tem certeza que deseja zerar TODAS as colunas de ' + tipo.toUpperCase() + '?')) return;

                const selector = `.input-peso-${tipo}`;
                document.querySelectorAll(selector).forEach(input => {
                    input.value = 0;
                });
                mostrarToast(`Coluna ${tipo.toUpperCase()} zerada! Clique em Salvar para confirmar.`, 'blue');
            }
            // --- FUNCOES UI E PDF ---
            function abrirModalAlertas() {
                document.getElementById('modalAlertas').classList.remove('hidden');
                document.getElementById('headerAlertBadge').classList.add('hidden');
            }

            function fecharModalAlertas(event) {
                if (event.target.id === 'modalAlertas') {
                    document.getElementById('modalAlertas').classList.add('hidden');
                }
            }

            // Funcao Auxiliar PDF Cliente
            function gerarPDFCliente(pedidoId, dataHora, cliente, numCliente, cnpj, ie, endereco, transportadora, itens, tipoDoc = 'PEDIDO DE VENDA') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(18);
                doc.setTextColor(16, 185, 129);
                doc.text('ALX CABOS - ' + tipoDoc, 14, 20);

                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Data: ${dataHora}`, 150, 20);
                doc.setFont("helvetica", "bold");
                doc.text(`Pedido N¬∫: ${pedidoId}`, 150, 25);

                doc.setDrawColor(200);
                doc.setFillColor(245, 245, 245);
                doc.rect(14, 30, 182, 35, 'F');
                doc.setFontSize(9);
                doc.setTextColor(50);

                doc.setFont("helvetica", "bold");
                doc.text('DADOS DO CLIENTE / ENTREGA', 16, 36);
                doc.setFont("helvetica", "normal");
                doc.text(`Cliente: ${cliente}`, 16, 42);
                doc.text(`Celular: ${numCliente}`, 120, 42);
                doc.text(`CNPJ/CPF: ${cnpj}`, 16, 48);
                doc.text(`Inscr. Est.: ${ie}`, 120, 48);
                doc.text(`Endere√ßo: ${endereco}`, 16, 54);
                doc.setFont("helvetica", "bold");
                const transpTexto = (transportadora && transportadora !== 'Retirada Pr√≥pria') ? transportadora : 'Retirada Pr√≥pria / Cliente';
                doc.text(`Transportadora: ${transpTexto}`, 16, 60);

                const tableData = [];
                let total = 0;
                itens.forEach(item => {
                    const totalItem = item.qtd * item.preco;
                    total += totalItem;
                    tableData.push([item.descricao, item.cor, item.qtd + ' ' + getUnit(item), `R$ ${item.preco.toFixed(2)}`, `R$ ${totalItem.toFixed(2)}`]);
                });
                tableData.push(['', '', 'TOTAL GERAL', '', `R$ ${total.toFixed(2)}`]);

                doc.autoTable({
                    head: [['Produto', 'Cor', 'Qtd', 'Vlr. Unit.', 'Total']],
                    body: tableData,
                    startY: 70,
                    theme: 'grid',
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [16, 185, 129] },
                    columnStyles: { 2: { halign: 'center' }, 3: { halign: 'right' }, 4: { halign: 'right', fontStyle: 'bold' } },
                    didParseCell: function (data) {
                        if (data.row.index === tableData.length - 1) {
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fillColor = [240, 253, 244];
                        }
                    }
                });
                const nomeArquivo = tipoDoc.includes('OR√áAMENTO') ? `Orcamento_${pedidoId}.pdf` : `Pedido_CLIENTE_${pedidoId}.pdf`;
                doc.save(nomeArquivo);
            }

            function regerarPDFUnico(pedidoId, tipo) {
                const pedido = dadosPedidos.find(p => p.id === pedidoId);
                if (!pedido || !pedido.itens_json) {
                    alert('Dados do pedido n√£o encontrados.');
                    return;
                }

                let itens = [];
                try {
                    itens = JSON.parse(pedido.itens_json);
                } catch (e) { console.error("Erro parse json", e); return; }

                const dataHora = new Date(pedido.data).toLocaleString('pt-BR');

                // Recupera dados salvos
                const cliente = pedido.cliente;
                const cnpj = pedido.cnpj || '';
                const numCliente = pedido.telefone || '';
                const ie = pedido.ie || '';
                const endereco = pedido.endereco || '';
                const transp = pedido.obs || 'Retirada Pr√≥pria';

                mostrarToast(`Gerando PDF ${tipo.toUpperCase()}...`, 'blue');

                if (tipo === 'cliente') {
                    gerarPDFCliente(pedido.id, dataHora, cliente, numCliente, cnpj, ie, endereco, transp, itens);
                } else if (tipo === 'producao') {
                    gerarPDFProducao(pedido.id, dataHora, cliente, transp, itens);
                } else if (tipo === 'custos') {
                    if (currentUser.role === ROLES.USER) {
                        mostrarToast('Acesso negado: Vendedores n√£o podem baixar PDF de Custos.', 'red');
                        return;
                    }
                    gerarPDFCustos(pedido.id, dataHora, itens);
                }
            }

            // Funcao Auxiliar PDF Producao
            function gerarPDFProducao(pedidoId, dataHora, cliente, transportadora, itens) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(18);
                doc.setTextColor(59, 130, 246);
                doc.text('ALX CABOS - ORDEM DE PRODU√á√ÉO', 14, 20);

                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Data: ${dataHora}`, 150, 20);
                doc.setFont("helvetica", "bold");
                doc.text(`OP N¬∫: ${pedidoId}`, 150, 25);

                doc.setDrawColor(200);
                doc.setFillColor(240, 249, 255);
                doc.rect(14, 30, 182, 20, 'F');
                doc.setFontSize(9);
                doc.setTextColor(50);
                doc.setFont("helvetica", "bold");
                doc.text('DESTINO / LOG√çSTICA', 16, 36);
                doc.setFont("helvetica", "normal");
                doc.text(`Cliente: ${cliente}`, 16, 42);
                doc.text(`Transportadora: ${transportadora}`, 120, 42);

                const tableData = [];
                itens.forEach(item => {
                    const pAl = (item.pesoAl || 0) * item.qtd;
                    const pCu = (item.pesoCu || 0) * item.qtd;
                    const pPvc = (item.pesoPvc || 0) * item.qtd;
                    const acao = (item.qtd > (item.estoqueAtual || 0)) ? 'PRODUZIR' : 'SEPARAR';
                    tableData.push([item.id, item.descricao, item.cor, item.qtd + ' ' + getUnit(item), `${pAl.toFixed(3)} kg`, `${pCu.toFixed(3)} kg`, `${pPvc.toFixed(3)} kg`, acao]);
                });

                doc.autoTable({
                    head: [['ID', 'Produto', 'Cor', 'Qtd', 'Alum√≠nio', 'Cobre', 'PVC', 'A√ß√£o']],
                    body: tableData,
                    startY: 60,
                    theme: 'grid',
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [59, 130, 246] },
                    columnStyles: { 3: { halign: 'center', fontStyle: 'bold' }, 7: { halign: 'center', fontStyle: 'bold' } }
                });
                doc.save(`Ordem_PRODUCAO_${pedidoId}.pdf`);
            }

            // Funcao Auxiliar PDF Custos
            function gerarPDFCustos(pedidoId, dataHora, itens) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Cabe√ßalho Premium
                doc.setFontSize(22);
                doc.setTextColor(245, 158, 11);
                doc.setFont("helvetica", "bold");
                doc.text('ALX CABOS - RELAT√ìRIO DE CUSTOS', 14, 20);

                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.setFont("helvetica", "normal");
                doc.text(`Ref Pedido: ${pedidoId}`, 14, 28);
                doc.text(`Gerado em: ${dataHora}`, 150, 20);

                const tableData = [];
                let totalCusto = 0, totalVenda = 0, lucro = 0;
                let kgAl = 0, kgCu = 0, kgPvc = 0;
                let custoAl = 0, custoCu = 0, custoPvc = 0;

                itens.forEach(item => {
                    const cUnit = (item.custoAl || 0) + (item.custoCu || 0) + (item.custoPvc || 0);
                    const cTotal = item.qtd * cUnit;
                    const vTotal = item.qtd * item.preco;
                    const m = vTotal - cTotal;

                    totalCusto += cTotal;
                    totalVenda += vTotal;
                    lucro += m;

                    const pAlUnit = (item.pesoAl || 0);
                    const pCuUnit = (item.pesoCu || 0);
                    const pPvcUnit = (item.pesoPvc || 0);

                    kgAl += pAlUnit * item.qtd;
                    custoAl += (item.custoAl || 0) * item.qtd;
                    kgCu += pCuUnit * item.qtd;
                    custoCu += (item.custoCu || 0) * item.qtd;
                    kgPvc += pPvcUnit * item.qtd;
                    custoPvc += (item.custoPvc || 0) * item.qtd;

                    // Formata os pesos unit√°rios em uma string multilingue
                    const pesosText = `Alum√≠nio: ${pAlUnit.toFixed(3)}\nCobre: ${pCuUnit.toFixed(3)}\nPVC: ${pPvcUnit.toFixed(3)}`;

                    tableData.push([
                        `${item.descricao}\n${item.cor}`,
                        item.qtd,
                        pesosText,
                        `R$ ${cUnit.toFixed(2)}`,
                        `R$ ${cTotal.toFixed(2)}`,
                        `R$ ${vTotal.toFixed(2)}`,
                        `R$ ${m.toFixed(2)}`
                    ]);
                });

                // Linha de Totais da Tabela
                tableData.push([
                    'TOTAIS GERAIS',
                    '',
                    `Alum√≠nio: ${kgAl.toFixed(3)}\nCobre: ${kgCu.toFixed(3)}\nPVC: ${kgPvc.toFixed(3)}`,
                    '',
                    `R$ ${totalCusto.toFixed(2)}`,
                    `R$ ${totalVenda.toFixed(2)}`,
                    `R$ ${lucro.toFixed(2)}`
                ]);

                doc.autoTable({
                    head: [['Item / Descri√ß√£o', 'Qtd', 'Pesos Unit. (kg)', 'Custo Un.', 'Custo Total', 'Venda Total', 'Margem Bruta']],
                    body: tableData,
                    startY: 40,
                    theme: 'grid',
                    styles: { fontSize: 7, cellPadding: 2, valign: 'middle' },
                    headStyles: { fillColor: [245, 158, 11], textColor: 255, fontStyle: 'bold' },
                    columnStyles: {
                        0: { cellWidth: 45 },
                        2: { halign: 'center' },
                        4: { textColor: [200, 50, 50], halign: 'right', fontStyle: 'bold' },
                        5: { textColor: [30, 150, 30], halign: 'right', fontStyle: 'bold' },
                        6: { halign: 'right', fontStyle: 'bold' }
                    },
                    didParseCell: function (data) {
                        if (data.row.index === tableData.length - 1) {
                            data.cell.styles.fillColor = [255, 248, 230];
                            data.cell.styles.fontSize = 8;
                        }
                    }
                });

                const startY = doc.lastAutoTable.finalY + 15;

                // --- BOX: RESUMO DE MATERIAIS ---
                doc.setDrawColor(245, 158, 11);
                doc.setLineWidth(0.5);
                doc.setFillColor(255, 251, 235);
                doc.rect(14, startY, 90, 48, 'FD');

                doc.setFontSize(11);
                doc.setTextColor(180, 83, 9);
                doc.setFont("helvetica", "bold");
                doc.text('RESUMO DE MATERIAIS', 18, startY + 8);

                doc.setFontSize(9);
                doc.setTextColor(0);
                doc.setFont("helvetica", "normal");

                doc.text(`ALUM√çNIO TOTAL:`, 18, startY + 18);
                doc.setFont("helvetica", "bold");
                doc.text(`${kgAl.toFixed(3)} kg (Custo: R$ ${custoAl.toFixed(2)})`, 50, startY + 18);

                doc.setFont("helvetica", "normal");
                doc.text(`COBRE TOTAL:`, 18, startY + 28);
                doc.setFont("helvetica", "bold");
                doc.text(`${kgCu.toFixed(3)} kg (Custo: R$ ${custoCu.toFixed(2)})`, 50, startY + 28);

                doc.setFont("helvetica", "normal");
                doc.text(`PVC TOTAL:`, 18, startY + 38);
                doc.setFont("helvetica", "bold");
                doc.text(`${kgPvc.toFixed(3)} kg (Custo: R$ ${custoPvc.toFixed(2)})`, 50, startY + 38);

                // --- BOX: AN√ÅLISE FINANCEIRA ---
                doc.setDrawColor(16, 185, 129);
                doc.setFillColor(240, 253, 244);
                doc.rect(110, startY, 86, 48, 'FD');

                doc.setFontSize(11);
                doc.setTextColor(5, 150, 105);
                doc.setFont("helvetica", "bold");
                doc.text('AN√ÅLISE FINANCEIRA', 114, startY + 8);

                const margem = totalVenda > 0 ? (lucro / totalVenda) * 100 : 0;

                doc.setFontSize(10);
                doc.setTextColor(0);
                doc.setFont("helvetica", "normal");
                doc.text(`Faturamento:`, 114, startY + 18);
                doc.text(`Custo de Insumos:`, 114, startY + 26);

                doc.setFont("helvetica", "bold");
                doc.text(`R$ ${totalVenda.toFixed(2)}`, 155, startY + 18, { align: 'right' });
                doc.text(`R$ ${totalCusto.toFixed(2)}`, 155, startY + 26, { align: 'right' });

                doc.setDrawColor(16, 185, 129);
                doc.line(114, startY + 30, 192, startY + 30);

                doc.setFontSize(11);
                doc.text(`LUCRO L√çQUIDO:`, 114, startY + 37);
                doc.text(`R$ ${lucro.toFixed(2)}`, 192, startY + 37, { align: 'right' });

                // Badge de Margem
                let status = "IDEAL";
                if (margem < 30) {
                    status = "PERIGOSA";
                    doc.setTextColor(220, 38, 38);
                } else {
                    doc.setTextColor(5, 150, 105);
                }
                doc.setFontSize(12);
                doc.text(`MARGEM: ${margem.toFixed(1)}% (${status})`, 114, startY + 44);

                doc.save(`Relatorio_CUSTOS_${pedidoId}.pdf`);
            }

            async function deletarPedido(pedidoId) {
                const senha = prompt('‚ö†Ô∏è A√á√ÉO PERMANENTE! \nDigite a senha para excluir o pedido ' + pedidoId + ':');

                if (senha === null) return; // Cancelou

                if (senha !== '0000') {
                    mostrarToast('Senha incorreta!', 'red');
                    return;
                }

                if (!confirm('CONFIRMA√á√ÉO FINAL: Deseja mesmo excluir o pedido ' + pedidoId + ' permanentemente? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    return;
                }

                try {
                    mostrarToast('Excluindo pedido...', 'blue');
                    pararSync();

                    const response = await fetch(CONFIG.webAppUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'delete_order',
                            pedidoId: pedidoId
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        mostrarToast('Pedido exclu√≠do com sucesso!', 'emerald');
                        // Remove do cache local para resposta imediata
                        dadosPedidos = dadosPedidos.filter(p => p.id !== pedidoId);
                        renderizarHistoricoPedidos();
                        sincronizar(); // For√ßa sync para garantir
                    } else {
                        throw new Error('Pedido n√£o encontrado ou erro no servidor.');
                    }

                } catch (e) {
                    console.error(e);
                    mostrarToast('Erro ao excluir: ' + e.message, 'red');
                } finally {
                    iniciarSync();
                }
            }

            // --- HISTOICO PEDIDOS ---
            let dadosPedidos = []; // Cache local

            function renderizarHistoricoPedidos() {
                const tbody = document.getElementById('tabelaHistoricoPedidos');
                if (!tbody) return;

                const filtroBusca = (document.getElementById('filtroHistBusca').value || '').toLowerCase();
                const filtroData = document.getElementById('filtroHistDataIni').value;

                // Filtro local
                const filtrados = dadosPedidos.filter(p => {
                    const dataOk = !filtroData || p.data.startsWith(filtroData); // Data simples YYYY-MM-DD
                    const buscaOk = !filtroBusca ||
                        (p.id || '').toLowerCase().includes(filtroBusca) ||
                        (p.cliente || '').toLowerCase().includes(filtroBusca);
                    return dataOk && buscaOk;
                });

                // Filtro por Role: Vendedor s√≥ v√™ os dele (Compara√ß√£o Robusta + Fallback)
                const filtradosRole = (currentUser && currentUser.role === ROLES.USER) ?
                    filtrados.filter(p => {
                        const vPedido = (p.vendedor || '').trim().toLowerCase();
                        const vUser = (currentUser.name || '').trim().toLowerCase();
                        if (vPedido === vUser) return true;

                        // Fallback: Procura o nome na observa√ß√£o ou resumo caso a coluna Vendedor ainda n√£o exista na planilha
                        const obs = (p.obs || '').toLowerCase();
                        const resumo = (p.resumo || '').toLowerCase();
                        return vUser !== '' && (obs.includes(vUser) || resumo.includes(vUser));
                    }) :
                    filtrados;

                if (filtradosRole.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-slate-500">Nenhum pedido encontrado.</td></tr>';
                    return;
                }

                // LEGENDA DE √çCONES
                const isUser = currentUser && currentUser.role === ROLES.USER;
                const tableContainer = document.getElementById('tabelaHistoricoPedidos').parentElement;
                const parentDiv = tableContainer.parentElement;

                let legendDiv = document.getElementById('histLegenda');
                if (!legendDiv && parentDiv) {
                    legendDiv = document.createElement('div');
                    legendDiv.id = 'histLegenda';
                    legendDiv.className = "px-4 py-2 bg-slate-800/50 border-b border-slate-700 text-[10px] text-slate-400 flex items-center gap-4 justify-end flex-wrap";
                    legendDiv.innerHTML = `
                         <span class="font-bold text-slate-300">LEGENDA:</span>
                        <span class="flex items-center gap-1"><span class="text-cyan-400 text-sm">üë§</span> Cliente</span>
                        <span class="flex items-center gap-1"><span class="text-amber-500 text-sm">üè≠</span> Produ√ß√£o</span>
                        ${!isUser ? `
                        <span class="flex items-center gap-1"><span class="text-emerald-400 text-sm">üí∞</span> Custos</span>
                        <span class="flex items-center gap-1"><span class="text-rose-500 text-sm">üóëÔ∏è</span> Excluir</span>
                        ` : ''}
                    `;
                    parentDiv.insertBefore(legendDiv, tableContainer);
                } else if (legendDiv) {
                    // Atualiza legenda caso o usu√°rio tenha mudado de role sem refresh (raro mas poss√≠vel)
                    legendDiv.innerHTML = `
                         <span class="font-bold text-slate-300">LEGENDA:</span>
                        <span class="flex items-center gap-1"><span class="text-cyan-400 text-sm">üë§</span> Cliente</span>
                        <span class="flex items-center gap-1"><span class="text-amber-500 text-sm">üè≠</span> Produ√ß√£o</span>
                        ${!isUser ? `
                        <span class="flex items-center gap-1"><span class="text-emerald-400 text-sm">üí∞</span> Custos</span>
                        <span class="flex items-center gap-1"><span class="text-rose-500 text-sm">üóëÔ∏è</span> Excluir</span>
                        ` : ''}
                    `;
                }

                tbody.innerHTML = filtradosRole.map(p => {
                    const dataObj = p.data ? new Date(p.data) : new Date();
                    const dataFmt = isNaN(dataObj.getTime()) ? 'Data Inv√°lida' : dataObj.toLocaleDateString('pt-BR');
                    const temJson = !!p.itens_json;

                    const isUser = currentUser && currentUser.role === ROLES.USER;

                    // Bot√µes individuais. Se n√£o tem JSON, ficam desabilitados.
                    const btnClassBase = "font-bold text-xs border border-current px-2 py-1 rounded transition-colors flex items-center gap-1";

                    const btnCli = temJson
                        ? `<button onclick="regerarPDFUnico('${p.id}', 'cliente')" class="${btnClassBase} text-cyan-400 hover:text-cyan-300 border-cyan-500/30" title="PDF Cliente">üë§</button>`
                        : `<button disabled class="${btnClassBase} text-slate-600 border-slate-700 cursor-not-allowed">üë§</button>`;

                    const btnProd = temJson
                        ? `<button onclick="regerarPDFUnico('${p.id}', 'producao')" class="${btnClassBase} text-amber-500 hover:text-amber-400 border-amber-500/30" title="PDF Produ√ß√£o">üè≠</button>`
                        : `<button disabled class="${btnClassBase} text-slate-600 border-slate-700 cursor-not-allowed">üè≠</button>`;

                    const btnCusto = temJson && !isUser
                        ? `<button onclick="regerarPDFUnico('${p.id}', 'custos')" class="${btnClassBase} text-emerald-400 hover:text-emerald-300 border-emerald-500/30" title="PDF Custos">üí∞</button>`
                        : (isUser ? '' : `<button disabled class="${btnClassBase} text-slate-600 border-slate-700 cursor-not-allowed">üí∞</button>`);

                    const resumoText = p.resumo || p.itens_resumo || 'Sem descri√ß√£o';
                    const totalV = parseFloat(p.totalVenda || p.total || 0);

                    return `
                    <tr class="hover:bg-slate-800/50 border-b border-slate-800">
                        <td class="p-3 text-xs text-slate-400">${dataFmt}</td>
                        <td class="p-3 font-mono text-xs text-slate-300">${p.id}</td>
                        <td class="p-3 font-bold text-slate-200">${p.cliente}</td>
                        <td class="p-3 text-center text-xs text-slate-400 truncate max-w-[150px]" title="${resumoText}">${resumoText}</td>
                        <td class="p-3 text-right font-bold text-emerald-400">R$ ${totalV.toFixed(2)}</td>
                        <td class="p-3 text-center flex items-center justify-center gap-1">
                            ${btnCli}
                            ${btnProd}
                            ${btnCusto}
                            <div class="w-px h-4 bg-slate-700 mx-1"></div>
                            ${!isUser ? `
                            <button onclick="deletarPedido('${p.id}')" class="${btnClassBase} text-rose-500 hover:text-rose-400 border-rose-500/30" title="Excluir Pedido">
                                üóëÔ∏è
                            </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
                }).join('');
            }

            function regerarPDFUnico(pedidoId, tipo) {
                const pedido = dadosPedidos.find(p => p.id === pedidoId);
                if (!pedido || !pedido.itens_json) {
                    mostrarToast('Dados do pedido n√£o encontrados para regerar PDF.', 'red');
                    return;
                }

                let itens = [];
                try {
                    itens = JSON.parse(pedido.itens_json);
                } catch (e) {
                    console.error("Erro parse json", e);
                    mostrarToast('Erro ao ler itens do pedido.', 'red');
                    return;
                }

                const dataObj = new Date(pedido.data);
                const dataHora = isNaN(dataObj.getTime()) ? new Date().toLocaleString('pt-BR') : dataObj.toLocaleString('pt-BR');

                const cliente = pedido.cliente || 'Desconhecido';
                const cnpj = pedido.cnpj || '';
                const numCliente = pedido.telefone || '';
                const ie = pedido.ie || '';
                const endereco = pedido.endereco || '';
                const transp = pedido.obs || 'Retirada Pr√≥pria';

                if (tipo === 'cliente') {
                    gerarPDFCliente(pedido.id, dataHora, cliente, numCliente, cnpj, ie, endereco, transp, itens);
                } else if (tipo === 'producao') {
                    gerarPDFProducao(pedido.id, dataHora, cliente, transp, itens);
                } else if (tipo === 'custos') {
                    gerarPDFCustos(pedido.id, dataHora, itens);
                }
            }

            function regerarPDF(pedidoId) {
                const pedido = dadosPedidos.find(p => p.id === pedidoId);
                if (!pedido || !pedido.itens_json) return;

                let itens = [];
                try {
                    itens = JSON.parse(pedido.itens_json);
                } catch (e) { console.error("Erro parse json", e); return; }

                const dataHora = new Date(pedido.data).toLocaleString('pt-BR');

                // Recupera dados salvos do cliente ou usa redund√¢ncias
                const cliente = pedido.cliente;
                const cnpj = pedido.cnpj || '';
                const numCliente = pedido.telefone || '';
                const ie = pedido.ie || '';
                const endereco = pedido.endereco || '';
                const transp = pedido.obs || 'Retirada Pr√≥pria';

                // Gera os 3 PDFs sequencialmente
                if (confirm('Gerar novamente os 3 PDFs deste pedido?')) {
                    gerarPDFCliente(pedido.id, dataHora, cliente, numCliente, cnpj, ie, endereco, transp, itens);
                    setTimeout(() => gerarPDFProducao(pedido.id, dataHora, cliente, transp, itens), 500);
                    setTimeout(() => gerarPDFCustos(pedido.id, dataHora, itens), 1000);
                }
            }

            // --- SISTEMA DE LOGIN E PERMISS√ïES (RBAC) ---
            const ROLES = {
                GOD: 'GOD',      // Acesso Total
                DONO: 'ADMIN',   // Acesso Total (N√≠vel 2)
                USER: 'USER',    // Vendedor: Pedidos, PDFs, L√™ Estoque, N√£o Altera, N√£o Deleta
                STOCK: 'STOCK'   // Estoquista: Atualiza Estoque, Sem Valores
            };

            // USERS INICIAIS (Se n√£o houver no localStorage)
            const DEFAULT_USERS = {
                'god': { pass: 'qwe123qwe', role: ROLES.GOD, name: 'GOD Mode' },
                'admin': { pass: 'Admin@2024!', role: ROLES.GOD, name: 'Administrador' },
                'dono': { pass: 'Dono@Sucesso#', role: ROLES.DONO, name: 'Propriet√°rio' },
                'vendas': { pass: 'Vendas@123!', role: ROLES.USER, name: 'Vendedor' },
                'estoque': { pass: 'Estoque#999$', role: ROLES.STOCK, name: 'Estoquista' }
            };

            // Carrega users: Come√ßa com os padr√µes, depois o sync atualiza
            let USERS_DB = { ...DEFAULT_USERS };

            let currentUser = null;

            function fazerLogin() {
                const userInput = document.getElementById('loginUser');
                const passInput = document.getElementById('loginPass');
                const errorMsg = document.getElementById('loginError');

                const user = userInput.value.trim().toLowerCase();
                const pass = passInput.value.trim();

                if (USERS_DB[user] && USERS_DB[user].pass === pass) {
                    currentUser = { ...USERS_DB[user], login: user };

                    // Persist√™ncia Mobile
                    localStorage.setItem('alx_logged_user', JSON.stringify(currentUser));

                    const overlay = document.getElementById('loginOverlay');
                    overlay.classList.add('opacity-0', 'pointer-events-none');
                    setTimeout(() => overlay.classList.add('hidden'), 500);

                    mostrarToast(`Bem-vindo, ${currentUser.name}!`, 'emerald');
                    atualizarPermissoesUI();
                } else {
                    errorMsg.classList.remove('hidden');
                    userInput.classList.add('border-rose-500');
                    setTimeout(() => {
                        errorMsg.classList.add('hidden');
                        userInput.classList.remove('border-rose-500');
                    }, 3000);
                }
            }

            function logout() {
                localStorage.removeItem('alx_logged_user');
                currentUser = null;
                location.reload();
            }

            // Checa login ao carregar
            function checkLogin() {
                const saved = localStorage.getItem('alx_logged_user');
                if (saved) {
                    try {
                        currentUser = JSON.parse(saved);
                        const overlay = document.getElementById('loginOverlay');
                        if (overlay) overlay.classList.add('hidden');
                        atualizarPermissoesUI();
                    } catch (e) {
                        localStorage.removeItem('alx_logged_user');
                    }
                }
            }

            function atualizarPermissoesUI() {
                if (!currentUser) return;
                const role = currentUser.role;
                document.body.setAttribute('data-role', role); // √ötil para CSS global

                // RESET: Mostra tudo primeiro
                const allNavs = ['#nav-dashboard', '#nav-estoque', '#nav-categorias', '#nav-movimentacoes', '#nav-operacoes', '#nav-historico-pedidos', '#nav-cadastros', '#nav-pedidos'];
                allNavs.forEach(sel => {
                    const el = document.querySelector(sel);
                    if (el) el.classList.remove('hidden');
                });
                const btnNovo = document.querySelector('button[onclick="abrirModalNovoProduto()"]');
                if (btnNovo) btnNovo.classList.remove('hidden');

                // Esconde aba usu√°rios por padr√£o
                esconder('#nav-usuarios');

                // --- REGRAS POR ROLE ---

                // GOD e DONO
                if (role === ROLES.GOD || role === ROLES.DONO) {
                    const btnUser = document.querySelector('#nav-usuarios');
                    if (btnUser) btnUser.classList.remove('hidden');
                    renderizarTabelaUsuarios();
                }

                // ESTOQUISTA (STOCK)
                if (role === ROLES.STOCK) {
                    esconder('#nav-pedidos');          // N√£o gera pedidos
                    esconder('#nav-historico-pedidos');// N√£o v√™ hist√≥rico de Vendas
                    esconder('#nav-cadastros');        // N√£o precisa de clientes
                    if (btnNovo) btnNovo.classList.add('hidden'); // N√£o cria produtos

                    // For√ßa ir para Dashboard ou Estoque se estiver em aba proibida
                    if (!['dashboard', 'estoque', 'categorias', 'movimentacoes', 'operacoes'].includes(currentTab)) {
                        switchTab('estoque');
                    }
                }

                // VENDEDOR (USER)
                if (role === ROLES.USER) {
                    esconder('#nav-operacoes');     // N√£o faz entrada/sa√≠da manual
                    if (btnNovo) btnNovo.classList.add('hidden'); // N√£o cria produtos

                    // Esconde bot√µes de exporta√ß√£o e limpeza que o USER n√£o deve usar
                    esconder('button[onclick="exportarTabelaPrecos()"]');
                    esconder('button[onclick="limparTudo(\'al\')"]');
                    esconder('button[onclick="limparTudo(\'cu\')"]');
                    esconder('button[onclick="limparTudo(\'pvc\')"]');

                    // For√ßa sair de aba proibida
                    if (currentTab === 'operacoes') switchTab('pedidos');
                }

                // Re-renderizar listas que podem ter bot√µes sens√≠veis
                renderizarHistoricoPedidos();
            }

            function esconder(selector) {
                const el = document.querySelector(selector);
                if (el) el.classList.add('hidden');
            }

            function toggleStatusPanel() {
                const content = document.getElementById('statusContent');
                const arrow = document.getElementById('statusArrow');
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    arrow.classList.add('rotate-180');
                } else {
                    content.classList.add('hidden');
                    arrow.classList.remove('rotate-180');
                }
            }

            // --- SIDEBAR COLLAPSE LOGIC ---
            // --- SIDEBAR COLLAPSE LOGIC ---
            function toggleDesktopSidebar() {
                // S√≥ funciona em desktop (lg e maior)
                if (window.innerWidth < 1024) return;

                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('mainContent');
                const textElements = document.querySelectorAll('.sidebar-text');
                const navButtons = document.querySelectorAll('#sidebar nav button');
                const statusPanelContainer = document.querySelector('#sidebar .mb-6.bg-slate-800');
                const footerStats = document.querySelector('#sidebar .mt-auto');
                const btnLogout = document.getElementById('btnLogout');
                const logoContainer = document.getElementById('logoContainer');

                // Verifica estado atual pela classe de largura
                const isExpanded = sidebar.classList.contains('w-72');

                if (isExpanded) {
                    // COLLAPSE
                    sidebar.classList.remove('w-72');
                    sidebar.classList.add('w-20');

                    mainContent.classList.remove('lg:ml-72');
                    mainContent.classList.add('lg:ml-20');

                    textElements.forEach(el => el.classList.add('hidden'));

                    // Centralizar botoes
                    navButtons.forEach(btn => {
                        btn.classList.remove('px-4', 'justify-start');
                        btn.classList.add('px-0', 'justify-center');
                    });

                    if (logoContainer) {
                        logoContainer.classList.remove('w-full');
                        logoContainer.classList.add('justify-center');
                    }

                    if (statusPanelContainer) statusPanelContainer.classList.add('hidden');
                    if (footerStats) footerStats.classList.add('hidden');

                    if (btnLogout) {
                        btnLogout.querySelector('span:last-child').classList.add('hidden');
                        btnLogout.classList.remove('px-4', 'text-left', 'justify-start');
                        btnLogout.classList.add('justify-center', 'px-0');
                    }

                    const btn = document.getElementById('btnCollapseParams');
                    if (btn) btn.classList.add('hidden');

                    localStorage.setItem('alx_sidebar_collapsed', 'true');
                } else {
                    // EXPAND
                    sidebar.classList.remove('w-20');
                    sidebar.classList.add('w-72');

                    mainContent.classList.remove('lg:ml-20');
                    mainContent.classList.add('lg:ml-72');

                    textElements.forEach(el => el.classList.remove('hidden'));

                    navButtons.forEach(btn => {
                        btn.classList.add('px-4', 'justify-start');
                        btn.classList.remove('px-0', 'justify-center');
                    });

                    if (logoContainer) {
                        logoContainer.classList.add('w-full');
                        logoContainer.classList.remove('justify-center');
                    }

                    if (statusPanelContainer) statusPanelContainer.classList.remove('hidden');
                    if (footerStats) footerStats.classList.remove('hidden');

                    if (btnLogout) {
                        btnLogout.querySelector('span:last-child').classList.remove('hidden');
                        btnLogout.classList.add('px-4', 'text-left', 'justify-start');
                        btnLogout.classList.remove('justify-center', 'px-0');
                    }

                    const btn = document.getElementById('btnCollapseParams');
                    if (btn) {
                        btn.classList.remove('hidden');
                        btn.innerHTML = '<span class="text-xs">‚óÄ</span>';
                    }

                    localStorage.setItem('alx_sidebar_collapsed', 'false');
                }
            }

            // Restaura estado sidebar ao carregar
            document.addEventListener('DOMContentLoaded', () => {
                const collapsed = localStorage.getItem('alx_sidebar_collapsed') === 'true';
                if (collapsed && window.innerWidth >= 1024) {
                    // Estado inicial √© aberto, ent√£o chamamos toggle para fechar
                    // Timeout para garantir que elementos existam
                    setTimeout(() => toggleDesktopSidebar(), 100);
                }
            });

            // --- FUN√á√ïES DE GERENCIAMENTO DE USU√ÅRIOS ---
            function renderizarTabelaUsuarios() {
                const tbody = document.getElementById('tabelaUsuarios');
                if (!tbody) return;
                if (!currentUser) return; // Evita crash se usu√°rio n√£o logou ainda

                tbody.innerHTML = Object.entries(USERS_DB).map(([user, data]) => {
                    const isGod = currentUser.role === ROLES.GOD;
                    const isDono = currentUser.role === ROLES.DONO;

                    // Bot√µes de a√ß√£o baseados no objetivo do usu√°rio:
                    // - GOD altera n√≠vel.
                    // - DONO ou GOD desativa/apaga.
                    const btnEdit = isGod ?
                        `<button onclick="alterarRoleUsuario('${user}')" class="text-blue-400 hover:text-blue-300 text-[10px] font-bold uppercase transition-colors" title="Mudar N√≠vel">N√≠vel</button>` : '';

                    const btnDelete = (isGod || isDono) && user !== (currentUser ? currentUser.login : '') && user !== 'god' ?
                        `<button onclick="excluirUsuario('${user}')" class="text-rose-500 hover:text-rose-400 text-[10px] font-bold uppercase transition-colors" title="Excluir Usu√°rio">Apagar</button>` : '';

                    return `
                        <tr class="hover:bg-slate-700/30 border-b border-slate-700">
                            <td class="p-3 font-mono text-slate-300">${user}</td>
                            <td class="p-3 font-bold text-white">${data.name}</td>
                            <td class="p-3">
                                <span class="px-2 py-1 rounded text-[10px] font-bold ${getRoleBadgeClass(data.role)}">
                                    ${data.role}
                                </span>
                            </td>
                            <td class="p-3 text-center text-xs text-emerald-400">Ativo</td>
                            <td class="p-3 text-center flex items-center justify-center gap-3">
                                ${btnEdit}
                                ${btnDelete}
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            async function excluirUsuario(user) {
                const myLogin = currentUser ? currentUser.login : '';

                if (user === 'god' || user === myLogin) {
                    mostrarToast('N√£o √© poss√≠vel excluir este usu√°rio (ou voc√™ mesmo)!', 'amber');
                    return;
                }

                if (confirm(`Deseja realmente excluir o acesso de ${user} permanentemente da planilha?`)) {
                    try {
                        mostrarToast('Removendo usu√°rio...', 'blue');
                        pararSync();
                        const response = await fetch(CONFIG.webAppUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                            body: JSON.stringify({
                                action: 'delete_user',
                                login: user
                            })
                        });
                        const result = await response.json();
                        if (result.success) {
                            mostrarToast('Usu√°rio removido da planilha!', 'emerald');
                            sincronizar();
                        } else {
                            throw new Error(result.error);
                        }
                    } catch (e) {
                        mostrarToast('Erro ao excluir: ' + e.message, 'red');
                    } finally {
                        iniciarSync();
                    }
                }
            }

            async function alterarRoleUsuario(user) {
                if (currentUser.role !== ROLES.GOD) return;

                const rolesList = Object.keys(ROLES).join(', ');
                const novaRole = prompt(`Digite o novo n√≠vel para ${user} (${rolesList}):`, USERS_DB[user].role);

                if (novaRole && ROLES[novaRole.toUpperCase()]) {
                    try {
                        const roleUpper = novaRole.toUpperCase();
                        mostrarToast('Atualizando n√≠vel na planilha...', 'blue');
                        pararSync();
                        const response = await fetch(CONFIG.webAppUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                            body: JSON.stringify({
                                action: 'update_user_role',
                                login: user,
                                role: roleUpper
                            })
                        });
                        const result = await response.json();
                        if (result.success) {
                            mostrarToast('N√≠vel atualizado na planilha!', 'emerald');
                            sincronizar();
                        } else {
                            throw new Error(result.error);
                        }
                    } catch (e) {
                        mostrarToast('Erro ao atualizar: ' + e.message, 'red');
                    } finally {
                        iniciarSync();
                    }
                } else if (novaRole) {
                    mostrarToast('N√≠vel inv√°lido!', 'red');
                }
            }

            function getRoleBadgeClass(role) {
                switch (role) {
                    case ROLES.GOD: return 'bg-purple-900 text-purple-200 border border-purple-500';
                    case ROLES.DONO: return 'bg-blue-900 text-blue-200 border border-blue-500';
                    case ROLES.USER: return 'bg-emerald-900 text-emerald-200 border border-emerald-500';
                    case ROLES.STOCK: return 'bg-amber-900 text-amber-200 border border-amber-500';
                    default: return 'bg-slate-700 text-slate-300';
                }
            }

            function abrirModalNovoUsuario() {
                // Checa permiss√£o de cria√ß√£o
                if (currentUser.role !== ROLES.GOD && currentUser.role !== ROLES.DONO) {
                    mostrarToast('Acesso negado!', 'red');
                    return;
                }

                // Cria modal dinamicamente se n√£o existir
                let modal = document.getElementById('modalUsuario');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'modalUsuario';
                    modal.className = "fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm";
                    modal.innerHTML = `
    <div class="glass w-full max-w-md p-6 rounded-2xl border border-slate-700 relative animate-scale-in">
        <button onclick="document.getElementById('modalUsuario').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-white">‚úï</button>
        <h3 class="text-xl font-bold text-white mb-1">Novo Usu√°rio</h3>
        <p class="text-xs text-slate-400 mb-6">Cadastre um novo acesso ao sistema.</p>
        
        <div class="space-y-4">
            <div>
                <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1">Nome Completo</label>
                <input type="text" id="newUserName" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-sm focus:border-emerald-500" placeholder="Ex: Jo√£o Silva">
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                     <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1">Usu√°rio (Login)</label>
                     <input type="text" id="newUserLogin" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-sm focus:border-emerald-500">
                </div>
                <div>
                     <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1">N√≠vel de Acesso</label>
                     <select id="newUserRole" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-sm focus:border-emerald-500">
                         <!-- Opcoes din√¢micas -->
                     </select>
                </div>
            </div>

            <div>
                <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1">Senha</label>
                <input type="password" id="newUserPass" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-sm focus:border-emerald-500" placeholder="M√≠nimo 8 chars, letras, n√∫meros...">
            </div>

            <button onclick="salvarNovoUsuario()" class="w-full bg-emerald-600 hover:bg-emerald-500 py-3 rounded-lg font-bold transition-all shadow-lg shadow-emerald-900/20 mt-2">
                Cadastrar Usu√°rio
            </button>
        </div>
    </div>`;
                    document.body.appendChild(modal);
                }

                // Preenche Roles permitidas
                const selRole = document.getElementById('newUserRole');
                selRole.innerHTML = '';

                // GOD pode tudo
                if (currentUser.role === ROLES.GOD) {
                    selRole.innerHTML += `<option value="${ROLES.GOD}">GOD (Acesso Total)</option>`;
                    selRole.innerHTML += `<option value="${ROLES.DONO}">ADMIN / DONO</option>`;
                }

                // DONO pode criar User e Stock
                selRole.innerHTML += `<option value="${ROLES.USER}">VENDEDOR (Operacional)</option>`;
                selRole.innerHTML += `<option value="${ROLES.STOCK}">ESTOQUISTA (Limitado)</option>`;

                document.getElementById('newUserName').value = '';
                document.getElementById('newUserLogin').value = '';
                document.getElementById('newUserPass').value = '';

                modal.classList.remove('hidden');
            }

            async function salvarNovoUsuario() {
                const name = document.getElementById('newUserName').value.trim();
                const user = document.getElementById('newUserLogin').value.trim().toLowerCase();
                const role = document.getElementById('newUserRole').value;
                const pass = document.getElementById('newUserPass').value;

                if (!name || !user || !pass) {
                    mostrarToast('Preencha todos os campos!', 'amber');
                    return;
                }

                if (USERS_DB[user]) {
                    mostrarToast('Usu√°rio j√° existe!', 'red');
                    return;
                }

                // Valida√ß√£o de Senha Forte
                const strongRegex = new RegExp("^(?=.*[a-z])(?=.*[0-9])(?=.*[!@#\\$%\\^&\\*])(?=.{6,})");
                if (!strongRegex.test(pass) && user !== 'god') {
                    mostrarToast('Senha fraca! Use letras, n√∫meros e especiais.', 'red');
                    return;
                }

                try {
                    mostrarToast('Salvando usu√°rio na planilha...', 'blue');
                    pararSync();
                    const response = await fetch(CONFIG.webAppUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'create_user',
                            login: user,
                            pass: pass,
                            role: role,
                            name: name
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        mostrarToast('Usu√°rio criado com sucesso na planilha!', 'emerald');
                        document.getElementById('modalUsuario').classList.add('hidden');
                        sincronizar();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (e) {
                    mostrarToast('Erro ao salvar: ' + e.message, 'red');
                } finally {
                    iniciarSync();
                }
            }

            // --- INICIALIZA√á√ÉO ---
            iniciarSync();
            checkLogin();

            // Minimal Service Worker para PWA (Online Only com Cache de Assets se quiser, aqui apenas para instala√ß√£o)
            if ('serviceWorker' in navigator) {
                const swCode = `
                    self.addEventListener('install', (e) => self.skipWaiting());
                    self.addEventListener('fetch', (e) => e.respondWith(fetch(e.request)));
                `;
                const blob = new Blob([swCode], { type: 'text/javascript' });
                navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(console.error);
            }
        </script>
</body>

</html>
